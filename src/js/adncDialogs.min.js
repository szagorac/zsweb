var zscore=function(t,e,i,n,o,s){"use strict";function r(t){this.message=t,this.name="ZScoreException"}function a(t,e,i,n,o,s,r){this.boxNo=t,this.midX=e,this.midY=i,this.boxWidth=n,this.boxHeight=o,this.boxIdPrefix=s,this.styleConfig=r,this.boxSvgIdPrefix=s+Nt,this.boxes=[],this.isInitialised=!1,this.positiveMinIndex=0,this.positiveMaxIndex=0,this.negativeMinIndex=0,this.negativeMaxIndex=0,this.zeroIndex=null,this.isPlayAudio=!0,this.currentValue=0,this.currentMaxVal=0}function l(t,e,i,n,o,s){this.inactiveStyle=t,this.zeroStyle=e,this.negMinRGB=i,this.negMaxRGB=n,this.posMinRGB=o,this.posMaxRGB=s}function u(t,e,i,n,o,s,r,a){this.id=t,this.svgId=e,this.x=i,this.y=n,this.width=o,this.height=s,this.inactiveStyle=r,this.activeStyle=a}function c(){Pt("onLoad: "),h()}function h(){if(!(t&&e&&i&&n))throw new r("Invalid libraries. Required: zsUtil, zsNet, zsSvg and zsAudio");t.setRunMode(Ut),Pt("init: "),Ot=t.isTouchDevice(),Wt=t.isSafari(navigator),Pt("init: IsTouch Device: "+Ot+" isSafari: "+Wt),Qt.fontCanvas=s.createElement("canvas"),Qt.canvasCtx=Qt.fontCanvas.getContext("2d"),p(),b(),v(),I(),S(),M(),w(),f(),m()}function d(){g()}function f(){t.makeVisible(Xt.thumbUpGroupId),t.makeVisible(Xt.thumbDownGroupId),t.makeVisible(Xt.meterGroupId)}function p(){e.init(Xt.connectionPreference,Xt.appUrlSse,Xt.appUrlWebsockets,Xt.appUrlHttp,J)}function m(){e.getServerState()}function x(){n.initNoise(),n.initPlayer(),t.makeInVisible(Xt.loadingIconId),Pt("onAudioLoaded: completed")}function v(){At(n)?Ct("initAudio: invalid zsAudio lib"):n.init(Ht,x)}function g(){At(n)?Ct("resetAudio: invalid zsAudio lib"):n.reset()}function b(){i.init(),y()}function y(){var e=lt();Tt(e)&&(t.listen("touchend",e,It),t.listen("mouseup",e,yt));var i=ut();Tt(i)&&(t.listen("touchend",i,Mt),t.listen("mouseup",i,St))}function I(){var t=new l(Xt.meterInactiveStyle,Xt.meterZeroStyle,Xt.negativeMinCol,Xt.negativeMaxCol,Xt.positiveMinCol,Xt.positiveMaxCol),e=new a(Xt.meterBoxNo,Xt.centreX,Xt.centreY,Xt.meterBoxWidth,Xt.meterBoxHeight,Xt.meterBoxIdPrefix,t);e.init(),Qt.meter=e}function S(){var e=st();At(e)||(Yt=e,t.listen("resize",o,k),t.listen("orientationchange",o,k),E("Welcome to","<span style='color:blueviolet;'>ZScore</span>","awaiting performance start ...",null,!0))}function M(){var e=Xt.voteTimeoutMs/1e3;Qt.thumbUpTween=gsap.from(t.toCssIdQuery(Xt.thumbUpSymId),{duration:e,scaleY:.5,fill:"green",transformOrigin:"right bottom",paused:!0,ease:"slow(0.9, 0.4, false)",onComplete:A}),Qt.thumbUpTween.progress(1),Qt.thumbDownTween=gsap.from(t.toCssIdQuery(Xt.thumbDownSymId),{duration:e,scaleY:.5,fill:"red",transformOrigin:"left top",paused:!0,ease:"slow(0.9, 0.4, false)",onComplete:T}),Qt.thumbDownTween.progress(1)}function w(){}function A(){t.setElementAttributes(at(),Xt.filterGreenAttrib)}function T(){t.setElementAttributes(ct(),Xt.filterRedAttrib)}function C(t){Qt.currentVote=t;var i={};i[Dt]=t,e.sendEvent(zt,i)}function P(){return Tt(Qt.thumbUpTween)&&Qt.thumbUpTween.isActive()}function U(){return Tt(Qt.thumbDownTween)&&Qt.thumbDownTween.isActive()}function E(t,e,i,n,o){if(!At(Yt)){var s=!1;if(!At(t)){var r=t.trim();Qt.instructions.l1!=r&&(Qt.instructions.l1=r,s=!0)}if(!At(e)){r=e.trim();Qt.instructions.l2!=r&&(Qt.instructions.l2=r,s=!0)}if(!At(i)){r=i.trim();Qt.instructions.l3!=r&&(Qt.instructions.l3=r,s=!0)}At(n)||(Qt.instructions.bckgCol=n),o?s&&Y():j()}}function F(e){At(e)||(t.isNumeric(e)||(e=t.toInt(e)),Qt.voteCount=e)}function N(e){At(e)||(t.isNumeric(e)||(e=t.toInt(e)),Qt.userNo=e)}function k(e){if(!t.isObject(this))return null;Y()}function z(e,i,n){if(t.isArray(i))for(var o=0;o<i.length;o++)D(e,i[o],n);else D(e,i,n)}function D(t,e,i){if(!At(e))switch(Pt("runAudio: "+t+Ft+e),e){case"player":R(t,i)}}function R(e,i){if(t.isString(e))switch(e){case"play":B(i);break;case"volume":G(i);break;case"config":V(i);break;default:return void Ct("runPlayer: Unknown actionId: "+e)}}function V(e){if(At(n))Ct("runAudioPlayGranulator: Invalid zsAudio lib");else if(t.isObject(e)){var i=!1;if(!At(e.audioFiles)){var o=e.audioFiles;t.isArray(o)?t.arrEquals(Ht,o)?Pt("updateAudioPlayerCofig: audioFiles array identical, ignoring update"):(Ht=o,i=!0):Ct("updateAudioPlayerCofig: invalid audioFiles array")}if(!At(e.audioFilesIndexMap)){var s=e.audioFilesIndexMap;!t.isArray(s)||s.length<1?Ct("updateAudioPlayerCofig: invalid fileIndexMap array"):Lt=s}i&&(Pt("updateAudioPlayerCofig: laoding audioFiles"),t.makeVisible(Xt.loadingIconId),n.loadAudioBuffers(Ht))}}function B(e){if(At(n))Ct("runPlayerPlay: Invalid zsAudio lib");else if(t.isObject(e)){var i=0;At(e.index)||(t.isString(e.index)?i=t.toInt(e.index):t.isNumeric(e.index)&&(i=e.index));var o=i;if(i>0&&i<Lt.length){var s=Lt[i];o=t.randomArrayElement(s)}var r=null,a=null,l=null;At(e.startTime)||(r=e.startTime),At(e.offset)||(a=e.offset),At(e.duration)||(l=e.duration),n.playAudio(o,r,a,l)}}function G(e){if(At(n))Ct("setAudioMasterVolume: Invalid zsAudio lib");else if(t.isObject(e)){var i=null,o=null;At(e.level)||(i=e.level),At(e.timeMs)||(o=e.timeMs),n.setPlayerVolume(i,o)}}function H(t){E(t.line1,t.line2,t.line3,t.colour,t.isVisible)}function L(t){Tt(t.count)&&F(t.count),Tt(t.maxCount)&&N(t.maxCount),W()}function O(t){V(t)}function W(){if(!At(Qt.meter)){var t=Qt.userNo;t<=Xt.meterMaxVotes&&(t=Xt.meterMaxVotes),Qt.meter.set(Qt.voteCount,t)}}function Y(e){if(!At(Yt)){Yt.innerHTML=Et;var i=Qt.instructions.l1,n=Xt.textSpanPrefix+"1",o=Qt.instructions.l2,s=Xt.textSpanPrefix+"2",r=Qt.instructions.l3,a=Xt.textSpanPrefix+"3",l=Et;e||(e=Et,t.isEmptyString(i)||(l=X(i,l),i=Q(i,n),e+=i),t.isEmptyString(o)||(Pt("displayInstructions: processing line2 "+o),l=X(o,l),o=Q(o,s),e=t.addSuffixIfNotThere(e,Xt.textLineBreak),e+=o),t.isEmptyString(r)||(Pt("displayInstructions: processing line3 "+r),l=X(r,l),r=Q(r,a),e=t.addSuffixIfNotThere(e,Xt.textLineBreak),e+=r));var u=Xt.textFontSize,c=ft(l,u,Yt);Yt.style.fontSize=Et+c+"px",Yt.style.fontFamily=Xt.textFontFamily,Yt.innerHTML=e;var h=t.getChildElement(Yt,t.toCssIdQuery(n));At(h)||(h.style.opacity=0);var d=t.getChildElement(Yt,t.toCssIdQuery(s));At(d)||(d.style.opacity=0);var f=t.getChildElement(Yt,t.toCssIdQuery(a));if(At(f)||(f.style.opacity=0),Qt.instructions.isVisible=!0,q(Yt,Qt.instructions),Xt.textSpanIsFadeIn){var p=Xt.textSpanFadeTimeSec,m=Xt.textSpanFadeStaggerTimeSec;At(h)||gsap.to(h,{duration:p,autoAlpha:1,ease:"power1.in"}),At(d)||gsap.to(d,{delay:m,duration:p,autoAlpha:1,ease:"power1.in"}),At(f)||gsap.to(f,{delay:2*m,duration:p,autoAlpha:1,ease:"power1.in"})}else At(h)||(h.style.opacity=1),At(d)||(d.style.opacity=1),At(f)||(f.style.opacity=1)}}function Q(e,i){for(;t.contains(e,Bt);)e=t.replace(e,Bt,Gt);return e=t.wrapInSpanElement(e,i),e}function X(e,i){var n=t.removeMarkup(e);return n.length>i.length?n:i}function Z(t){return Xt.textFontType+Ft+t+"px "+Xt.textFontFamily}function j(){At(Yt)||(Yt.innerHTML=Et,Qt.instructions.isVisible=!1,q(Yt,Qt.instructions))}function q(e,i){var n=K(i);At(i.bckgCol)||(n.background=i.bckgCol),t.setElementStyleProperty(e,n)}function J(t,e){At(t)||(e||d(),Tt(t.actions)&&$(t.actions),Tt(t.instructions)&&H(t.instructions),Tt(t.counter)&&L(t.counter),Tt(t.playerConfig)&&O(t.playerConfig))}function K(t){return t.isVisible?Xt.textStyleVisible:Xt.textStyleInvisible}function $(e){var i=null,n=null,o=[],s={};if(t.isArray(e))for(var r=0;r<e.length;r++){var a=e[r];Tt(a.id)&&(i=a.id),Tt(a.actionType)&&(n=a.actionType),Tt(a.elementIds)&&(o=a.elementIds),Tt(a.params)&&(s=a.params),_(i,n,o,s)}}function _(t,e,i,n){if(Pt("doAction: "+t+" actionType: "+e),!At(e)&&!At(i))switch(e){case"AUDIO":z(t,i,n);break;case"STOP":tt(t,i,n);break;default:Ct("doAction: Unknown actionType: "+e)}}function tt(e,i,n){if(t.isArray(i))for(var o=0;o<i.length;o++)et(e,i[o],n);else et(e,i,n)}function et(e,i,n){if(t.isString(e))switch(Pt("stop: actionId: "+e+Ft+i),e){case"stop":it(i,n);break;default:return void Ct("Unknown stop actionId: "+e)}}function it(t,e){if(!At(t))switch(Pt("runStopAction: target: "+t),t){case"all":nt(e);break;case"player":ot(e)}}function nt(t){Pt("runStopAll: "),!At(n)&&n.isReady()&&ot(t)}function ot(t){At(n)?Ct("runAudioStopPlayer: Invalid zsAudio lib"):n.stopPlayer()}function st(){return t.getElement(Xt.instructionTxtElementId)}function rt(){return t.getElement(Xt.meterGroupId)}function at(){return t.getElement(Xt.thumbUpGroupId)}function lt(){return t.getElement(Xt.thumbUpRectId)}function ut(){return t.getElement(Xt.thumbDownRectId)}function ct(){return t.getElement(Xt.thumbDownGroupId)}function ht(){return Qt.thumbUpTween}function dt(){return Qt.thumbDownTween}function ft(t,e,i){var n=1;o.innerWidth||s.documentElement.clientWidth||s.body.clientWidth;var r=o.innerHeight||s.documentElement.clientHeight||s.body.clientHeight,a=(Z(n),i.clientWidth),l=a*Xt.textWidthCompressor,u=r*Xt.textAreaMax;n=mt(t,e,l),n=pt(a,n,u);var c=Xt.textMaxFontSize;return n>c&&(n=c),n}function pt(t,e,i){var n=Z(e),o=e,s=vt(n,t,i);if(s<0)return o;var r=s*Xt.textNumberOfLines,a=i/r;return a<1&&(o*=a),o}function mt(t,e,i){var n=Z(e),o=xt(n,t),s=o.width;if(s<=0||s>i||Math.abs(i-s)<1)return e;var r=i/s,a=e*r;return mt(t,a,i)}function xt(t,e){var i=Qt.fontCanvas,n=Qt.canvasCtx;return n.fillRect(0,0,i.width,i.height),n.textBaseline="top",n.fillStyle=kt,n.font=t,n.measureText(e)}function vt(t,e,i){var n=Qt.fontCanvas,o=Qt.canvasCtx;n.width=e,n.height=i,o.fillRect(0,0,n.width,n.height),o.textBaseline="top",o.fillStyle=kt,o.font=t;var s="gM";o.fillText(s,0,0);for(var r=o.getImageData(0,0,n.width,n.height).data,a=-1,l=-1,u=0;u<n.height;u++)for(var c=0;c<n.width;c++){var h=4*(u*n.width+c);if(0!==r[h]){-1===a&&(a=u);break}if(c===n.width-1&&-1!==a){l=u,u=n.height;break}}var d=(l-a)*Xt.textHeightCompressor;return d}function gt(){Pt("onThumbsUp:"),P()||(t.setElementAttributes(at(),Xt.filterInActiveAttrib),t.playOrRestartTween(ht()),C(Rt))}function bt(){Pt("onThumbsDown:"),U()||(t.setElementAttributes(ct(),Xt.filterInActiveAttrib),t.playOrRestartTween(dt()),C(Vt))}function yt(t){Pt("onMouseUpThumbsUp:"),Ot||gt()}function It(t){Pt("onTouchEndThumbsUp:"),Ot&&gt()}function St(t){Pt("onMouseUpThumbsDown:"),Ot||bt()}function Mt(t){Pt("onTouchEndThumbsDown:"),Ot&&bt()}function wt(e,i){t.setElementAttributes(e,i)}function At(e){return t.isNull(e)}function Tt(e){return t.isNotNull(e)}function Ct(e){t.logError(e)}function Pt(e){t.log(e)}const Ut="DEV",Et="",Ft=" ",Nt="Rect",kt="#FFFFFF",zt="VOTE",Dt="value",Rt=1,Vt=-1,Bt="&#39;",Gt="'";var Ht=["/audio/DialogsPitch1-1.mp3"],Lt=[[0]],Ot=null,Wt=null,Yt=null,Qt={instructions:{isVisible:!1,l1:Et,l2:Et,l3:Et,bckgCol:"rgba(225, 225, 225, 0.85)"},voteCount:0,userNo:10,meter:null,currentVote:null,voteTimeMs:0,thumbUpTween:null,thumbDownTween:null,noteUpTween:null,noteDownTween:null},Xt={connectionPreference:"ws,sse,poll",appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",textSpanPrefix:"is",instructionTxtElementId:"instructionTxt",textLineBreak:"<br/>",textStyleInvisible:{visibility:"hidden"},textStyleVisible:{visibility:"visible"},textFontFamily:"Arial",textFontType:"normal",textFontSize:50,textMaxFontSize:70,textMaxLineLen:30,textHeightCompressor:1.1,textWidthCompressor:.9,textAreaMax:.4,textNumberOfLines:3,textSpanIsFadeIn:!0,textSpanFadeTimeSec:1,textSpanFadeStaggerTimeSec:.5,voteTimeoutMs:5e3,loadingIconId:"loadingIcon",elementGroupSuffix:"Grp",meterGroupId:"meterGrp",thumbUpRectId:"thUpRect",thumbDownRectId:"thDownRect",thumbUpGroupId:"thumbUpGrp",thumbUpPathId:"thumbUpPth",thumbUpSymId:"thumbUpSym",thumbDownGroupId:"thumbDownGrp",thumbDownPathId:"thumbDownPth",thumbDownSymId:"thumbDownSym",meterBoxIdPrefix:"meterBox",meterBoxNo:20,meterMaxVotes:5,meterInactiveStyle:{fill:"none",stroke:"black","stroke-width":"4px"},meterZeroStyle:{fill:"yellow"},thumbsUpActiveStyle:{fill:"green"},thumbsUpInActiveStyle:{fill:"none"},thumbsDownActiveStyle:{fill:"red"},thumbsDownInActiveStyle:{fill:"none"},centreX:450,centreY:800,meterBoxWidth:80,meterBoxHeight:40,negativeMinCol:{r:255,g:165,b:0},negativeMaxCol:{r:255,g:0,b:0},positiveMinCol:{r:255,g:255,b:0},positiveMaxCol:{r:0,g:125,b:0},maxNoiseLevel:.5,audioFadeInMs:1e3,filterGreenAttrib:{filter:"url(#dropshadowgreen)"},filterRedAttrib:{filter:"url(#dropshadowred)"},filterInActiveAttrib:{filter:"none"}};return a.prototype.init=function(){if(!At(this.styleConfig)&&t.isNumeric(this.boxNo)&&t.isNumeric(this.midX)&&t.isNumeric(this.midY)){var e=t.isOddNumber(this.boxNo),i=Math.round(this.boxNo/2);this.positiveMaxIndex=this.boxNo-1,this.positiveMinIndex=i,this.negativeMinIndex=i-1,this.negativeMaxIndex=0,this.zeroIndex=null;var n=this.midY+i*this.boxHeight;e&&(this.negativeMinIndex=i-2,this.zeroIndex=i-1,n=this.midY+this.boxHeight/2+this.zeroIndex*this.boxHeight);for(var o=n,s=this.midX-this.boxWidth/2,r=0;r<this.boxNo;++r){var a=this.boxIdPrefix+r,l=this.boxSvgIdPrefix+r,c=o-this.boxHeight,h=this.getActiveStyle(r),d=new u(a,l,s,c,this.boxWidth,this.boxHeight,this.styleConfig.inactiveStyle,h);this.boxes[r]=d,o=c}this.draw(),this.isInitialised=!0}else Ct("ZScoreMeter.init: invalid inputs")},a.prototype.getActiveStyle=function(e){var i="yellow";if(!At(this.zeroIndex)&&e===this.zeroIndex)return this.styleConfig.zeroStyle;if(e>=this.positiveMinIndex&&e<=this.positiveMaxIndex){var n=0;this.positiveMaxIndex!=this.positiveMinIndex&&(n=(e-this.positiveMinIndex)/(this.positiveMaxIndex-this.positiveMinIndex));var o=t.interpolateRgbColours(this.styleConfig.posMinRGB,this.styleConfig.posMaxRGB,n);At(o)||(i=t.rgbToHex(o.r,o.g,o.b))}else if(e>=this.negativeMaxIndex&&e<=this.negativeMinIndex){n=0;this.negativeMinIndex!=this.negativeMaxIndex&&(n=(this.negativeMinIndex-e)/(this.negativeMinIndex-this.negativeMaxIndex));o=t.interpolateRgbColours(this.styleConfig.negMinRGB,this.styleConfig.negMaxRGB,n);At(o)||(i=t.rgbToHex(o.r,o.g,o.b))}return{fill:i}},a.prototype.clear=function(){for(var t=0;t<this.boxes.length;++t)this.setBoxStyle(t,this.styleConfig.inactiveStyle)},a.prototype.draw=function(){for(var t=0;t<this.boxes.length;++t)this.boxes[t].draw()},a.prototype.setPlayAudio=function(t){this.isPlayAudio=t},a.prototype.set=function(e,i){if(t.isNumeric(e)&&t.isNumeric(i))if(this.clear(),At(this.zeroIndex)||this.activateBox(this.zeroIndex,!0),e>0){i<0&&(i*=-1);var n=1,o=i;o<n&&(o=n),e>o&&(e=o);for(var s=Math.floor(t.mapRange(e,n,o,this.positiveMinIndex,this.positiveMaxIndex)),r=this.positiveMinIndex;r<=s;r++)this.activateBox(r,!0);this.currentValue=e,this.currentMaxVal=o,this.playAudio(e,o)}else{i>0&&(i*=-1);n=-1,o=i;o>n&&(o=n),e<o&&(e=o);for(s=Math.ceil(t.mapRange(e,n,o,this.negativeMinIndex,this.negativeMaxIndex)),r=this.negativeMinIndex;r>=s;r--)this.activateBox(r,!0);this.currentValue=e,this.currentMaxVal=o,this.playAudio(e,o)}},a.prototype.activateBox=function(t,e){var i=this.boxes[t];At(i)||i.setActive(e)},a.prototype.setBoxStyle=function(t,e){var i=this.boxes[t];At(i)||i.setStyle(e)},a.prototype.playAudio=function(e,i){if(this.isPlayAudio){if(0===e)return n.playNoise(0),void n.setPlayerVolume(0,500);if(e>0){n.playNoise(0);var o=t.mapRange(Math.abs(e),0,Math.abs(i),0,1);n.setPlayerVolume(o,Xt.audioFadeInMs)}else{n.setPlayerVolume(0,Xt.audioFadeInMs);o=t.mapRange(Math.abs(e),0,Math.abs(i),0,Xt.maxNoiseLevel);n.playNoise(o)}}},u.prototype.draw=function(){var e=rt();if(!At(e)){var n=i.createSvgRectangle(this.x,this.y,this.width,this.height,this.svgId);wt(n,this.inactiveStyle),t.addChildToParent(e,n)}},u.prototype.setStyle=function(e){var i=t.getElement(this.svgId);At(i)||wt(i,e)},u.prototype.setActive=function(e){var i=t.getElement(this.svgId);At(i)||wt(i,e?this.activeStyle:this.inactiveStyle)},{load:function(){c()},onThumbsDownSelect:function(){bt()},onThumbsUpSelect:function(){gt()}}}(zsUtil,zsNet,zsSvg,zsAudio,window,document);