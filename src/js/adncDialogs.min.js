var zscore=function(t,e,i,n,o,s){"use strict";function r(t){this.message=t,this.name="ZScoreException"}function a(t,e,i,n,o,s,r){this.boxNo=t,this.midX=e,this.midY=i,this.boxWidth=n,this.boxHeight=o,this.boxIdPrefix=s,this.styleConfig=r,this.boxSvgIdPrefix=s+Ct,this.boxes=[],this.isInitialised=!1,this.positiveMinIndex=0,this.positiveMaxIndex=0,this.negativeMinIndex=0,this.negativeMaxIndex=0,this.zeroIndex=null,this.isPlayAudio=!0,this.currentValue=0,this.currentMaxVal=0}function l(t,e,i,n,o,s){this.inactiveStyle=t,this.zeroStyle=e,this.negMinRGB=i,this.negMaxRGB=n,this.posMinRGB=o,this.posMaxRGB=s}function u(t,e,i,n,o,s,r,a){this.id=t,this.svgId=e,this.x=i,this.y=n,this.width=o,this.height=s,this.inactiveStyle=r,this.activeStyle=a}function c(){Mt("onLoad: "),h()}function h(){if(!(t&&e&&i&&n))throw new r("Invalid libraries. Required: zsUtil, zsNet, zsSvg and zsAudio");t.setRunMode(St),Mt("init: "),kt=t.isTouchDevice(),Rt=t.isSafari(navigator),Mt("init: IsTouch Device: "+kt+" isSafari: "+Rt),Ht.fontCanvas=s.createElement("canvas"),Ht.canvasCtx=Ht.fontCanvas.getContext("2d"),f(),g(),p(),b(),I(),v()}function d(){m()}function f(){e.init(Gt.connectionPreference,Gt.appUrlSse,Gt.appUrlWebsockets,Gt.appUrlHttp,Z)}function v(){e.getServerState()}function x(){n.initNoise(),n.initPlayer(),t.makeInVisible(Gt.loadingIconId),Mt("onAudioLoaded: completed")}function p(){yt(n)?It("initAudio: invalid zsAudio lib"):n.init(Bt,x)}function m(){yt(n)?It("resetAudio: invalid zsAudio lib"):n.reset()}function g(){i.init(),y()}function y(){var e=nt();bt(e)&&(t.listen("touchend",e,xt),t.listen("mouseup",e,vt));var i=st();bt(i)&&(t.listen("touchend",i,mt),t.listen("mouseup",i,pt))}function b(){var t=new l(Gt.meterInactiveStyle,Gt.meterZeroStyle,Gt.negativeMinCol,Gt.negativeMaxCol,Gt.positiveMinCol,Gt.positiveMaxCol),e=new a(Gt.meterBoxNo,Gt.centreX,Gt.centreY,Gt.meterBoxWidth,Gt.meterBoxHeight,Gt.meterBoxIdPrefix,t);e.init(),Ht.meter=e}function I(){var e=et();yt(e)||(Dt=e,t.listen("resize",o,F),t.listen("orientationchange",o,F),C("Welcome to","<span style='color:blueviolet;'>ZScore</span>","awaiting performance start ...",null,!0))}function M(e){if(!yt(e)){var i=Gt.voteTimeoutMs/1e3;gsap.from(t.toCssIdQuery(e),{duration:i,scaleY:0,fill:"white",transformOrigin:"right bottom"})}}function S(t){var i=Date.now();if(bt(Ht.currentVote)&&Ht.currentVote===t){var n=Ht.voteTimeMs,o=n+Gt.voteTimeoutMs,s=i-o;if(s<0)return}M(Gt.thumbUpPathId),Ht.currentVote=t,Ht.voteTimeMs=i;var r={};r[Ft]=t,e.sendEvent(Pt,r)}function A(t){var e=ot();yt(e)||gt(e,t?Gt.thumbsUpActiveStyle:Gt.thumbsUpInActiveStyle)}function w(t){var e=rt();yt(e)||gt(e,t?Gt.thumbsDownActiveStyle:Gt.thumbsDownInActiveStyle)}function C(t,e,i,n,o){if(!yt(Dt)){var s=!1;if(!yt(t)){var r=t.trim();Ht.instructions.l1!=r&&(Ht.instructions.l1=r,s=!0)}if(!yt(e)){r=e.trim();Ht.instructions.l2!=r&&(Ht.instructions.l2=r,s=!0)}if(!yt(i)){r=i.trim();Ht.instructions.l3!=r&&(Ht.instructions.l3=r,s=!0)}yt(n)||(Ht.instructions.bckgCol=n),o?s&&G():Y()}}function T(e){yt(e)||(t.isNumeric(e)||(e=t.toInt(e)),Ht.voteCount=e)}function P(e){yt(e)||(t.isNumeric(e)||(e=t.toInt(e)),Ht.userNo=e)}function F(e){if(!t.isObject(this))return null;G()}function N(e,i,n){if(t.isArray(i))for(var o=0;o<i.length;o++)z(e,i[o],n);else z(e,i,n)}function z(t,e,i){if(!yt(e))switch(Mt("runAudio: "+t+wt+e),e){case"player":E(t,i)}}function E(e,i){if(t.isString(e))switch(e){case"play":B(i);break;case"volume":V(i);break;case"config":U(i);break;default:return void It("runPlayer: Unknown actionId: "+e)}}function U(e){if(yt(n))It("runAudioPlayGranulator: Invalid zsAudio lib");else if(t.isObject(e)){var i=!1;if(!yt(e.audioFiles)){var o=e.audioFiles;t.isArray(o)?t.arrEquals(Bt,o)?Mt("updateAudioPlayerCofig: audioFiles array identical, ignoring update"):(Bt=o,i=!0):It("updateAudioPlayerCofig: invalid audioFiles array")}if(!yt(e.audioFilesIndexMap)){var s=e.audioFilesIndexMap;!t.isArray(s)||s.length<1?It("updateAudioPlayerCofig: invalid fileIndexMap array"):Vt=s}i&&(Mt("updateAudioPlayerCofig: laoding audioFiles"),t.makeVisible(Gt.loadingIconId),n.loadAudioBuffers(Bt))}}function B(e){if(yt(n))It("runPlayerPlay: Invalid zsAudio lib");else if(t.isObject(e)){var i=0;yt(e.index)||(t.isString(e.index)?i=t.toInt(e.index):t.isNumeric(e.index)&&(i=e.index));var o=i;if(i>0&&i<Vt.length){var s=Vt[i];o=t.randomArrayElement(s)}var r=null,a=null,l=null;yt(e.startTime)||(r=e.startTime),yt(e.offset)||(a=e.offset),yt(e.duration)||(l=e.duration),n.playAudio(o,r,a,l)}}function V(e){if(yt(n))It("setAudioMasterVolume: Invalid zsAudio lib");else if(t.isObject(e)){var i=null,o=null;yt(e.level)||(i=e.level),yt(e.timeMs)||(o=e.timeMs),n.setPlayerVolume(i,o)}}function k(t){C(t.line1,t.line2,t.line3,t.colour,t.isVisible)}function R(t){bt(t.count)&&T(t.count),bt(t.maxCount)&&P(t.maxCount),H()}function D(t){U(t)}function H(){if(!yt(Ht.meter)){var t=Ht.userNo;t<=Gt.meterMaxVotes&&(t=Gt.meterMaxVotes),Ht.meter.set(Ht.voteCount,t)}}function G(e){if(!yt(Dt)){Dt.innerHTML=At;var i=Ht.instructions.l1,n=Gt.textSpanPrefix+"1",o=Ht.instructions.l2,s=Gt.textSpanPrefix+"2",r=Ht.instructions.l3,a=Gt.textSpanPrefix+"3",l=At;e||(e=At,t.isEmptyString(i)||(l=W(i,l),i=L(i,n),e+=i),t.isEmptyString(o)||(Mt("displayInstructions: processing line2 "+o),l=W(o,l),o=L(o,s),e=t.addSuffixIfNotThere(e,Gt.textLineBreak),e+=o),t.isEmptyString(r)||(Mt("displayInstructions: processing line3 "+r),l=W(r,l),r=L(r,a),e=t.addSuffixIfNotThere(e,Gt.textLineBreak),e+=r));var u=Gt.textFontSize,c=at(l,u,Dt);Dt.style.fontSize=At+c+"px",Dt.style.fontFamily=Gt.textFontFamily,Dt.innerHTML=e;var h=t.getChildElement(Dt,t.toCssIdQuery(n));yt(h)||(h.style.opacity=0);var d=t.getChildElement(Dt,t.toCssIdQuery(s));yt(d)||(d.style.opacity=0);var f=t.getChildElement(Dt,t.toCssIdQuery(a));if(yt(f)||(f.style.opacity=0),Ht.instructions.isVisible=!0,X(Dt,Ht.instructions),Gt.textSpanIsFadeIn){var v=Gt.textSpanFadeTimeSec,x=Gt.textSpanFadeStaggerTimeSec;yt(h)||gsap.to(h,{duration:v,autoAlpha:1,ease:"power1.in"}),yt(d)||gsap.to(d,{delay:x,duration:v,autoAlpha:1,ease:"power1.in"}),yt(f)||gsap.to(f,{delay:2*x,duration:v,autoAlpha:1,ease:"power1.in"})}else yt(h)||(h.style.opacity=1),yt(d)||(d.style.opacity=1),yt(f)||(f.style.opacity=1)}}function L(e,i){for(;t.contains(e,Et);)e=t.replace(e,Et,Ut);return e=t.wrapInSpanElement(e,i),e}function W(e,i){var n=t.removeMarkup(e);return n.length>i.length?n:i}function O(t){return Gt.textFontType+wt+t+"px "+Gt.textFontFamily}function Y(){yt(Dt)||(Dt.innerHTML=At,Ht.instructions.isVisible=!1,X(Dt,Ht.instructions))}function X(e,i){var n=j(i);yt(i.bckgCol)||(n.background=i.bckgCol),t.setElementStyleProperty(e,n)}function Z(t,e){yt(t)||(e||d(),bt(t.actions)&&Q(t.actions),bt(t.instructions)&&k(t.instructions),bt(t.counter)&&R(t.counter),bt(t.playerConfig)&&D(t.playerConfig))}function j(t){return t.isVisible?Gt.textStyleVisible:Gt.textStyleInvisible}function Q(e){var i=null,n=null,o=[],s={};if(t.isArray(e))for(var r=0;r<e.length;r++){var a=e[r];bt(a.id)&&(i=a.id),bt(a.actionType)&&(n=a.actionType),bt(a.elementIds)&&(o=a.elementIds),bt(a.params)&&(s=a.params),q(i,n,o,s)}}function q(t,e,i,n){if(Mt("doAction: "+t+" actionType: "+e),!yt(e)&&!yt(i))switch(e){case"AUDIO":N(t,i,n);break;case"STOP":J(t,i,n);break;default:It("doAction: Unknown actionType: "+e)}}function J(e,i,n){if(t.isArray(i))for(var o=0;o<i.length;o++)K(e,i[o],n);else K(e,i,n)}function K(e,i,n){if(t.isString(e))switch(Mt("stop: actionId: "+e+wt+i),e){case"stop":$(i,n);break;default:return void It("Unknown stop actionId: "+e)}}function $(t,e){if(!yt(t))switch(Mt("runStopAction: target: "+t),t){case"all":_(e);break;case"player":tt(e)}}function _(t){Mt("runStopAll: "),!yt(n)&&n.isReady()&&tt(t)}function tt(t){yt(n)?It("runAudioStopPlayer: Invalid zsAudio lib"):n.stopPlayer()}function et(){return t.getElement(Gt.instructionTxtElementId)}function it(){return t.getElement(Gt.meterGroupId)}function nt(){return t.getElement(Gt.thumbUpRectId)}function ot(){return t.getElement(Gt.thumbUpPathId)}function st(){return t.getElement(Gt.thumbDownRectId)}function rt(){return t.getElement(Gt.thumbDownPathId)}function at(t,e,i){var n=1;o.innerWidth||s.documentElement.clientWidth||s.body.clientWidth;var r=o.innerHeight||s.documentElement.clientHeight||s.body.clientHeight,a=(O(n),i.clientWidth),l=a*Gt.textWidthCompressor,u=r*Gt.textAreaMax;n=ut(t,e,l),n=lt(a,n,u);var c=Gt.textMaxFontSize;return n>c&&(n=c),n}function lt(t,e,i){var n=O(e),o=e,s=ht(n,t,i);if(s<0)return o;var r=s*Gt.textNumberOfLines,a=i/r;return a<1&&(o*=a),o}function ut(t,e,i){var n=O(e),o=ct(n,t),s=o.width;if(s<=0||s>i||Math.abs(i-s)<1)return e;var r=i/s,a=e*r;return ut(t,a,i)}function ct(t,e){var i=Ht.fontCanvas,n=Ht.canvasCtx;return n.fillRect(0,0,i.width,i.height),n.textBaseline="top",n.fillStyle=Tt,n.font=t,n.measureText(e)}function ht(t,e,i){var n=Ht.fontCanvas,o=Ht.canvasCtx;n.width=e,n.height=i,o.fillRect(0,0,n.width,n.height),o.textBaseline="top",o.fillStyle=Tt,o.font=t;var s="gM";o.fillText(s,0,0);for(var r=o.getImageData(0,0,n.width,n.height).data,a=-1,l=-1,u=0;u<n.height;u++)for(var c=0;c<n.width;c++){var h=4*(u*n.width+c);if(0!==r[h]){-1===a&&(a=u);break}if(c===n.width-1&&-1!==a){l=u,u=n.height;break}}var d=(l-a)*Gt.textHeightCompressor;return d}function dt(){Mt("onThumbsUp:"),A(!0),w(!1),S(Nt)}function ft(){Mt("onThumbsDown:"),A(!1),w(!0),S(zt)}function vt(t){Mt("onMouseUpThumbsUp:"),kt||dt()}function xt(t){Mt("onTouchEndThumbsUp:"),kt&&dt()}function pt(t){Mt("onMouseUpThumbsDown:"),kt||ft()}function mt(t){Mt("onTouchEndThumbsDown:"),kt&&ft()}function gt(e,i){t.setElementAttributes(e,i)}function yt(e){return t.isNull(e)}function bt(e){return t.isNotNull(e)}function It(e){t.logError(e)}function Mt(e){t.log(e)}const St="DEV",At="",wt=" ",Ct="Rect",Tt="#FFFFFF",Pt="VOTE",Ft="value",Nt=1,zt=-1,Et="&#39;",Ut="'";var Bt=["/audio/DialogsPitch1-1.mp3"],Vt=[[0]],kt=null,Rt=null,Dt=null,Ht={instructions:{isVisible:!1,l1:At,l2:At,l3:At,bckgCol:"rgba(225, 225, 225, 0.85)"},voteCount:0,userNo:10,meter:null,currentVote:null,voteTimeMs:0},Gt={connectionPreference:"ws,sse,poll",appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",textSpanPrefix:"is",instructionTxtElementId:"instructionTxt",textLineBreak:"<br/>",textStyleInvisible:{visibility:"hidden"},textStyleVisible:{visibility:"visible"},textFontFamily:"Arial",textFontType:"normal",textFontSize:50,textMaxFontSize:70,textMaxLineLen:30,textHeightCompressor:1.1,textWidthCompressor:.9,textAreaMax:.4,textNumberOfLines:3,textSpanIsFadeIn:!0,textSpanFadeTimeSec:1,textSpanFadeStaggerTimeSec:.5,voteTimeoutMs:5e3,loadingIconId:"loadingIcon",elementGroupSuffix:"Grp",meterGroupId:"meterGrp",thumbUpRectId:"thUpRect",thumbDownRectId:"thDownRect",thumbUpGroupId:"thumbUpGrp",thumbUpPathId:"thumbUpPth",thumbDownGroupId:"thumbDownGrp",thumbDownPathId:"thumbDownPth",meterBoxIdPrefix:"meterBox",meterBoxNo:20,meterMaxVotes:5,meterInactiveStyle:{fill:"none",stroke:"black","stroke-width":"4px"},meterZeroStyle:{fill:"yellow"},thumbsUpActiveStyle:{fill:"green"},thumbsUpInActiveStyle:{fill:"none"},thumbsDownActiveStyle:{fill:"red"},thumbsDownInActiveStyle:{fill:"none"},centreX:450,centreY:800,meterBoxWidth:80,meterBoxHeight:40,negativeMinCol:{r:255,g:165,b:0},negativeMaxCol:{r:255,g:0,b:0},positiveMinCol:{r:255,g:255,b:0},positiveMaxCol:{r:0,g:125,b:0},maxNoiseLevel:.5,audioFadeInMs:1e3};return a.prototype.init=function(){if(!yt(this.styleConfig)&&t.isNumeric(this.boxNo)&&t.isNumeric(this.midX)&&t.isNumeric(this.midY)){var e=t.isOddNumber(this.boxNo),i=Math.round(this.boxNo/2);this.positiveMaxIndex=this.boxNo-1,this.positiveMinIndex=i,this.negativeMinIndex=i-1,this.negativeMaxIndex=0,this.zeroIndex=null;var n=this.midY+i*this.boxHeight;e&&(this.negativeMinIndex=i-2,this.zeroIndex=i-1,n=this.midY+this.boxHeight/2+this.zeroIndex*this.boxHeight);for(var o=n,s=this.midX-this.boxWidth/2,r=0;r<this.boxNo;++r){var a=this.boxIdPrefix+r,l=this.boxSvgIdPrefix+r,c=o-this.boxHeight,h=this.getActiveStyle(r),d=new u(a,l,s,c,this.boxWidth,this.boxHeight,this.styleConfig.inactiveStyle,h);this.boxes[r]=d,o=c}this.draw(),this.isInitialised=!0}else It("ZScoreMeter.init: invalid inputs")},a.prototype.getActiveStyle=function(e){var i="yellow";if(!yt(this.zeroIndex)&&e===this.zeroIndex)return this.styleConfig.zeroStyle;if(e>=this.positiveMinIndex&&e<=this.positiveMaxIndex){var n=0;this.positiveMaxIndex!=this.positiveMinIndex&&(n=(e-this.positiveMinIndex)/(this.positiveMaxIndex-this.positiveMinIndex));var o=t.interpolateRgbColours(this.styleConfig.posMinRGB,this.styleConfig.posMaxRGB,n);yt(o)||(i=t.rgbToHex(o.r,o.g,o.b))}else if(e>=this.negativeMaxIndex&&e<=this.negativeMinIndex){n=0;this.negativeMinIndex!=this.negativeMaxIndex&&(n=(this.negativeMinIndex-e)/(this.negativeMinIndex-this.negativeMaxIndex));o=t.interpolateRgbColours(this.styleConfig.negMinRGB,this.styleConfig.negMaxRGB,n);yt(o)||(i=t.rgbToHex(o.r,o.g,o.b))}return{fill:i}},a.prototype.clear=function(){for(var t=0;t<this.boxes.length;++t)this.setBoxStyle(t,this.styleConfig.inactiveStyle)},a.prototype.draw=function(){for(var t=0;t<this.boxes.length;++t)this.boxes[t].draw()},a.prototype.setPlayAudio=function(t){this.isPlayAudio=t},a.prototype.set=function(e,i){if(t.isNumeric(e)&&t.isNumeric(i))if(this.clear(),yt(this.zeroIndex)||this.activateBox(this.zeroIndex,!0),e>0){i<0&&(i*=-1);var n=1,o=i;o<n&&(o=n),e>o&&(e=o);for(var s=Math.floor(t.mapRange(e,n,o,this.positiveMinIndex,this.positiveMaxIndex)),r=this.positiveMinIndex;r<=s;r++)this.activateBox(r,!0);this.currentValue=e,this.currentMaxVal=o,this.playAudio(e,o)}else{i>0&&(i*=-1);n=-1,o=i;o>n&&(o=n),e<o&&(e=o);for(s=Math.ceil(t.mapRange(e,n,o,this.negativeMinIndex,this.negativeMaxIndex)),r=this.negativeMinIndex;r>=s;r--)this.activateBox(r,!0);this.currentValue=e,this.currentMaxVal=o,this.playAudio(e,o)}},a.prototype.activateBox=function(t,e){var i=this.boxes[t];yt(i)||i.setActive(e)},a.prototype.setBoxStyle=function(t,e){var i=this.boxes[t];yt(i)||i.setStyle(e)},a.prototype.playAudio=function(e,i){if(this.isPlayAudio){if(0===e)return n.playNoise(0),void n.setPlayerVolume(0,500);if(e>0){n.playNoise(0);var o=t.mapRange(Math.abs(e),0,Math.abs(i),0,1);n.setPlayerVolume(o,Gt.audioFadeInMs)}else{n.setPlayerVolume(0,Gt.audioFadeInMs);o=t.mapRange(Math.abs(e),0,Math.abs(i),0,Gt.maxNoiseLevel);n.playNoise(o)}}},u.prototype.draw=function(){var e=it();if(!yt(e)){var n=i.createSvgRectangle(this.x,this.y,this.width,this.height,this.svgId);gt(n,this.inactiveStyle),t.addChildToParent(e,n)}},u.prototype.setStyle=function(e){var i=t.getElement(this.svgId);yt(i)||gt(i,e)},u.prototype.setActive=function(e){var i=t.getElement(this.svgId);yt(i)||gt(i,e?this.activeStyle:this.inactiveStyle)},{load:function(){c()},onThumbsDownSelect:function(){ft()},onThumbsUpSelect:function(){dt()}}}(zsUtil,zsNet,zsSvg,zsAudio,window,document);