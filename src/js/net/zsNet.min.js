var zsNet=function(e,n){"use strict";function t(e){this.message=e,this.name="ZsNetException"}function i(e,n,t){this.name=e,this.isSupported=n,this.isUsing=t}function s(s,o,u,l,d,p){if(!e)throw new t("Invalid libraries. Required: zsUtil");if(!e.isString(l))return w("_init: Invalid http url: "+l),void!1;if(O(p)||!e.isFunction(p))return w("_init: Invalid HTTP STATE callback function"),void!1;F=l,V=e.createQueue(),Y=p;var f=!!n.EventSource,v="WebSocket"in n||"MozWebSocket"in n;ce[J]=new i(J,v,!1),ce[z]=new i(z,f,!1),ce[K]=new i(K,!0,!1),e.isArray(s)?oe=s:e.isString(s)&&(oe=s.split(x));for(var S=0;S<oe.length;S++){var E=oe[S];if(ce.hasOwnProperty(E)){var g=ce[E];if(g.isSupported){var h=!1;switch(E){case z:h=r(o,g);break;case J:h=a(u,g);break;case K:h=c(g);break;default:w("_init: invalid connection preference: "+E)}if(h){g.isUsing&&(ue=g);break}}else y("_init: connection: "+E+" is not supported")}else w("_init: invalid connection preference: "+E)}if(!h)return w("_init: unable to initialise connection: "),void!1;!0}function r(t,i){if(!n.EventSource)return w("_initSse: SSE is not supported"),!1,!1;if(!e.isString(t))return w("_initSse: Invalid Sse url: "+t),!1,!1;try{$=t,ee=new EventSource($),ee.addEventListener("message",function(n){if(!O(event)&&!O(event.data)){var t=e.parseJson(event.data);b(t,z)}},!1),ee.addEventListener("open",function(e){y("SSE connection open")},!1),ee.addEventListener("error",function(e){e.readyState==EventSource.CLOSED&&y("SSE connection closed")},!1)}catch(n){return e.logException(n,"_initSse: Failed to initialise SSE"),!1,!1}return i.isUsing=!0,y("_initSse: Initialised SSE OK"),!0}function a(t,i){if(!("WebSocket"in n||"MozWebSocket"in n))return w("_initWebsockets: WebSockets are not supported"),!1,!1;if(!e.isString(t))return w("_initWebsockets: Invalid WebSockets url: "+t),!1,!1;try{ne=o(t),te=new WebSocket(ne),te.onmessage=function(n){if(!O(n)&&!O(n.data)){var t=e.parseJson(n.data);b(t,J)}},te.onopen=function(){ie=!0,y("WebSocket connection open")},te.onerror=function(e){y("WebSocket Error "+e)},te.onclose=function(e){ie=!1,y("WebSocket Error "+e)}}catch(n){return e.logException(n,"_initWebsockets: failed to initialise WebSockets"),!1,!1}return i.isUsing=!0,y("_initWebsockets: WebSockets Initialised OK"),!0}function o(t){if(e.contains(t,C)||e.contains(t,X))return t;var i,s=n.location;return i=s.protocol===M?X:C,i+=B+s.host,i+=t,i}function c(n){ae=!0;try{u()}catch(n){return e.logException(n,"Poll: Could not schedule poll state"),!1,!1}return n.isUsing=!0,y("_initSse: Initialised POLL OK"),!0}function u(){var e=Date.now(),n=e+se;e<re?y("Poll already scheduled, skipping poll. now: "+e+" scheduledPoll: "+re):(y("Scheduling next poll at: "+n),setTimeout(function(){l()},se),re=n)}function l(){d(),Date.now()}function d(){var e=p(W);ae&&(e.addParam(T,Q),e.addParam(K,!0)),V.add(e),f()}function p(n){if(e.isString(n))return e.createEvent(n,Date.now());w("_createEvent: invalid event id: "+n)}function f(){if(!(O(V)||V.size()<=0)){for(var n=V.remove(),t=[];e.isNotNull(n);){if(ue.name===J){var i=v(n);i||t.push(n)}else S(n);n=V.remove()}for(var s=0;s<t.length;s++)V.add(t[s]);t.length>0&&setTimeout(function(){f()},se)}}function v(e){if(O(te)||O(e))return w("sendWsEvent: Invalid Websocket or event"),!1;if(!ie)return!1;e.addParam(L,e.id),e.addParam(U,e.time);var n=e.propertyBag;for(var t in n)n.hasOwnProperty(t)&&e.addParam(t,n[t]);var i=new Date;e.addParam(I,i.getTime());var s=JSON.stringify(e);return te.send(s),!0}function S(n){y("sendHttpEvent: "+n.id+" event.time: "+n.time);var t=F;t=e.appendUrlParam(t,L,n.id),t=e.appendUrlParam(t,U,n.time);var i=n.propertyBag;for(var s in i)i.hasOwnProperty(s)&&(t=e.appendUrlParam(t,s,i[s]));g(t,m)}function E(n,t){var i=p(n);if(e.isObject(t))for(var s in t)t.hasOwnProperty(s)&&i.addParam(s,t[s]);V.add(i),f()}function g(n,t){if(O(n))w("ajaxGet: Invalid params");else{var i=new XMLHttpRequest;i.onload=function(e){y("ajaxGet:onload: status: "+i.status),O(t)||t.call(i)},i.onreadystatechange=function(){y("ajaxGet:onreadystatechange: readyState: "+h(i.readyState))};var s=e.uniquify(n);y("ajaxGet: url len: "+s.length+" url: "+s),i.open(N,s,Z),i.setRequestHeader(D,A),i.send()}}function h(e){switch(e){case 0:return"UNSENT";case 1:return"OPENED";case 2:return"HEADERS_RECEIVED";case 3:return"LOADING";case 4:return"DONE";default:return""}}function m(){if(y("handleAjaxGetResponse: "),e.isObjectInstanceOf(XMLHttpRequest,this)){this.responseURL;var n=this.responseText,t=e.parseJson(n);this.status;b(t,K)}}function b(e,n){if(O(e))w("_processResponse: invalid json reponse");else{var t=e.dataBag,i=t.t,s=t.msg,r=t.type,a=!1;if(O(r))w("_processResponse: invalid response type");else{ae&&u();try{switch(r){case j:y("_processResponse: time: "+i+" type: "+r+" source: "+n+" message: "+s),k(s);break;case G:y("_processResponse: time: "+i+" type: "+r+" source: "+n+" message: "+s),R(s);break;case q:a=!0;case H:var o=t.st;y("_processResponse: time: "+i+" type: "+r+" source: "+n),Q=i,_(o,a);break;default:w("Unknown server response type: "+r)}}catch(e){w("_processResponse: failed to process type: "+r+" message: "+s)}}}}function k(e){y("processError: Received ERROR: "+e)}function R(e){y("processOkResponse: Received message: "+e)}function _(n,t){if(!O(n))if(O(Y))w("_processStateResponse: invalid state event callback, can not process server state");else{var i=e.parseJson(n);t&&!O(i.delta)&&(i=i.delta),Y(i,t)}}function w(n){e.logError(n,P)}function y(n){e.log(n,P)}function O(n){return e.isNull(n)}const P="zsNet: ",W="GET_SERVER_STATE",T="lsut",L="ev",U="evt",I="t",N="GET",x=",",D="X-Requested-With",A="XMLHttpRequest",j="ERROR",G="OK",H="STATE",q="STATE_DELTA",z="sse",J="ws",K="poll",M="https:",B="//",C="ws:",X="wss:";var F="/htp",V=null,Q=0,Z=!0,Y=null,$="/sse",ee=null,ne="/wsoc",te=null,ie=!1,se=500,re=0,ae=!1,oe=[],ce={},ue=null;return{SSE:z,WEBSOCKET:J,POLL:K,SSE:z,init:function(e,n,t,i,r,a){s(e,n,t,i,r,a)},useSse:function(e,n){_useSse(e,n)},setHttpUrl:function(n){e.isString(n)&&(F=n)},sendEvent:function(e,n){E(e,n)},getServerState:function(){d()}}}(zsUtil,window);