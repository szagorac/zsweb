var zsNet=function(e,n){"use strict";function t(e){this.message=e,this.name="ZsNetException"}function i(e,n,t){this.name=e,this.isSupported=n,this.isUsing=t}function r(r,a,c,u,l,f){if(!e)throw new t("Invalid libraries. Required: zsUtil");if(!e.isString(u))return H("_init: Invalid http url: "+u),void(Te=!1);if(z(l)||!e.isFunction(l))return H("_init: Invalid HTTP STATE callback function"),void(Te=!1);de=u,pe=e.createQueue(),ge=l,Ee=f;var d=!!n.EventSource,p="WebSocket"in n||"MozWebSocket"in n;Le[re]=new i(re,p,!1),Le[ie]=new i(ie,d,!1),Le[oe]=new i(oe,!0,!1),e.isArray(r)?Ue=r:e.isString(r)&&(Ue=r.split(Q));for(var v=0;v<Ue.length;v++){var S=Ue[v];if(Le.hasOwnProperty(S)){var g=Le[S];if(g.isSupported){var E=!1;switch(S){case ie:E=o(a,g);break;case re:E=s(c,g);break;case oe:E=h(g);break;default:H("_init: invalid connection preference: "+S)}if(E){g.isUsing&&(Ce=g);break}}else q("_init: connection: "+S+" is not supported")}else H("_init: invalid connection preference: "+S)}if(!E)return H("_init: unable to initialise connection: "),void(Te=!1);Te=!0}function o(t,i){if(!n.EventSource)return H("_initSse: SSE is not supported"),Te=!1,!1;if(!e.isString(t))return H("_initSse: Invalid Sse url: "+t),Te=!1,!1;try{be=t,he=new EventSource(be),he.addEventListener("message",function(n){if(!z(event)&&!z(event.data)){var t=e.parseJson(event.data);U(t,ie)}},!1),he.addEventListener("open",function(e){D(le,ie)},!1),he.addEventListener("error",function(e){e.readyState==EventSource.CLOSED&&D(fe,ie)},!1)}catch(n){return e.logException(n,"_initSse: Failed to initialise SSE"),Te=!1,!1}return i.isUsing=!0,q("_initSse: Initialised SSE OK"),!0}function s(t,i){if(!("WebSocket"in n||"MozWebSocket"in n))return H("_initWebsockets: WebSockets are not supported"),Te=!1,!1;if(!e.isString(t))return H("_initWebsockets: Invalid WebSockets url: "+t),Te=!1,!1;try{ke=b(t),ye=E(ke)}catch(n){return e.logException(n,"_initWebsockets: failed to initialise WebSockets"),Te=!1,ye=null,_e=!1,!1}return i.isUsing=!0,q("_initWebsockets: WebSockets Initialised OK"),!0}function a(e){switch(z(e)&&(e=l()),e){case re:g();break;case ie:default:H("Unsupported connection type: "+e)}}function c(e){if(!Te)return!1;switch(z(e)&&(e=l()),e){case re:return A();case ie:default:H("_isConnected: Unsupported connection type: "+e)}}function u(e,n){switch(Te||q("_reconnect: net lib not initialised, ignoring call."),z(e)&&(e=l()),e){case re:if(Oe){q("_reconnect: already in reconnect mode, ignoring call.");break}p(n);break;case ie:default:H("_reconnect: Unsupported connection type: "+e)}}function l(){var e=f();return z(e)?(H("_getConnectionType: Can not find active connection"),null):e.name}function f(){var e=Ce;return z(e)&&(e=d()),e}function d(){for(var e in Le)if(Le.hasOwnProperty(e)){var n=Le[e];if(n.isUsing)return n}return null}function p(n){if(q("_reconnectWs: attempting to reconnect Websocket ..."),Te||q("_reconnect: net lib not initialised, ignoring call."),z(ke))H("_reconnectWs: invalid Websocket URL");else if(A())q("_reconnectWs: Websocket connection is open. ignoring reconnect");else try{Oe=!0,G()||(ye=E(ke))}catch(n){return e.logException(n,"_reconnectWs: failed to reconnect WebSocket"),ye=null,_e=!1,!1}finally{n&&v(n)}}function v(e){we++;var n=S();q("_reconnectWs: scheduling reconnect in: "+n+" ms"),setTimeout(function(){p(e)},n)}function S(){var e=me;return we>1&&(e=me*Math.pow(2,we)),e>We&&(e=We),e}function g(e){z(ye)?z(e)||e():(z(e)||(ye.onclose=e),ye.close())}function E(n){if(!_e&&!x()){var t=new WebSocket(n);return t.onmessage=function(n){if(!z(n)&&!z(n.data)){var t=e.parseJson(n.data);U(t,re)}},t.onopen=function(){_e=!0,we=0,Oe=!1,D(le,re)},t.onerror=function(e){D($,re)},t.onclose=function(e){_e=!1,ye=null,D(fe,re)},t}e.log("_connectWs: connection is already opened, ignoring connect call...")}function b(t){if(e.contains(t,ce)||e.contains(t,ue))return t;var i,r=n.location;return i=r.protocol===se?ue:ce,i+=ae+r.host,i+=t,i}function h(n){Ne=!0;try{k()}catch(n){return e.logException(n,"Poll: Could not schedule poll state"),Te=!1,!1}return n.isUsing=!0,q("_initSse: Initialised POLL OK"),!0}function k(){var e=Date.now(),n=e+Re;e<Pe?q("Poll already scheduled, skipping poll. now: "+e+" scheduledPoll: "+Pe):(q("Scheduling next poll at: "+n),setTimeout(function(){y()},Re),Pe=n)}function y(){_(),Date.now()}function _(){var e=m(J);Ne&&(e.addParam(K,ve),e.addParam(oe,!0)),pe.add(e),W()}function m(n){if(e.isString(n))return e.createEvent(n,Date.now());H("_createEvent: invalid event id: "+n)}function W(){if(!(z(pe)||pe.size()<=0)){for(var n=pe.remove(),t=[];e.isNotNull(n);){if(Ce.name===re){var i=w(n);i||t.push(n)}else O(n);n=pe.remove()}for(var r=0;r<t.length;r++)pe.add(t[r]);t.length>0&&setTimeout(function(){W()},Re)}}function w(e){if(z(ye)||z(e))return H("sendWsEvent: Invalid Websocket or event"),!1;if(!_e||I())return H("sendWsEvent: Websocket is not oppened"),D(fe,re),!1;e.addParam(B,e.id),e.addParam(X,e.time);var n=e.propertyBag;for(var t in n)n.hasOwnProperty(t)&&e.addParam(t,n[t]);var i=new Date;e.addParam(F,i.getTime());var r=JSON.stringify(e);return ye.send(r),!0}function O(n){q("sendHttpEvent: "+n.id+" event.time: "+n.time);var t=de;t=e.appendUrlParam(t,B,n.id),t=e.appendUrlParam(t,X,n.time);var i=n.propertyBag;for(var r in i)i.hasOwnProperty(r)&&(t=e.appendUrlParam(t,r,i[r]));P(t,T)}function R(n,t){var i=m(n);if(e.isObject(t))for(var r in t)t.hasOwnProperty(r)&&i.addParam(r,t[r]);pe.add(i),W()}function P(n,t){if(z(n))H("ajaxGet: Invalid params");else{var i=new XMLHttpRequest;i.onload=function(e){q("ajaxGet:onload: status: "+i.status),z(t)||t.call(i)},i.onreadystatechange=function(){q("ajaxGet:onreadystatechange: readyState: "+N(i.readyState))};var r=e.uniquify(n);q("ajaxGet: url len: "+r.length+" url: "+r),i.open(V,r,Se),i.setRequestHeader(Z,Y),i.send()}}function N(e){switch(e){case 0:return"UNSENT";case 1:return"OPENED";case 2:return"HEADERS_RECEIVED";case 3:return"LOADING";case 4:return"DONE";default:return""}}function T(){if(q("handleAjaxGetResponse: "),e.isObjectInstanceOf(XMLHttpRequest,this)){this.responseURL;var n=this.responseText,t=e.parseJson(n);this.status;U(t,oe)}}function U(n,t){if(z(n))H("_processResponse: invalid json reponse");else{var i=n.dataBag,r=i.t,o=i.msg,s=i.type,a=!1;if(z(s))H("_processResponse: invalid response type");else{Ne&&k();try{switch(s){case $:H("_processResponse: time: "+r+" type: "+s+" source: "+t+" message: "+o),L(o);break;case ee:e.logDebug("_processResponse: time: "+r+" type: "+s+" source: "+t+" message: "+o),C(o);break;case te:a=!0;case ne:var c=i.st;e.logDebug("_processResponse: time: "+r+" type: "+s+" source: "+t),ve=r,j(c,a);break;default:H("Unknown server response type: "+s)}}catch(e){H("_processResponse: failed to process type: "+s+" message: "+o)}}}}function L(e){H("processError: Received ERROR: "+e)}function C(n){e.logDebug("processOkResponse: Received message: "+n)}function D(e,n){switch(e){case le:z(Ee)?q(n+" connection open"):Ee(e,n);break;case fe:z(Ee)?q(n+" connection closed"):Ee(e,n);break;case $:z(Ee)?H(n+" connection error"):Ee(e,n);break;default:H("Unknown Connection State: "+e+" for type: "+n)}}function I(){if(z(ye))return!0;var e=ye.readyState;return e===WebSocket.CLOSED||e===WebSocket.CLOSING}function x(){if(z(ye))return!1;var e=ye.readyState;return e===WebSocket.OPEN||e===WebSocket.CONNECTING}function G(){if(z(ye))return!1;var e=ye.readyState;return e===WebSocket.CONNECTING}function A(){if(z(ye))return!1;var e=ye.readyState;return e===WebSocket.OPEN}function j(n,t){if(!z(n))if(z(ge))H("_processStateResponse: invalid state event callback, can not process server state");else{var i=e.parseJson(n);t&&!z(i.delta)&&(i=i.delta),ge(i,t)}}function H(n){e.logError(n,M)}function q(n){e.log(n,M)}function z(n){return e.isNull(n)}const M="zsNet: ",J="GET_SERVER_STATE",K="lsut",B="ev",X="evt",F="t",V="GET",Q=",",Z="X-Requested-With",Y="XMLHttpRequest",$="ERROR",ee="OK",ne="STATE",te="STATE_DELTA",ie="sse",re="ws",oe="poll",se="https:",ae="//",ce="ws:",ue="wss:",le="OPEN",fe="CLOSED";var de="/htp",pe=null,ve=0,Se=!0,ge=null,Ee=null,be="/sse",he=null,ke="/wsoc",ye=null,_e=!1,me=10,We=5e3,we=0,Oe=!1,Re=500,Pe=0,Ne=!1,Te=!1,Ue=[],Le={},Ce=null;return{SSE:ie,WEBSOCKET:re,POLL:oe,OPEN:le,CLOSED:fe,ERROR:$,init:function(e,n,t,i,o,s){r(e,n,t,i,o,s)},useSse:function(e,n){_useSse(e,n)},setHttpUrl:function(n){e.isString(n)&&(de=n)},sendEvent:function(e,n){R(e,n)},getServerState:function(){_()},reconnect:function(e,n){u(e,n)},closeConnection:function(e){a(e)},isConnected:function(e){return c(e)}}}(zsUtil,window);