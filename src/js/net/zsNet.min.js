var zsNet=function(e,n){"use strict";function t(e){this.message=e,this.name="ZsNetException"}function i(e,n,t){this.name=e,this.isSupported=n,this.isUsing=t}function r(r,a,c,u,l,d){if(!e)throw new t("Invalid libraries. Required: zsUtil");if(!e.isString(u))return H("_init: Invalid http url: "+u),void(Ue=!1);if(z(l)||!e.isFunction(l))return H("_init: Invalid HTTP STATE callback function"),void(Ue=!1);e.setRunMode(M),pe=u,ve=e.createQueue(),Ee=l,be=d;var f=!!n.EventSource,p="WebSocket"in n||"MozWebSocket"in n;Ce[oe]=new i(oe,p,!1),Ce[re]=new i(re,f,!1),Ce[se]=new i(se,!0,!1),e.isArray(r)?Le=r:e.isString(r)&&(Le=r.split(Z));for(var v=0;v<Le.length;v++){var S=Le[v];if(Ce.hasOwnProperty(S)){var g=Ce[S];if(g.isSupported){var E=!1;switch(S){case re:E=o(a,g);break;case oe:E=s(c,g);break;case se:E=h(g);break;default:H("_init: invalid connection preference: "+S)}if(E){g.isUsing&&(De=g);break}}else q("_init: connection: "+S+" is not supported")}else H("_init: invalid connection preference: "+S)}if(!E)return H("_init: unable to initialise connection: "),void(Ue=!1);Ue=!0}function o(t,i){if(!n.EventSource)return H("_initSse: SSE is not supported"),Ue=!1,!1;if(!e.isString(t))return H("_initSse: Invalid Sse url: "+t),Ue=!1,!1;try{he=t,ke=new EventSource(he),ke.addEventListener("message",function(n){if(!z(event)&&!z(event.data)){var t=e.parseJson(event.data);U(t,re)}},!1),ke.addEventListener("open",function(e){D(de,re)},!1),ke.addEventListener("error",function(e){e.readyState==EventSource.CLOSED&&D(fe,re)},!1)}catch(n){return e.logException(n,"_initSse: Failed to initialise SSE"),Ue=!1,!1}return i.isUsing=!0,q("_initSse: Initialised SSE OK"),!0}function s(t,i){if(!("WebSocket"in n||"MozWebSocket"in n))return H("_initWebsockets: WebSockets are not supported"),Ue=!1,!1;if(!e.isString(t))return H("_initWebsockets: Invalid WebSockets url: "+t),Ue=!1,!1;try{ye=b(t),_e=E(ye)}catch(n){return e.logException(n,"_initWebsockets: failed to initialise WebSockets"),Ue=!1,_e=null,me=!1,!1}return i.isUsing=!0,q("_initWebsockets: WebSockets Initialised OK"),!0}function a(e){switch(z(e)&&(e=l()),e){case oe:g();break;case re:default:H("Unsupported connection type: "+e)}}function c(e){if(!Ue)return!1;switch(z(e)&&(e=l()),e){case oe:return A();case re:default:H("_isConnected: Unsupported connection type: "+e)}}function u(e,n){switch(Ue||q("_reconnect: net lib not initialised, ignoring call."),z(e)&&(e=l()),e){case oe:if(Re){q("_reconnect: already in reconnect mode, ignoring call.");break}p(n);break;case re:default:H("_reconnect: Unsupported connection type: "+e)}}function l(){var e=d();return z(e)?(H("_getConnectionType: Can not find active connection"),null):e.name}function d(){var e=De;return z(e)&&(e=f()),e}function f(){for(var e in Ce)if(Ce.hasOwnProperty(e)){var n=Ce[e];if(n.isUsing)return n}return null}function p(n){if(q("_reconnectWs: attempting to reconnect Websocket ..."),Ue||q("_reconnect: net lib not initialised, ignoring call."),z(ye))H("_reconnectWs: invalid Websocket URL");else if(A())q("_reconnectWs: Websocket connection is open. ignoring reconnect");else try{Re=!0,G()||(_e=E(ye))}catch(n){return e.logException(n,"_reconnectWs: failed to reconnect WebSocket"),_e=null,me=!1,!1}finally{n&&v(n)}}function v(e){Oe++;var n=S();q("_reconnectWs: scheduling reconnect in: "+n+" ms"),setTimeout(function(){p(e)},n)}function S(){var e=We;return Oe>1&&(e=We*Math.pow(2,Oe)),e>we&&(e=we),e}function g(e){z(_e)?z(e)||e():(z(e)||(_e.onclose=e),_e.close())}function E(n){if(!me&&!x()){var t=new WebSocket(n);return t.onmessage=function(n){if(!z(n)&&!z(n.data)){var t=e.parseJson(n.data);U(t,oe)}},t.onopen=function(){me=!0,Oe=0,Re=!1,D(de,oe)},t.onerror=function(e){D(ee,oe)},t.onclose=function(e){me=!1,_e=null,D(fe,oe)},t}e.log("_connectWs: connection is already opened, ignoring connect call...")}function b(t){if(e.contains(t,ue)||e.contains(t,le))return t;var i,r=n.location;return i=r.protocol===ae?le:ue,i+=ce+r.host,i+=t,i}function h(n){Te=!0;try{k()}catch(n){return e.logException(n,"Poll: Could not schedule poll state"),Ue=!1,!1}return n.isUsing=!0,q("_initSse: Initialised POLL OK"),!0}function k(){var e=Date.now(),n=e+Pe;e<Ne?q("Poll already scheduled, skipping poll. now: "+e+" scheduledPoll: "+Ne):(q("Scheduling next poll at: "+n),setTimeout(function(){y()},Pe),Ne=n)}function y(){_(),Date.now()}function _(){var e=m(K);Te&&(e.addParam(B,Se),e.addParam(se,!0)),ve.add(e),W()}function m(n){if(e.isString(n))return e.createEvent(n,Date.now());H("_createEvent: invalid event id: "+n)}function W(){if(!(z(ve)||ve.size()<=0)){for(var n=ve.remove(),t=[];e.isNotNull(n);){if(De.name===oe){var i=w(n);i||t.push(n)}else O(n);n=ve.remove()}for(var r=0;r<t.length;r++)ve.add(t[r]);t.length>0&&setTimeout(function(){W()},Pe)}}function w(e){if(z(_e)||z(e))return H("sendWsEvent: Invalid Websocket or event"),!1;if(!me||I())return H("sendWsEvent: Websocket is not oppened"),D(fe,oe),!1;e.addParam(X,e.id),e.addParam(F,e.time);var n=e.propertyBag;for(var t in n)n.hasOwnProperty(t)&&e.addParam(t,n[t]);var i=new Date;e.addParam(V,i.getTime());var r=JSON.stringify(e);return _e.send(r),!0}function O(n){q("sendHttpEvent: "+n.id+" event.time: "+n.time);var t=pe;t=e.appendUrlParam(t,X,n.id),t=e.appendUrlParam(t,F,n.time);var i=n.propertyBag;for(var r in i)i.hasOwnProperty(r)&&(t=e.appendUrlParam(t,r,i[r]));P(t,T)}function R(n,t){var i=m(n);if(e.isObject(t))for(var r in t)t.hasOwnProperty(r)&&i.addParam(r,t[r]);ve.add(i),W()}function P(n,t){if(z(n))H("ajaxGet: Invalid params");else{var i=new XMLHttpRequest;i.onload=function(e){q("ajaxGet:onload: status: "+i.status),z(t)||t.call(i)},i.onreadystatechange=function(){q("ajaxGet:onreadystatechange: readyState: "+N(i.readyState))};var r=e.uniquify(n);q("ajaxGet: url len: "+r.length+" url: "+r),i.open(Q,r,ge),i.setRequestHeader(Y,$),i.send()}}function N(e){switch(e){case 0:return"UNSENT";case 1:return"OPENED";case 2:return"HEADERS_RECEIVED";case 3:return"LOADING";case 4:return"DONE";default:return""}}function T(){if(q("handleAjaxGetResponse: "),e.isObjectInstanceOf(XMLHttpRequest,this)){this.responseURL;var n=this.responseText,t=e.parseJson(n);this.status;U(t,se)}}function U(n,t){if(z(n))H("_processResponse: invalid json reponse");else{var i=n.dataBag,r=i.t,o=i.msg,s=i.type,a=!1;if(z(s))H("_processResponse: invalid response type");else{Te&&k();try{switch(s){case ee:H("_processResponse: time: "+r+" type: "+s+" source: "+t+" message: "+o),L(o);break;case ne:e.logDebug("_processResponse: time: "+r+" type: "+s+" source: "+t+" message: "+o),C(o);break;case ie:a=!0;case te:var c=i.st;e.logDebug("_processResponse: time: "+r+" type: "+s+" source: "+t),Se=r,j(c,a);break;default:H("Unknown server response type: "+s)}}catch(e){H("_processResponse: failed to process type: "+s+" message: "+o)}}}}function L(e){H("processError: Received ERROR: "+e)}function C(n){e.logDebug("processOkResponse: Received message: "+n)}function D(e,n){switch(e){case de:z(be)?q(n+" connection open"):be(e,n);break;case fe:z(be)?q(n+" connection closed"):be(e,n);break;case ee:z(be)?H(n+" connection error"):be(e,n);break;default:H("Unknown Connection State: "+e+" for type: "+n)}}function I(){if(z(_e))return!0;var e=_e.readyState;return e===WebSocket.CLOSED||e===WebSocket.CLOSING}function x(){if(z(_e))return!1;var e=_e.readyState;return e===WebSocket.OPEN||e===WebSocket.CONNECTING}function G(){if(z(_e))return!1;var e=_e.readyState;return e===WebSocket.CONNECTING}function A(){if(z(_e))return!1;var e=_e.readyState;return e===WebSocket.OPEN}function j(n,t){if(!z(n))if(z(Ee))H("_processStateResponse: invalid state event callback, can not process server state");else{var i=e.parseJson(n);t&&!z(i.delta)&&(i=i.delta),Ee(i,t)}}function H(n){e.logError(n,J)}function q(n){e.log(n,J)}function z(n){return e.isNull(n)}const M="debug",J="zsNet: ",K="GET_SERVER_STATE",B="lsut",X="ev",F="evt",V="t",Q="GET",Z=",",Y="X-Requested-With",$="XMLHttpRequest",ee="ERROR",ne="OK",te="STATE",ie="STATE_DELTA",re="sse",oe="ws",se="poll",ae="https:",ce="//",ue="ws:",le="wss:",de="OPEN",fe="CLOSED";var pe="/htp",ve=null,Se=0,ge=!0,Ee=null,be=null,he="/sse",ke=null,ye="/wsoc",_e=null,me=!1,We=10,we=5e3,Oe=0,Re=!1,Pe=500,Ne=0,Te=!1,Ue=!1,Le=[],Ce={},De=null;return{SSE:re,WEBSOCKET:oe,POLL:se,OPEN:de,CLOSED:fe,ERROR:ee,init:function(e,n,t,i,o,s){r(e,n,t,i,o,s)},useSse:function(e,n){_useSse(e,n)},setHttpUrl:function(n){e.isString(n)&&(pe=n)},sendEvent:function(e,n){R(e,n)},getServerState:function(){_()},reconnect:function(e,n){u(e,n)},closeConnection:function(e){a(e)},isConnected:function(e){return c(e)}}}(zsUtil,window);