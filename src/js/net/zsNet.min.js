var zsNet=function(e,n){"use strict";function t(e){this.message=e,this.name="ZsNetException"}function i(e,n,t){this.name=e,this.isSupported=n,this.isUsing=t}function r(r,a,c,u,l,f){if(!e)throw new t("Invalid libraries. Required: zsUtil");if(!e.isString(u))return D("_init: Invalid http url: "+u),void!1;if(G(l)||!e.isFunction(l))return D("_init: Invalid HTTP STATE callback function"),void!1;ae=u,ce=e.createQueue(),fe=l,de=f;var d=!!n.EventSource,p="WebSocket"in n||"MozWebSocket"in n;ye[$]=new i($,p,!1),ye[Y]=new i(Y,d,!1),ye[ee]=new i(ee,!0,!1),e.isArray(r)?me=r:e.isString(r)&&(me=r.split(M));for(var v=0;v<me.length;v++){var S=me[v];if(ye.hasOwnProperty(S)){var g=ye[S];if(g.isSupported){var h=!1;switch(S){case Y:h=o(a,g);break;case $:h=s(c,g);break;case ee:h=E(g);break;default:D("_init: invalid connection preference: "+S)}if(h){g.isUsing&&(_e=g);break}}else x("_init: connection: "+S+" is not supported")}else D("_init: invalid connection preference: "+S)}if(!h)return D("_init: unable to initialise connection: "),void!1;!0}function o(t,i){if(!n.EventSource)return D("_initSse: SSE is not supported"),!1,!1;if(!e.isString(t))return D("_initSse: Invalid Sse url: "+t),!1,!1;try{pe=t,ve=new EventSource(pe),ve.addEventListener("message",function(n){if(!G(event)&&!G(event.data)){var t=e.parseJson(event.data);P(t,Y)}},!1),ve.addEventListener("open",function(e){N(oe,Y)},!1),ve.addEventListener("error",function(e){e.readyState==EventSource.CLOSED&&N(se,Y)},!1)}catch(n){return e.logException(n,"_initSse: Failed to initialise SSE"),!1,!1}return i.isUsing=!0,x("_initSse: Initialised SSE OK"),!0}function s(t,i){if(!("WebSocket"in n||"MozWebSocket"in n))return D("_initWebsockets: WebSockets are not supported"),!1,!1;if(!e.isString(t))return D("_initWebsockets: Invalid WebSockets url: "+t),!1,!1;try{Se=S(t),Ee=v(Se)}catch(n){return e.logException(n,"_initWebsockets: failed to initialise WebSockets"),!1,Ee=null,ge=!1,!1}return i.isUsing=!0,x("_initWebsockets: WebSockets Initialised OK"),!0}function a(e){switch(G(e)&&(e=u()),e){case $:var n=function(){};p(n);break;case Y:default:D("Unsupported connection type: "+e)}}function c(e){switch(G(e)&&(e=u()),e){case $:d();break;case Y:default:D("Unsupported connection type: "+e)}}function u(){var e=l();return G(e)?(D("_getConnectionType: Can not find active connection"),null):e.name}function l(){var e=_e;return G(e)&&(e=f()),e}function f(){for(var e in ye)if(ye.hasOwnProperty(e)){var n=ye[e];if(n.isUsing)return n}return null}function d(){if(x("_reconnectWs: attempting to reconnect Websocket ..."),G(Se))D("_reconnectWs: invalid Websocket URL");else if(I())x("_reconnectWs: Websocket connection is alive. ignoring reconnect");else try{Ee=v(Se)}catch(n){return e.logException(n,"_reconnectWs: failed to reconnect WebSocket"),!1,Ee=null,ge=!1,!1}}function p(e){G(Ee)?G(e)||e():(G(e)||(Ee.onclose=e),Ee.close())}function v(n){if(!ge&&!I()){var t=new WebSocket(n);return t.onmessage=function(n){if(!G(n)&&!G(n.data)){var t=e.parseJson(n.data);P(t,$)}},t.onopen=function(){ge=!0,N(oe,$)},t.onerror=function(e){N(F,$)},t.onclose=function(e){ge=!1,Ee=null,N(se,$)},t}e.log("_connectWs: connection is already opened, ignoring connect call...")}function S(t){if(e.contains(t,ie)||e.contains(t,re))return t;var i,r=n.location;return i=r.protocol===ne?re:ie,i+=te+r.host,i+=t,i}function E(n){ke=!0;try{g()}catch(n){return e.logException(n,"Poll: Could not schedule poll state"),!1,!1}return n.isUsing=!0,x("_initSse: Initialised POLL OK"),!0}function g(){var e=Date.now(),n=e+he;e<be?x("Poll already scheduled, skipping poll. now: "+e+" scheduledPoll: "+be):(x("Scheduling next poll at: "+n),setTimeout(function(){h()},he),be=n)}function h(){b(),Date.now()}function b(){var e=k(j);ke&&(e.addParam(H,ue),e.addParam(ee,!0)),ce.add(e),m()}function k(n){if(e.isString(n))return e.createEvent(n,Date.now());D("_createEvent: invalid event id: "+n)}function m(){if(!(G(ce)||ce.size()<=0)){for(var n=ce.remove(),t=[];e.isNotNull(n);){if(_e.name===$){var i=y(n);i||t.push(n)}else _(n);n=ce.remove()}for(var r=0;r<t.length;r++)ce.add(t[r]);t.length>0&&setTimeout(function(){m()},he)}}function y(e){if(G(Ee)||G(e))return D("sendWsEvent: Invalid Websocket or event"),!1;if(!ge||U())return D("sendWsEvent: Websocket is not oppened"),N(se,$),!1;e.addParam(q,e.id),e.addParam(z,e.time);var n=e.propertyBag;for(var t in n)n.hasOwnProperty(t)&&e.addParam(t,n[t]);var i=new Date;e.addParam(J,i.getTime());var r=JSON.stringify(e);return Ee.send(r),!0}function _(n){x("sendHttpEvent: "+n.id+" event.time: "+n.time);var t=ae;t=e.appendUrlParam(t,q,n.id),t=e.appendUrlParam(t,z,n.time);var i=n.propertyBag;for(var r in i)i.hasOwnProperty(r)&&(t=e.appendUrlParam(t,r,i[r]));O(t,W)}function w(n,t){var i=k(n);if(e.isObject(t))for(var r in t)t.hasOwnProperty(r)&&i.addParam(r,t[r]);ce.add(i),m()}function O(n,t){if(G(n))D("ajaxGet: Invalid params");else{var i=new XMLHttpRequest;i.onload=function(e){x("ajaxGet:onload: status: "+i.status),G(t)||t.call(i)},i.onreadystatechange=function(){x("ajaxGet:onreadystatechange: readyState: "+R(i.readyState))};var r=e.uniquify(n);x("ajaxGet: url len: "+r.length+" url: "+r),i.open(K,r,le),i.setRequestHeader(B,X),i.send()}}function R(e){switch(e){case 0:return"UNSENT";case 1:return"OPENED";case 2:return"HEADERS_RECEIVED";case 3:return"LOADING";case 4:return"DONE";default:return""}}function W(){if(x("handleAjaxGetResponse: "),e.isObjectInstanceOf(XMLHttpRequest,this)){this.responseURL;var n=this.responseText,t=e.parseJson(n);this.status;P(t,ee)}}function P(e,n){if(G(e))D("_processResponse: invalid json reponse");else{var t=e.dataBag,i=t.t,r=t.msg,o=t.type,s=!1;if(G(o))D("_processResponse: invalid response type");else{ke&&g();try{switch(o){case F:x("_processResponse: time: "+i+" type: "+o+" source: "+n+" message: "+r),T(r);break;case V:x("_processResponse: time: "+i+" type: "+o+" source: "+n+" message: "+r),L(r);break;case Z:s=!0;case Q:var a=t.st;x("_processResponse: time: "+i+" type: "+o+" source: "+n),ue=i,C(a,s);break;default:D("Unknown server response type: "+o)}}catch(e){D("_processResponse: failed to process type: "+o+" message: "+r)}}}}function T(e){x("processError: Received ERROR: "+e)}function L(e){x("processOkResponse: Received message: "+e)}function N(e,n){switch(e){case oe:G(de)?x(n+" connection open"):de(e,n);break;case se:G(de)?x(n+" connection closed"):de(e,n);break;case F:G(de)?D(n+" connection error"):de(e,n);break;default:D("Unknown Connection State: "+e+" for type: "+n)}}function U(){if(G(Ee))return!0;var e=Ee.readyState;return e===WebSocket.CLOSED||e===WebSocket.CLOSING}function I(){if(G(Ee))return!1;var e=Ee.readyState;return e===WebSocket.OPEN||e===WebSocket.CONNECTING}function C(n,t){if(!G(n))if(G(fe))D("_processStateResponse: invalid state event callback, can not process server state");else{var i=e.parseJson(n);t&&!G(i.delta)&&(i=i.delta),fe(i,t)}}function D(n){e.logError(n,A)}function x(n){e.log(n,A)}function G(n){return e.isNull(n)}const A="zsNet: ",j="GET_SERVER_STATE",H="lsut",q="ev",z="evt",J="t",K="GET",M=",",B="X-Requested-With",X="XMLHttpRequest",F="ERROR",V="OK",Q="STATE",Z="STATE_DELTA",Y="sse",$="ws",ee="poll",ne="https:",te="//",ie="ws:",re="wss:",oe="OPEN",se="CLOSED";var ae="/htp",ce=null,ue=0,le=!0,fe=null,de=null,pe="/sse",ve=null,Se="/wsoc",Ee=null,ge=!1,he=500,be=0,ke=!1,me=[],ye={},_e=null;return{SSE:Y,WEBSOCKET:$,POLL:ee,OPEN:oe,CLOSED:se,ERROR:F,init:function(e,n,t,i,o,s){r(e,n,t,i,o,s)},useSse:function(e,n){_useSse(e,n)},setHttpUrl:function(n){e.isString(n)&&(ae=n)},sendEvent:function(e,n){w(e,n)},getServerState:function(){b()},reconnect:function(e){c(e)},closeConnection:function(e){a(e)}}}(zsUtil,window);