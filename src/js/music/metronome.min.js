function nextNote(){var e=60/tempo;nextNoteTime+=.25*e,current16thNote++,16==current16thNote&&(current16thNote=0)}function scheduleNote(e,t){if(notesInQueue.push({note:e,time:t}),!(1==noteResolution&&e%2||2==noteResolution&&e%4)){var n=audioContext.createOscillator();n.connect(audioContext.destination),n.frequency.value=e%16==0?880:e%4==0?440:220,n.start(t),n.stop(t+noteLength)}}function scheduler(){for(;nextNoteTime<audioContext.currentTime+scheduleAheadTime;)scheduleNote(current16thNote,nextNoteTime),nextNote()}function play(){if(!unlocked){var e=audioContext.createBuffer(1,1,22050),t=audioContext.createBufferSource();t.buffer=e,t.start(0),unlocked=!0}return isPlaying=!isPlaying,isPlaying?(current16thNote=0,nextNoteTime=audioContext.currentTime,timerWorker.postMessage("start"),"stop"):(timerWorker.postMessage("stop"),"play")}function resetCanvas(e){canvas.width=window.innerWidth,canvas.height=window.innerHeight,window.scrollTo(0,0)}function draw(){for(var e=last16thNoteDrawn,t=audioContext.currentTime;notesInQueue.length&&notesInQueue[0].time<t;)e=notesInQueue[0].note,notesInQueue.splice(0,1);if(last16thNoteDrawn!=e){var n=Math.floor(canvas.width/18);canvasContext.clearRect(0,0,canvas.width,canvas.height);for(var o=0;o<16;o++)canvasContext.fillStyle=e==o?e%4==0?"red":"blue":"black",canvasContext.fillRect(n*(o+1),n,n/2,n/2);last16thNoteDrawn=e}requestAnimFrame(draw)}function init(){var e=document.createElement("div");e.className="container",canvas=document.createElement("canvas"),canvasContext=canvas.getContext("2d"),canvas.width=window.innerWidth,canvas.height=window.innerHeight,document.body.appendChild(e),e.appendChild(canvas),canvasContext.strokeStyle="#ffffff",canvasContext.lineWidth=2,audioContext=new AudioContext,window.onorientationchange=resetCanvas,window.onresize=resetCanvas,requestAnimFrame(draw),timerWorker=new Worker("js/music/metronomeworker.js"),timerWorker.onmessage=function(e){"tick"==e.data?scheduler():console.log("message: "+e.data)},timerWorker.postMessage({interval:lookahead})}var startTime,current16thNote,canvas,canvasContext,audioContext=null,unlocked=!1,isPlaying=!1,tempo=120,lookahead=25,scheduleAheadTime=.1,nextNoteTime=0,noteResolution=0,noteLength=.05,last16thNoteDrawn=-1,notesInQueue=[],timerWorker=null;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},window.addEventListener("load",init);