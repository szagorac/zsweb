var zsGranulator=function(e){"use strict";function n(e){this.message=e,this.name="ZsGranulatorException"}function a(n,a,i,t){this.envelope=n,this.size=a,this.durationSec=e.msecToSec(a),this.position=i,this.playbackRate=t,this.isFinished=!1,this.playStopTolerance=e.msecToSec(Y.audioStopToleranceMs)}function i(){se&&G(!0),te=null,re=null,oe=null,se=!1,ue=!1,le=!1,ce=null,fe=null}function t(){se?k("resetConfig: granulator is playing, ignore reset config"):(k("resetConfig: GRANULATOR"),Y.masterGainVal=1,Y.playDurationSec=30,Y.playStartOffsetSec=0,Y.maxGrains=12,Y.bufferPositionPlayRate=1,Y.audioStopToleranceMs=5,Y.panner.isUsePanner=!1,Y.panner.panningModel="equalpower",Y.panner.distanceModel="linear",Y.panner.maxPanAngle=45,Y.envelope.attackTime=.5,Y.envelope.decayTime=0,Y.envelope.sustainTime=0,Y.envelope.releaseTime=.5,Y.envelope.sustainLevel=1,Y.grain.sizeMs=100,Y.grain.pitchRate=1,Y.grain.maxPositionOffsetRangeMs=0,Y.grain.maxPitchRateRange=0,Y.grain.timeOffsetStepMs=10)}function r(a,t,r){if(!e)throw new n("Invalid libraries. Required: zsUtil");k("Init Granulator"),i(),a&&t?(ne=a,ae=t,Y.isUsePositionOscillator&&(ce=o()),Y.isUseSizeOscillator&&(fe=s()),B(r)&&(r=ne.destination),ie=_(),A(Y.masterGainVal),ie.connect(r),T(!0)):j("initGranulator: invalid context of buffer")}function o(){var n=Y.positionOscillator,a=F(),i=new e.ParamOscillator(J,a,n.minValue,n.maxValue,n.type,n.frequency);if(Y.isUsePositionFrequencyMod){var t=n.frequencyLFO,r=new e.ParamOscillator(K,a,t.minValue,t.maxValue,t.type,t.frequency);i.setFrequencyLFO(r)}if(Y.isUsePositionRangeMod){var o=n.startLFO,s=new e.ParamOscillator(Q,a,o.minValue,o.maxValue,o.type,o.frequency);i.setMinValueLFO(s)}if(Y.isUsePositionRangeMod){o=n.endLFO;var u=new e.ParamOscillator(W,a,o.minValue,o.maxValue,o.type,o.frequency);i.setMaxValueLFO(u)}return i}function s(){var n=Y.sizeOscillator,a=F(),i=new e.ParamOscillator(X,a,n.minValue,n.maxValue,n.type,n.frequency);return i}function u(){ne&&ae?le?se?k("_play: granulator is already playing, ignore"):(k("_play: Playing GRANULATOR"),ue=!1,te=ne.currentTime,re=0,B(ce)||ce.setStartTime(te),B(fe)||fe.setStartTime(te),k("_play: startTime : "+te+" context.state: "+ne.state),se=!0,l()):j("_play: granulator is not ready, will not play"):j("_play: invalid context of buffer")}function l(){if(le){if(!ue){if(O(),ue)return k("processGrains: STOPPING Granulator"),se=!1,te=null,void(re=null);var n=ne.currentTime;re=v(n),c(n);var i=Y.envelope.attackTime,t=Y.envelope.decayTime,r=Y.envelope.sustainLevel,o=Y.envelope.sustainTime,s=Y.envelope.releaseTime,u=g(n),l=Y.grain.pitchRate,f=Y.maxGrains;(B(l)||l<0)&&(l=1);var y=Y.masterGainVal;for(y>pe&&(y=pe),A(y);$.length<f;){var h=d(re),R=p(n),P=m(l);P<0&&(P=l);var S=e.createEnvelope(i,t,r,o,s),T=new a(S,u,h,P);$.push(T),T.play(R)}}}else j("processGrains: granulator is not ready, will not play")}function c(n){if(e.isArray(ee)){for(var a=0;a<ee.length;a++){var i=ee[a];f(i,n)}S()}}function f(n,a){if(e.isObjectInstanceOf(e.RampLinear,n)||e.isObjectInstanceOf(e.RampSin,n)){var i=n.getValue(a);if(B(i)?k("updateConfigValue: action returned invalid value"):e.setNestedObjectValue(Y,n.paramName,i),n.isScheduleReminder){var t=e.secToMsec(n.reminderSec);I(n.paramName,n.startValue,t)}}else j("updateConfigValue: invalid action: ")}function p(n){var a=Y.grain.timeOffsetStepMs,i=Y.grain.sizeMs;B(oe)&&(oe=-1*a);var t=oe+a;t>=i&&(t=0);var r=e.msecToSec(t);return oe=t,n+r}function m(n){var a=Y.grain.maxPitchRateRange;if(B(a)||0===a)return n;var i=a/2,t=n-i,r=n+i;return e.getRandomFromRange(t,r)}function d(n){var a=Y.grain.maxPositionOffsetRangeMs,i=e.msecToSec(a),t=ae.duration,r=i/2,o=n-r,s=n+r;return n<i&&(o=0),n>t-i&&(s=t),e.getRandomFromRange(o,s)}function v(n){if(B(ce))return y(n);var a=ae.duration,i=ce.getValue(n),t=e.msecToSec(i);return t>a&&(t=a),t<0&&(t=0),t}function g(n){var a=Y.grain.sizeMs;if(B(fe))return a;var i=fe.getValue(n),t=a+i,r=e.secToMsec(ae.duration);return t>r?a:t<0?a:t}function y(e){var n=e-te,a=ae.duration,i=Y.bufferPositionPlayRate,t=Y.grain.defaultOffsetSec;if(0!==i&&(t=n*i),t>a){var r=100*t%(100*a)/100;t=r}if(t<0){var o=Math.abs(t),s=(r=100*o%(100*a)/100,Y.grain.sizeMs/1e3);t=a-r-s}return(t<0||t>a)&&(t=0),t}function h(e,n){e&&(e.isFinished=!0,P(),R(n),l())}function R(e){e&&(e.disconnect(),e=null)}function P(){for(var e=[],n=0;n<$.length;n++){var a=$[n];Z(a)&&(a.isFinished||e.push(a))}$=e}function S(){for(var e=[],n=0;n<ee.length;n++){var a=ee[n];Z(a)&&(a.isFinished||e.push(a))}ee=e}function O(){if(!ne||!ae)return ue=!0,void j("validatePlayState: invalid context or buffer, stopping play");var e=ne.currentTime;if(B(te))return ue=!0,void j("validatePlayState: invalid startTime, stopping play");var n=te+Y.playDurationSec;if(e>n)return ue=!0,void k("validatePlayState: stopping granulator, now: "+e+" is greater then allowed playtime: "+n);ue=!1}function T(e){B(e)||(k("setReady: "+e),le=e)}function G(e){B(e)||(k("setStop: "+e),e&&(se=!1),ue=e)}function M(){return le}function V(e){ne?Z(e)?se?k("setAudioBuffer: granulator is playing, can not change the buffer"):ae=e:j("setAudioBuffer: invalid audio buffer"):j("setAudioBuffer: invalid audio context")}function x(n){if(!B(n)){var a=n;e.isString(a)&&(a=e.toFloat(a)),e.isNumeric(a)?pe=a:j("_setMaxGain: Invalid gain level: "+a)}}function A(n,a){if(ne&&ie){e.isString(n)&&(n=e.toFloat(n));var i=Y.masterGainVal;if(e.isNumeric(n)){i=n,i<0?i=0:i>1&&(i=1),i>pe&&(i=pe);var t=Y.masterGainVal,r=ie.gain.value;if(t!==i&&(Y.masterGainVal=i),r!==i)if(!B(a)&&e.isNumeric(a)){var o=e.msecToSec(a),s=F(),u=ne.currentTime+o;k("setMasterGain: "+i+" timeSec: "+o+" actualTime: "+u+" now: "+s),ie.gain.linearRampToValueAtTime(i,u)}else ie.gain.setValueAtTime(i,F())}else j("_setMasterGain: Invalid gain level: "+n)}else j("setMasterGain: invalid context of master gain")}function F(){return B(ne)?0:ne.currentTime}function N(n){B(n)?j("setMaxPlayDuration: Invalid duration: "+n):(e.isString(n)&&(n=e.toFloat(n)),e.isNumeric(n)?(k("setMaxPlayDuration: "+n),Y.playDurationSec=n):j("setMaxPlayDuration: Invalid duration: "+n))}function b(e){if(Z(e)){var n=Y.envelope;for(var a in e)e.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(n[a]=e[a],k("setEnvelopeConf: "+a+": "+e[a]))}else j("setEnvelopeConf: Invalid envelope config")}function I(n,a,i){if(e.isString(n)&&e.isNumeric(a)&&e.isNumeric(i)){for(var t=0;t<ee.length;t++){var r=ee[t];e.isObjectInstanceOf(e.RampLinear,r)&&e.isObjectInstanceOf(e.RampSin,r)&&(r.paramName!==n||r.isFinished||(r.isFinished=!0,k("addRumpLinearAction: action already running for configParamName : "+n+" stopping it...")))}var o=F(),s=e.getNestedObjectValue(Y,n);k("addRampLinearAction: configParamName: "+n+"  rampEndValue: "+a+"  rampDurationMs: "+i+" now: "+o+" currentValue: "+s);var u=e.createRampLinear(n,a,i,o,s);ee.push(u)}else j("addRumpLinearAction: Invalid input parameters: configParamName : "+n+" rampEndValue: "+a+" rampDurationMs: "+i)}function L(n,a,i,t){if(e.isString(n)&&e.isNumeric(a)&&e.isNumeric(i)&&e.isNumeric(t)){for(var r=0;r<ee.length;r++){var o=ee[r];e.isObjectInstanceOf(e.RampLinear,o)&&e.isObjectInstanceOf(e.RampSin,o)&&(o.paramName!==n||o.isFinished||(o.isFinished=!0,k("addRampSinAction: action already running for configParamName : "+n+" stopping it...")))}var s=ne.currentTime,u=e.getNestedObjectValue(Y,n);k("addRampSinAction: configParamName: "+n+"  rampAmplitude: "+a+"  rampFrequency: "+i+"  rampDurationMs: "+t+" now: "+s+" currentValue: "+u);var l=e.createRampSin(n,a,i,t,s,u);ee.push(l)}else j("addRampSinAction: Invalid input parameters: configParamName : "+n+" rampAmplitude: "+a+" rampFrequency: "+i+" rampDurationMs: "+t)}function q(e){Z(e)?ee.push(e):j("addConfigAction: Invalid action")}function w(e){if(Z(e)){var n=Y.grain;for(var a in e)e.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(n[a]=e[a],k("setGrainConf: "+a+": "+e[a]))}else j("setGrainConf: Invalid grain config")}function z(n){e.setConfig(Y,n)}function U(){if(!ae)return j("createBufferAudioSource: invalid audio buffer"),null;if(!ne)return j("createBufferAudioSource: Audio context is not initialised!!"),null;var e=ne.createBufferSource();return e.buffer=ae,e}function D(){if(!ne)return j("createPanner: Audio context is not initialised!!"),null;var e=ne.createPanner(),n=Y.panner;return e.panningModel=n.panningModel,e.distanceModel=n.distanceModel,e}function E(){var n=e.getRandomIntFromRange(1,2);return 1===n}function C(n){if(B(n))j("setRndPan: invalid panner");else{var a=Y.panner,i=a.maxPanAngle,t=e.getRandomIntFromRange(-1*i,i),r=Math.sin(t*(Math.PI/180));k("setRndPan: x: "+r),n.setPosition(r,0,r)}}function _(){if(!ne)return j("createBufferAudioSource: Audio context is not initialised!!"),null;var e=ne.createGain();return e}function j(n){e.logError(n,H)}function k(n){e.log(n,H)}function B(n){return e.isNull(n)}function Z(n){return e.isObject(n)}const H="ZsGranulator: ",J="ZsGranulator_PositionOscillator",K="ZsGranulator_PositionFreqLFO",Q="ZsGranulator_PositionStartLFO",W="ZsGranulator_PositionEndLFO",X="ZsGranulator_SizeOscillator";var Y={masterGainVal:1,playDurationSec:30,playStartOffsetSec:0,maxGrains:16,bufferPositionPlayRate:.5,audioStopToleranceMs:5,isUsePositionOscillator:!0,isUseSizeOscillator:!0,isUsePositionFrequencyMod:!0,isUsePositionRangeMod:!0,panner:{isUsePanner:!1,panningModel:"equalpower",distanceModel:"linear",maxPanAngle:45},envelope:{attackTime:.5,decayTime:0,sustainTime:0,releaseTime:.5,sustainLevel:1},grain:{sizeMs:100,pitchRate:1,maxPositionOffsetRangeMs:100,maxPitchRateRange:.03,timeOffsetStepMs:10},positionOscillator:{minValue:500,maxValue:4500,type:"TRIANGLE",frequency:.2,frequencyLFO:{minValue:-.1,maxValue:0,type:"TRIANGLE",frequency:.02},startLFO:{minValue:-500,maxValue:500,type:"TRIANGLE",frequency:.1},endLFO:{minValue:-500,maxValue:500,type:"TRIANGLE",frequency:.1}},sizeOscillator:{minValue:-30,maxValue:500,type:"TRIANGLE",frequency:.1}},$=[],ee=[],ne=null,ae=null,ie=null,te=null,re=null,oe=null,se=!1,ue=!1,le=!1,ce=null,fe=null,pe=1;return a.prototype.play=function(e){var n=this;if(!ae)return j("Grain.play: Invalid buffer"),void setTimeout(function(){h(n)},this.size);var a=this.validate();if(!a)return j("Grain.play: Invalid grain"),void setTimeout(function(){h(n)},this.size);var i=_();if(!i)return j("Grain.play: Invalid gain"),void setTimeout(function(){h(n)},this.size);var t=U();if(!t)return j("Grain.play: Invalid audioSource"),void setTimeout(function(){h(n)},this.size);B(this.playbackRate)?this.playbackRate=1:t.playbackRate.value=this.playbackRate;var r=null,o=Y.panner.isUsePanner;o&&E()&&(r=D(),C(r)),t.connect(i),B(r)?i.connect(ie):(i.connect(r),r.connect(ie)),this.envelope?this.envelope.applyTo(ae,i,e,this.durationSec):i.gain.setValueAtTime(1,e),t.onended=function(e){h(n,t)},1===this.playbackRate?t.start(e,this.position,this.durationSec):(t.start(e,this.position),t.stop(e+this.durationSec+this.playStopTolerance))},a.prototype.validate=function(){var e=ae.duration;if(B(this.position)||this.position<0||this.position>e)return j("Grain.validate: invalid position: "+position),!1;var n=this.position+this.durationSec;return!(n>e)||(k("Grain.validate: grain Duration: "+n+" greater than buffer Duration: "+e),!1)},{init:function(e,n,a){r(e,n,a)},play:function(){u()},stop:function(){G(!0)},reset:function(){t()},setGain:function(e,n){A(e,n)},setMaxGain:function(e){x(e)},setBuffer:function(e){V(e)},setPlayDuration:function(e){N(e)},setGrainEnvelope:function(e){b(e)},setGrainConfig:function(e){w(e)},setGranulatorConfig:function(e){z(e)},addAction:function(e){q(e)},addRampLinear:function(e,n,a){I(e,n,a)},addRampSin:function(e,n,a,i){L(e,n,a,i)},isReady:function(){return M()},isPlaying:function(){return se}}}(zsUtil);