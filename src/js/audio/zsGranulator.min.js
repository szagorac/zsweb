var zsGranulator=function(e){"use strict";function n(e){this.message=e,this.name="ZsGranulatorException"}function a(n,a,i,t){this.envelope=n,this.size=a,this.durationSec=e.msecToSec(a),this.position=i,this.playbackRate=t,this.isFinished=!1,this.playStopTolerance=e.msecToSec(W.audioStopToleranceMs)}function i(){re?_("resetConfig: granulator is playing, ignore reset config"):(_("resetConfig: GRANULATOR"),W.masterGainVal=1,W.playDurationSec=30,W.playStartOffsetSec=0,W.maxGrains=12,W.bufferPositionPlayRate=1,W.audioStopToleranceMs=5,W.panner.isUsePanner=!1,W.panner.panningModel="equalpower",W.panner.distanceModel="linear",W.panner.maxPanAngle=45,W.envelope.attackTime=.5,W.envelope.decayTime=0,W.envelope.sustainTime=0,W.envelope.releaseTime=.5,W.envelope.sustainLevel=1,W.grain.sizeMs=100,W.grain.pitchRate=1,W.grain.maxPositionOffsetRangeMs=0,W.grain.maxPitchRateRange=0,W.grain.timeOffsetStepMs=10)}function t(a,i,t){if(!e)throw new n("Invalid libraries. Required: zsUtil");if(_("Init Granulator"),!a||!i)return C("initGranulator: invalid context of buffer"),void S(!1);$=a,ee=i,W.isUsePositionOscillator&&(ue=r()),W.isUseSizeOscillator&&(le=o()),j(t)&&(t=$.destination),ne=E(),M(W.masterGainVal),ne.connect(t),S(!0)}function r(){var n=W.positionOscillator,a=x(),i=new e.ParamOscillator(Z,a,n.minValue,n.maxValue,n.type,n.frequency);if(W.isUsePositionFrequencyMod){var t=n.frequencyLFO,r=new e.ParamOscillator(H,a,t.minValue,t.maxValue,t.type,t.frequency);i.setFrequencyLFO(r)}if(W.isUsePositionRangeMod){var o=n.startLFO,s=new e.ParamOscillator(J,a,o.minValue,o.maxValue,o.type,o.frequency);i.setMinValueLFO(s)}if(W.isUsePositionRangeMod){o=n.endLFO;var u=new e.ParamOscillator(K,a,o.minValue,o.maxValue,o.type,o.frequency);i.setMaxValueLFO(u)}return i}function o(){var n=W.sizeOscillator,a=x(),i=new e.ParamOscillator(Q,a,n.minValue,n.maxValue,n.type,n.frequency);return i}function s(){$&&ee?se?re?_("_play: granulator is already playing, ignore"):(_("_play: Playing GRANULATOR"),oe=!1,ae=$.currentTime,ie=0,j(ue)||ue.setStartTime(ae),j(le)||le.setStartTime(ae),_("_play: startTime : "+ae+" context.state: "+$.state),re=!0,u()):C("_play: granulator is not ready, will not play"):C("_play: invalid context of buffer")}function u(){if(se){if(!oe){if(O(),oe)return _("processGrains: STOPPING Granulator"),void(re=!1);var n=$.currentTime;ie=d(n),l(n);var i=W.envelope.attackTime,t=W.envelope.decayTime,r=W.envelope.sustainLevel,o=W.envelope.sustainTime,s=W.envelope.releaseTime,u=v(n),c=W.grain.pitchRate,g=W.maxGrains;for((j(c)||c<0)&&(c=1),M(W.masterGainVal);X.length<g;){var y=m(ie),h=f(n),R=p(c);R<0&&(R=c);var P=e.createEnvelope(i,t,r,o,s),S=new a(P,u,y,R);X.push(S),S.play(h)}}}else C("processGrains: granulator is not ready, will not play")}function l(n){if(e.isArray(Y)){for(var a=0;a<Y.length;a++){var i=Y[a];c(i,n)}P()}}function c(n,a){if(e.isObjectInstanceOf(e.RampLinear,n)||e.isObjectInstanceOf(e.RampSin,n)){var i=n.getValue(a);if(j(i)?_("updateConfigValue: action returned invalid value"):e.setNestedObjectValue(W,n.paramName,i),n.isScheduleReminder){var t=e.secToMsec(n.reminderSec);L(n.paramName,n.startValue,t)}}else C("updateConfigValue: invalid action: ")}function f(n){var a=W.grain.timeOffsetStepMs,i=W.grain.sizeMs;j(te)&&(te=-1*a);var t=te+a;t>=i&&(t=0);var r=e.msecToSec(t);return te=t,n+r}function p(n){var a=W.grain.maxPitchRateRange;if(j(a)||0===a)return n;var i=a/2,t=n-i,r=n+i;return e.getRandomFromRange(t,r)}function m(n){var a=W.grain.maxPositionOffsetRangeMs,i=e.msecToSec(a),t=ee.duration,r=i/2,o=n-r,s=n+r;return n<i&&(o=0),n>t-i&&(s=t),e.getRandomFromRange(o,s)}function d(n){if(j(ue))return g(n);var a=ee.duration,i=ue.getValue(n),t=e.msecToSec(i);return t>a&&(t=a),t<0&&(t=0),t}function v(n){var a=W.grain.sizeMs;if(j(le))return a;var i=le.getValue(n),t=a+i,r=e.secToMsec(ee.duration);return t>r?a:t<0?a:t}function g(e){var n=e-ae,a=ee.duration,i=W.bufferPositionPlayRate,t=W.grain.defaultOffsetSec;if(0!==i&&(t=n*i),t>a){var r=100*t%(100*a)/100;t=r}return(t<0||t>a)&&(t=0),t}function y(e,n){e&&(e.isFinished=!0,R(),h(n),u())}function h(e){e&&(e.disconnect(),e=null)}function R(){for(var e=[],n=0;n<X.length;n++){var a=X[n];k(a)&&(a.isFinished||e.push(a))}X=e}function P(){for(var e=[],n=0;n<Y.length;n++){var a=Y[n];k(a)&&(a.isFinished||e.push(a))}Y=e}function O(){if(!$||!ee)return oe=!0,void C("validatePlayState: invalid context or buffer, stopping play");var e=$.currentTime;if(j(ae))return oe=!0,void C("validatePlayState: invalid startTime, stopping play");var n=ae+W.playDurationSec;if(e>n)return oe=!0,void _("validatePlayState: stopping granulator, now: "+e+" is greater then allowed playtime: "+n);oe=!1}function S(e){j(e)||(_("setReady: "+e),se=e)}function T(e){j(e)||(_("setStop: "+e),e&&(re=!1),oe=e)}function G(){return se}function V(e){$?k(e)?re?_("setAudioBuffer: granulator is playing, can not change the buffer"):ee=e:C("setAudioBuffer: invalid audio buffer"):C("setAudioBuffer: invalid audio context")}function M(n,a){if($&&ne){e.isString(n)&&(n=e.toFloat(n));var i=W.masterGainVal;if(e.isNumeric(n)){i=n,i<0?i=0:i>1&&(i=1);var t=W.masterGainVal,r=ne.gain.value;if(t!==i&&(W.masterGainVal=i),r!==i)if(!j(a)&&e.isNumeric(a)){var o=e.msecToSec(a),s=x(),u=$.currentTime+o;_("setMasterGain: "+i+" timeSec: "+o+" actualTime: "+u+" now: "+s),ne.gain.linearRampToValueAtTime(i,u)}else ne.gain.setValueAtTime(i,x())}else C("_setMasterGain: Invalid gain level: "+n)}else C("setMasterGain: invalid context of master gain")}function x(){return j($)?0:$.currentTime}function A(n){j(n)?C("setMaxPlayDuration: Invalid duration: "+n):(e.isString(n)&&(n=e.toFloat(n)),e.isNumeric(n)?(_("setMaxPlayDuration: "+n),W.playDurationSec=n):C("setMaxPlayDuration: Invalid duration: "+n))}function F(e){if(k(e)){var n=W.envelope;for(var a in e)e.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(n[a]=e[a],_("setEnvelopeConf: "+a+": "+e[a]))}else C("setEnvelopeConf: Invalid envelope config")}function L(n,a,i){if(e.isString(n)&&e.isNumeric(a)&&e.isNumeric(i)){for(var t=0;t<Y.length;t++){var r=Y[t];e.isObjectInstanceOf(e.RampLinear,r)&&e.isObjectInstanceOf(e.RampSin,r)&&(r.paramName!==n||r.isFinished||(r.isFinished=!0,_("addRumpLinearAction: action already running for configParamName : "+n+" stopping it...")))}var o=x(),s=e.getNestedObjectValue(W,n);_("addRampLinearAction: configParamName: "+n+"  rampEndValue: "+a+"  rampDurationMs: "+i+" now: "+o+" currentValue: "+s);var u=e.createRampLinear(n,a,i,o,s);Y.push(u)}else C("addRumpLinearAction: Invalid input parameters: configParamName : "+n+" rampEndValue: "+a+" rampDurationMs: "+i)}function N(n,a,i,t){if(e.isString(n)&&e.isNumeric(a)&&e.isNumeric(i)&&e.isNumeric(t)){for(var r=0;r<Y.length;r++){var o=Y[r];e.isObjectInstanceOf(e.RampLinear,o)&&e.isObjectInstanceOf(e.RampSin,o)&&(o.paramName!==n||o.isFinished||(o.isFinished=!0,_("addRampSinAction: action already running for configParamName : "+n+" stopping it...")))}var s=$.currentTime,u=e.getNestedObjectValue(W,n);_("addRampSinAction: configParamName: "+n+"  rampAmplitude: "+a+"  rampFrequency: "+i+"  rampDurationMs: "+t+" now: "+s+" currentValue: "+u);var l=e.createRampSin(n,a,i,t,s,u);Y.push(l)}else C("addRampSinAction: Invalid input parameters: configParamName : "+n+" rampAmplitude: "+a+" rampFrequency: "+i+" rampDurationMs: "+t)}function b(e){k(e)?Y.push(e):C("addConfigAction: Invalid action")}function I(e){if(k(e)){var n=W.grain;for(var a in e)e.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(n[a]=e[a],_("setGrainConf: "+a+": "+e[a]))}else C("setGrainConf: Invalid grain config")}function q(n){e.setConfig(W,n)}function w(){if(!ee)return C("createBufferAudioSource: invalid audio buffer"),null;if(!$)return C("createBufferAudioSource: Audio context is not initialised!!"),null;var e=$.createBufferSource();return e.buffer=ee,e}function z(){if(!$)return C("createPanner: Audio context is not initialised!!"),null;var e=$.createPanner(),n=W.panner;return e.panningModel=n.panningModel,e.distanceModel=n.distanceModel,e}function U(){var n=e.getRandomIntFromRange(1,2);return 1===n}function D(n){if(j(n))C("setRndPan: invalid panner");else{var a=W.panner,i=a.maxPanAngle,t=e.getRandomIntFromRange(-1*i,i),r=Math.sin(t*(Math.PI/180));_("setRndPan: x: "+r),n.setPosition(r,0,r)}}function E(){if(!$)return C("createBufferAudioSource: Audio context is not initialised!!"),null;var e=$.createGain();return e}function C(n){e.logError(n,B)}function _(n){e.log(n,B)}function j(n){return e.isNull(n)}function k(n){return e.isObject(n)}const B="ZsGranulator: ",Z="ZsGranulator_PositionOscillator",H="ZsGranulator_PositionFreqLFO",J="ZsGranulator_PositionStartLFO",K="ZsGranulator_PositionEndLFO",Q="ZsGranulator_SizeOscillator";var W={masterGainVal:1,playDurationSec:30,playStartOffsetSec:0,maxGrains:16,bufferPositionPlayRate:.5,audioStopToleranceMs:5,isUsePositionOscillator:!0,isUseSizeOscillator:!0,isUsePositionFrequencyMod:!0,isUsePositionRangeMod:!0,panner:{isUsePanner:!1,panningModel:"equalpower",distanceModel:"linear",maxPanAngle:45},envelope:{attackTime:.5,decayTime:0,sustainTime:0,releaseTime:.5,sustainLevel:1},grain:{sizeMs:100,pitchRate:1,maxPositionOffsetRangeMs:100,maxPitchRateRange:.03,timeOffsetStepMs:10},positionOscillator:{minValue:500,maxValue:4500,type:"TRIANGLE",frequency:.2,frequencyLFO:{minValue:-.1,maxValue:0,type:"TRIANGLE",frequency:.02},startLFO:{minValue:-500,maxValue:500,type:"TRIANGLE",frequency:.1},endLFO:{minValue:-500,maxValue:500,type:"TRIANGLE",frequency:.1}},sizeOscillator:{minValue:-30,maxValue:500,type:"TRIANGLE",frequency:.1}},X=[],Y=[],$=null,ee=null,ne=null,ae=null,ie=null,te=null,re=!1,oe=!1,se=!1,ue=null,le=null;return a.prototype.play=function(e){var n=this;if(!ee)return C("Grain.play: Invalid buffer"),void setTimeout(function(){y(n)},this.size);var a=this.validate();if(!a)return C("Grain.play: Invalid grain"),void setTimeout(function(){y(n)},this.size);var i=E();if(!i)return C("Grain.play: Invalid gain"),void setTimeout(function(){y(n)},this.size);var t=w();if(!t)return C("Grain.play: Invalid audioSource"),void setTimeout(function(){y(n)},this.size);j(this.playbackRate)?this.playbackRate=1:t.playbackRate.value=this.playbackRate;var r=null,o=W.panner.isUsePanner;o&&U()&&(r=z(),D(r)),t.connect(i),j(r)?i.connect(ne):(i.connect(r),r.connect(ne)),this.envelope?this.envelope.applyTo(ee,i,e,this.durationSec):i.gain.setValueAtTime(1,e),t.onended=function(e){y(n,t)},1===this.playbackRate?t.start(e,this.position,this.durationSec):(t.start(e,this.position),t.stop(e+this.durationSec+this.playStopTolerance))},a.prototype.validate=function(){var e=ee.duration;if(j(this.position)||this.position<0||this.position>e)return C("Grain.validate: invalid position: "+position),!1;var n=this.position+this.durationSec;return!(n>e)||(_("Grain.validate: grain Duration: "+n+" greater than buffer Duration: "+e),!1)},{init:function(e,n,a){t(e,n,a)},play:function(){s()},stop:function(){T(!0)},reset:function(){i()},setGain:function(e,n){M(e,n)},setBuffer:function(e){V(e)},setPlayDuration:function(e){A(e)},setGrainEnvelope:function(e){F(e)},setGrainConfig:function(e){I(e)},setGranulatorConfig:function(e){q(e)},addAction:function(e){b(e)},addRampLinear:function(e,n,a){L(e,n,a)},addRampSin:function(e,n,a,i){N(e,n,a,i)},isReady:function(){return G()}}}(zsUtil);