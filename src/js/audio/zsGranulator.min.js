var zsGranulator=function(e){"use strict";function n(e){this.message=e,this.name="ZsGranulatorException"}function a(n,a,i,t){this.envelope=n,this.size=a,this.durationSec=e.msecToSec(a),this.position=i,this.playbackRate=t,this.isFinished=!1,this.playStopTolerance=e.msecToSec(X.audioStopToleranceMs)}function i(){oe?j("resetConfig: granulator is playing, ignore reset config"):(j("resetConfig: GRANULATOR"),X.masterGainVal=1,X.playDurationSec=30,X.playStartOffsetSec=0,X.maxGrains=12,X.bufferPositionPlayRate=1,X.audioStopToleranceMs=5,X.panner.isUsePanner=!1,X.panner.panningModel="equalpower",X.panner.distanceModel="linear",X.panner.maxPanAngle=45,X.envelope.attackTime=.5,X.envelope.decayTime=0,X.envelope.sustainTime=0,X.envelope.releaseTime=.5,X.envelope.sustainLevel=1,X.grain.sizeMs=100,X.grain.pitchRate=1,X.grain.maxPositionOffsetRangeMs=0,X.grain.maxPitchRateRange=0,X.grain.timeOffsetStepMs=10)}function t(a,i,t){if(!e)throw new n("Invalid libraries. Required: zsUtil");if(j("Init Granulator"),!a||!i)return _("initGranulator: invalid context of buffer"),void O(!1);ee=a,ne=i,X.isUsePositionOscillator&&(le=r()),X.isUseSizeOscillator&&(ce=o()),k(t)&&(t=ee.destination),ae=C(),x(X.masterGainVal),ae.connect(t),O(!0)}function r(){var n=X.positionOscillator,a=A(),i=new e.ParamOscillator(H,a,n.minValue,n.maxValue,n.type,n.frequency);if(X.isUsePositionFrequencyMod){var t=n.frequencyLFO,r=new e.ParamOscillator(J,a,t.minValue,t.maxValue,t.type,t.frequency);i.setFrequencyLFO(r)}if(X.isUsePositionRangeMod){var o=n.startLFO,s=new e.ParamOscillator(K,a,o.minValue,o.maxValue,o.type,o.frequency);i.setMinValueLFO(s)}if(X.isUsePositionRangeMod){o=n.endLFO;var u=new e.ParamOscillator(Q,a,o.minValue,o.maxValue,o.type,o.frequency);i.setMaxValueLFO(u)}return i}function o(){var n=X.sizeOscillator,a=A(),i=new e.ParamOscillator(W,a,n.minValue,n.maxValue,n.type,n.frequency);return i}function s(){ee&&ne?ue?oe?j("_play: granulator is already playing, ignore"):(j("_play: Playing GRANULATOR"),se=!1,ie=ee.currentTime,te=0,k(le)||le.setStartTime(ie),k(ce)||ce.setStartTime(ie),j("_play: startTime : "+ie+" context.state: "+ee.state),oe=!0,u()):_("_play: granulator is not ready, will not play"):_("_play: invalid context of buffer")}function u(){if(ue){if(!se){if(S(),se)return j("processGrains: STOPPING Granulator"),void(oe=!1);var n=ee.currentTime;te=d(n),l(n);var i=X.envelope.attackTime,t=X.envelope.decayTime,r=X.envelope.sustainLevel,o=X.envelope.sustainTime,s=X.envelope.releaseTime,u=v(n),c=X.grain.pitchRate,g=X.maxGrains;(k(c)||c<0)&&(c=1);var y=X.masterGainVal;for(y>fe&&(y=fe),x(y);Y.length<g;){var h=m(te),R=f(n),P=p(c);P<0&&(P=c);var O=e.createEnvelope(i,t,r,o,s),T=new a(O,u,h,P);Y.push(T),T.play(R)}}}else _("processGrains: granulator is not ready, will not play")}function l(n){if(e.isArray($)){for(var a=0;a<$.length;a++){var i=$[a];c(i,n)}P()}}function c(n,a){if(e.isObjectInstanceOf(e.RampLinear,n)||e.isObjectInstanceOf(e.RampSin,n)){var i=n.getValue(a);if(k(i)?j("updateConfigValue: action returned invalid value"):e.setNestedObjectValue(X,n.paramName,i),n.isScheduleReminder){var t=e.secToMsec(n.reminderSec);I(n.paramName,n.startValue,t)}}else _("updateConfigValue: invalid action: ")}function f(n){var a=X.grain.timeOffsetStepMs,i=X.grain.sizeMs;k(re)&&(re=-1*a);var t=re+a;t>=i&&(t=0);var r=e.msecToSec(t);return re=t,n+r}function p(n){var a=X.grain.maxPitchRateRange;if(k(a)||0===a)return n;var i=a/2,t=n-i,r=n+i;return e.getRandomFromRange(t,r)}function m(n){var a=X.grain.maxPositionOffsetRangeMs,i=e.msecToSec(a),t=ne.duration,r=i/2,o=n-r,s=n+r;return n<i&&(o=0),n>t-i&&(s=t),e.getRandomFromRange(o,s)}function d(n){if(k(le))return g(n);var a=ne.duration,i=le.getValue(n),t=e.msecToSec(i);return t>a&&(t=a),t<0&&(t=0),t}function v(n){var a=X.grain.sizeMs;if(k(ce))return a;var i=ce.getValue(n),t=a+i,r=e.secToMsec(ne.duration);return t>r?a:t<0?a:t}function g(e){var n=e-ie,a=ne.duration,i=X.bufferPositionPlayRate,t=X.grain.defaultOffsetSec;if(0!==i&&(t=n*i),t>a){var r=100*t%(100*a)/100;t=r}return(t<0||t>a)&&(t=0),t}function y(e,n){e&&(e.isFinished=!0,R(),h(n),u())}function h(e){e&&(e.disconnect(),e=null)}function R(){for(var e=[],n=0;n<Y.length;n++){var a=Y[n];B(a)&&(a.isFinished||e.push(a))}Y=e}function P(){for(var e=[],n=0;n<$.length;n++){var a=$[n];B(a)&&(a.isFinished||e.push(a))}$=e}function S(){if(!ee||!ne)return se=!0,void _("validatePlayState: invalid context or buffer, stopping play");var e=ee.currentTime;if(k(ie))return se=!0,void _("validatePlayState: invalid startTime, stopping play");var n=ie+X.playDurationSec;if(e>n)return se=!0,void j("validatePlayState: stopping granulator, now: "+e+" is greater then allowed playtime: "+n);se=!1}function O(e){k(e)||(j("setReady: "+e),ue=e)}function T(e){k(e)||(j("setStop: "+e),e&&(oe=!1),se=e)}function G(){return ue}function V(e){ee?B(e)?oe?j("setAudioBuffer: granulator is playing, can not change the buffer"):ne=e:_("setAudioBuffer: invalid audio buffer"):_("setAudioBuffer: invalid audio context")}function M(n){if(!k(n)){var a=n;e.isString(a)&&(a=e.toFloat(a)),e.isNumeric(a)?fe=a:_("_setMaxGain: Invalid gain level: "+a)}}function x(n,a){if(ee&&ae){e.isString(n)&&(n=e.toFloat(n));var i=X.masterGainVal;if(e.isNumeric(n)){i=n,i<0?i=0:i>1&&(i=1),i>fe&&(i=fe);var t=X.masterGainVal,r=ae.gain.value;if(t!==i&&(X.masterGainVal=i),r!==i)if(!k(a)&&e.isNumeric(a)){var o=e.msecToSec(a),s=A(),u=ee.currentTime+o;j("setMasterGain: "+i+" timeSec: "+o+" actualTime: "+u+" now: "+s),ae.gain.linearRampToValueAtTime(i,u)}else ae.gain.setValueAtTime(i,A())}else _("_setMasterGain: Invalid gain level: "+n)}else _("setMasterGain: invalid context of master gain")}function A(){return k(ee)?0:ee.currentTime}function F(n){k(n)?_("setMaxPlayDuration: Invalid duration: "+n):(e.isString(n)&&(n=e.toFloat(n)),e.isNumeric(n)?(j("setMaxPlayDuration: "+n),X.playDurationSec=n):_("setMaxPlayDuration: Invalid duration: "+n))}function N(e){if(B(e)){var n=X.envelope;for(var a in e)e.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(n[a]=e[a],j("setEnvelopeConf: "+a+": "+e[a]))}else _("setEnvelopeConf: Invalid envelope config")}function I(n,a,i){if(e.isString(n)&&e.isNumeric(a)&&e.isNumeric(i)){for(var t=0;t<$.length;t++){var r=$[t];e.isObjectInstanceOf(e.RampLinear,r)&&e.isObjectInstanceOf(e.RampSin,r)&&(r.paramName!==n||r.isFinished||(r.isFinished=!0,j("addRumpLinearAction: action already running for configParamName : "+n+" stopping it...")))}var o=A(),s=e.getNestedObjectValue(X,n);j("addRampLinearAction: configParamName: "+n+"  rampEndValue: "+a+"  rampDurationMs: "+i+" now: "+o+" currentValue: "+s);var u=e.createRampLinear(n,a,i,o,s);$.push(u)}else _("addRumpLinearAction: Invalid input parameters: configParamName : "+n+" rampEndValue: "+a+" rampDurationMs: "+i)}function L(n,a,i,t){if(e.isString(n)&&e.isNumeric(a)&&e.isNumeric(i)&&e.isNumeric(t)){for(var r=0;r<$.length;r++){var o=$[r];e.isObjectInstanceOf(e.RampLinear,o)&&e.isObjectInstanceOf(e.RampSin,o)&&(o.paramName!==n||o.isFinished||(o.isFinished=!0,j("addRampSinAction: action already running for configParamName : "+n+" stopping it...")))}var s=ee.currentTime,u=e.getNestedObjectValue(X,n);j("addRampSinAction: configParamName: "+n+"  rampAmplitude: "+a+"  rampFrequency: "+i+"  rampDurationMs: "+t+" now: "+s+" currentValue: "+u);var l=e.createRampSin(n,a,i,t,s,u);$.push(l)}else _("addRampSinAction: Invalid input parameters: configParamName : "+n+" rampAmplitude: "+a+" rampFrequency: "+i+" rampDurationMs: "+t)}function b(e){B(e)?$.push(e):_("addConfigAction: Invalid action")}function q(e){if(B(e)){var n=X.grain;for(var a in e)e.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(n[a]=e[a],j("setGrainConf: "+a+": "+e[a]))}else _("setGrainConf: Invalid grain config")}function w(n){e.setConfig(X,n)}function z(){if(!ne)return _("createBufferAudioSource: invalid audio buffer"),null;if(!ee)return _("createBufferAudioSource: Audio context is not initialised!!"),null;var e=ee.createBufferSource();return e.buffer=ne,e}function U(){if(!ee)return _("createPanner: Audio context is not initialised!!"),null;var e=ee.createPanner(),n=X.panner;return e.panningModel=n.panningModel,e.distanceModel=n.distanceModel,e}function D(){var n=e.getRandomIntFromRange(1,2);return 1===n}function E(n){if(k(n))_("setRndPan: invalid panner");else{var a=X.panner,i=a.maxPanAngle,t=e.getRandomIntFromRange(-1*i,i),r=Math.sin(t*(Math.PI/180));j("setRndPan: x: "+r),n.setPosition(r,0,r)}}function C(){if(!ee)return _("createBufferAudioSource: Audio context is not initialised!!"),null;var e=ee.createGain();return e}function _(n){e.logError(n,Z)}function j(n){e.log(n,Z)}function k(n){return e.isNull(n)}function B(n){return e.isObject(n)}const Z="ZsGranulator: ",H="ZsGranulator_PositionOscillator",J="ZsGranulator_PositionFreqLFO",K="ZsGranulator_PositionStartLFO",Q="ZsGranulator_PositionEndLFO",W="ZsGranulator_SizeOscillator";var X={masterGainVal:1,playDurationSec:30,playStartOffsetSec:0,maxGrains:16,bufferPositionPlayRate:.5,audioStopToleranceMs:5,isUsePositionOscillator:!0,isUseSizeOscillator:!0,isUsePositionFrequencyMod:!0,isUsePositionRangeMod:!0,panner:{isUsePanner:!1,panningModel:"equalpower",distanceModel:"linear",maxPanAngle:45},envelope:{attackTime:.5,decayTime:0,sustainTime:0,releaseTime:.5,sustainLevel:1},grain:{sizeMs:100,pitchRate:1,maxPositionOffsetRangeMs:100,maxPitchRateRange:.03,timeOffsetStepMs:10},positionOscillator:{minValue:500,maxValue:4500,type:"TRIANGLE",frequency:.2,frequencyLFO:{minValue:-.1,maxValue:0,type:"TRIANGLE",frequency:.02},startLFO:{minValue:-500,maxValue:500,type:"TRIANGLE",frequency:.1},endLFO:{minValue:-500,maxValue:500,type:"TRIANGLE",frequency:.1}},sizeOscillator:{minValue:-30,maxValue:500,type:"TRIANGLE",frequency:.1}},Y=[],$=[],ee=null,ne=null,ae=null,ie=null,te=null,re=null,oe=!1,se=!1,ue=!1,le=null,ce=null,fe=1;return a.prototype.play=function(e){var n=this;if(!ne)return _("Grain.play: Invalid buffer"),void setTimeout(function(){y(n)},this.size);var a=this.validate();if(!a)return _("Grain.play: Invalid grain"),void setTimeout(function(){y(n)},this.size);var i=C();if(!i)return _("Grain.play: Invalid gain"),void setTimeout(function(){y(n)},this.size);var t=z();if(!t)return _("Grain.play: Invalid audioSource"),void setTimeout(function(){y(n)},this.size);k(this.playbackRate)?this.playbackRate=1:t.playbackRate.value=this.playbackRate;var r=null,o=X.panner.isUsePanner;o&&D()&&(r=U(),E(r)),t.connect(i),k(r)?i.connect(ae):(i.connect(r),r.connect(ae)),this.envelope?this.envelope.applyTo(ne,i,e,this.durationSec):i.gain.setValueAtTime(1,e),t.onended=function(e){y(n,t)},1===this.playbackRate?t.start(e,this.position,this.durationSec):(t.start(e,this.position),t.stop(e+this.durationSec+this.playStopTolerance))},a.prototype.validate=function(){var e=ne.duration;if(k(this.position)||this.position<0||this.position>e)return _("Grain.validate: invalid position: "+position),!1;var n=this.position+this.durationSec;return!(n>e)||(j("Grain.validate: grain Duration: "+n+" greater than buffer Duration: "+e),!1)},{init:function(e,n,a){t(e,n,a)},play:function(){s()},stop:function(){T(!0)},reset:function(){i()},setGain:function(e,n){x(e,n)},setMaxGain:function(e){M(e)},setBuffer:function(e){V(e)},setPlayDuration:function(e){F(e)},setGrainEnvelope:function(e){N(e)},setGrainConfig:function(e){q(e)},setGranulatorConfig:function(e){w(e)},addAction:function(e){b(e)},addRampLinear:function(e,n,a){I(e,n,a)},addRampSin:function(e,n,a,i){L(e,n,a,i)},isReady:function(){return G()}}}(zsUtil);