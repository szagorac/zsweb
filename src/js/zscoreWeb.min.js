var zscore=function(t,e,n,i,a,o,r){"use strict";function s(t){this.message=t,this.name="ZScoreException"}function c(t,e,n,i,a,o,r,s){this.xStart=t,this.xEnd=e,this.yStart=n,this.yEnd=i,this.beatStartNum=a,this.beatStartDenom=o,this.beatEndNum=r,this.beatEndDenom=s}function l(t,e,n,i){this.id=t,this.no=e,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=t}function d(t,e){this.id="partBtn"+t,this.class="partListButton",this.onclick="onPartSelect('"+e+"')"}function f(){}function u(){if(!Ye.isInitialised){if(!(t&&e&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");t.setRunMode(Jt),Zt("init: "),Ue=t.isTouchDevice(),Ve=t.isSafari(navigator),Zt("init: IsTouch Device: "+Ue+" isSafari: "+Ve),Ye.fontCanvas=r.createElement("canvas"),Ye.canvasCtx=Ye.fontCanvas.getContext("2d"),t.listen("resize",o,x),t.listen("orientationchange",o,x),I(),P(),T(),Ye.isInitialised=!0}}function p(){m(Ye.topStave),m(Ye.bottomStave)}function m(e){if(!Gt(e)&&!Gt(e.config)){var n=e.config;t.setElementIdAttributes(n.positionLineId,n.posLineConf),t.setElementIdAttributes(n.beatBallId,n.posBallConf)}}function g(){Ye.isInitialised?(Zt("onStateBtnClick: zscore initialised"),e.isConnected()||(Zt("onStateBtnClick: zscore not connected, reconnecting..."),L())):(Zt("onStateBtnClick: initialising"),u())}function v(e){t.arrContains(Ye.score.parts,e)?(Ye.part.name=e,Pt(e),t.makeInVisible(Fe.idPartsListOuterDiv)):Zt("onPartSelection: unexpected part: "+e)}function S(t){}function b(){y()}function I(){e.init(Fe.connectionPreference,Fe.appUrlSse,Fe.appUrlWebsockets,Fe.appUrlHttp,R,h)}function T(){Gt(i)?Wt("initAudio: invalid zsAudio lib"):i.init(ze,0)}function y(){Gt(i)?Wt("resetAudio: invalid zsAudio lib"):i.reset()}function P(){n.init()}function x(e){if(!t.isObject(this))return null}function h(t,n){switch(t){case e.OPEN:N(n);break;case e.CLOSED:k(n);break;case e.ERROR:B(n);break;default:Wt("Unknown Connection Event State: "+t+" for type: "+n)}}function N(t){Zt(t+" connection opened."),C(t)}function k(t){Zt(t+" connection closed."),E(t)}function B(t){Zt(t+" connection error."),w(t)}function C(t){Ye.isConnected=!0,Ye.connectionType=t,Ye.reconnectAttmpts=0,A(Fe.connectedRectStyle,Fe.connectedBtnAttrib,Fe.connectedTxtStyle,ee)}function E(t){Ye.isConnected=!1,A(Fe.disconnectedRectStyle,Fe.disconnectedBtnAttrib,Fe.disconnectedTxtStyle,ae),L(t)}function w(t){Ye.isConnected=!1,A(Fe.errorRectStyle,Fe.errorBtnAttrib,Fe.errorTxtStyle,oe),L(t)}function A(e,n,i,a){var o=t.getElement(Fe.idServerStatusRect);Gt(o)||jt(o,e);var r=t.getElement(Fe.idServerStatusBtn);Gt(r)||Ht(r,n);var s=t.getElement(Fe.idServerStatusTxt);Gt(s)||(jt(s,i),s.textContent=a)}function L(t){e.reconnect(t,!0)}function R(t,e){Ye.isConnected||C(),Gt(t)||(e||b(),Qt(t.scoreInfo)&&D(t.scoreInfo),Qt(t.partInfo)&&rt(t.partInfo),Qt(t.pageInfo)&&$(t.pageInfo),Qt(t.mapInfo)&&V(t.mapInfo),Qt(t.bpm)&&0!=t.bpm&&U(t.bpm),Qt(t.actions)&&Nt(t.actions))}function D(e){t.isObject(e)&&(Qt(e.title)&&O(e.title),Qt(e.instruments)&&It(e.instruments),Qt(e.bpm)&&z(e.bpm),Qt(e.scoreDir)&&M(e.scoreDir))}function O(e){Ye.score.title!==e&&(Ye.score.title=e,Ye.score.noSpaceTitle=t.replaceEmptySpaces(e,Kt),n.setElementText(Fe.idTitle,e))}function M(t){Ye.scoreDir!==t&&(Ye.scoreDir=t)}function z(t){Ye.tempo!==t&&(Ye.tempo=t,n.setElementText(Fe.idTempoBpm,t))}function U(e){var n=t.toInt(e);if(!Gt(n)){var i=Ye.tempo,a=n/i;Ye.tempoModifier=a,z(n),Ye.isPlaying?Y(a):j()}}function V(e){if(!Gt(e.map)&&!Gt(e.pageId)){var n=e.pageId,i=e.staveId,a=e.map,o=Ye[i];if(!Gt(o)){var r=o.config.xLeftMargin,s=JSON.parse(JSON.stringify(a));if(t.isArray(s)){for(var c={},l=0;l<s.length;l++)F(c,s[l],r);Ye.part.pageBeatMaps[n]=c,o.beatMap=c,H(i)}}}}function F(t,e,n){if(!(Gt(t)||Gt(e)||Gt(e.beatStartNum))){var i=e.beatStartNum,a=e.xStart+n,o=e.xEnd+n,r=new c(a,o,e.yStart,e.yEnd,e.beatStartNum,e.beatStartDenom,e.beatEndNum,e.beatEndDenom);t[i]=r}}function Y(t){_(Ye.topStave.timeline,t),_(Ye.bottomStave.timeline,t)}function _(t,e){if(!Gt(t)){var n=t.timeScale(),i=n*e;t.timeScale(i)}}function j(){G(Ye.topStave),G(Ye.bottomStave)}function H(t){Gt(t)||G(Ye[t])}function G(t){if(!Gt(t)){var e=gsap.timeline({onComplete:q,onCompleteParams:[t.id],paused:!0}),n=t.beatMap;if(!Gt(n)){var i=t.config.positionLineId,o=t.config.beatBallId,r=t.config.ballYmax,s=!0;for(var c in n){var l=n[c],d=Ye.tempo,f=a.getBeatDurationSec(d),u=l.beatStartNum;if(s){var p=Fe.beatIdPrefix+(u-1),m=l.xStart,g=Q(i,0,m,p,0);e.add(g,re);var v=W(o,0,m,p);e.add(v,se),s=!1}m=l.xEnd,p=Fe.beatIdPrefix+u;var S=Fe.tweenIdPrefix+p,b=Q(i,f,m,p,u),I=W(o,f,m,p),T=Z(o,f/2,r,p);S=b.vars.id;e.addLabel(S,se),e.add(b,se),e.add(I,re),e.add(T,S)}t.timeline=e}}}function Q(e,n,i,a,o){var r=Fe.tweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:r,duration:n,attr:{x1:i,x2:i},ease:"none",onStart:J,onStartParams:[a,o],onComplete:K,onCompleteParams:[a,o]})}function W(e,n,i,a){var o=Fe.ballTweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:o,duration:n,attr:{cx:i},ease:"none"})}function Z(e,n,i,a){var o=Fe.ballTweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:o,duration:n,attr:{cy:i,r:2},ease:"power1.out",autoAlpha:.5,repeat:1,yoyo:!0})}function q(t){Zt("onTimelineComplete stave: "+t);var e=Ye[t];Qt(e)&&(e.isRunning=!1),Qt(e.timeline)&&e.timeline.pause(0)}function J(t,e){var n=i.getCurrentTime();Ye.audioTlBeatTime=n,qt("onBeatStart: beat: "+t+" beatNo: "+e+" beatTime: "+n),X(e,t)}function K(t,e){var n=i.getCurrentTime(),a=n-Ye.startTimeTl;qt("onBeatEnd: beat: "+t+" beatNo: "+e+" elapsedTime: "+a)}function X(e,n){t.isNumeric(e)&&(t.isNull(n)&&(n=Fe.beatIdPrefix+e),Ye.currentBeatId=n,Ye.currentBeatNo=e)}function $(t){if(!Gt(t.staveId)){var e=t.staveId,n=Ye[e];Gt(n)?Wt("processPageinfo: Invalid stave for id: {}",e):(Qt(t.filename)&&(n.filename=t.filename),Qt(t.pageId)&&(n.pageId=t.pageId),tt(n))}}function tt(e){if(!Gt(e)){var n=e.config;if(!Gt(n)){var i=null,a=nt(e.pageId);i=Gt(a)?et(e.fileName):a.src;var o=t.getElement(n.imgId);o.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),o.setAttribute("href",i)}}}function et(t){return Ye.scoreDir+Ye.score.noSpaceTitle+Xt+t}function nt(t){var e=Ye.part.pages[t];return Gt(e)?null:e.img}function it(t){var e=Ye.part.pages[t];Qt(e)&&(e.isLoaded=!0),Ye.pageNoToLoad--,0===Ye.pageNoToLoad&&ot(),at(Ye.pageNoToLoad)}function at(t){if(t>0){var e=ne+" "+t;A(Fe.errorRectStyle,Fe.errorBtnAttrib,Fe.errorTxtStyle,e)}else A(Fe.connectedRectStyle,Fe.connectedBtnAttrib,Fe.connectedTxtStyle,ie)}function ot(){Zt("onPageLoadComplete: ");var t=Ye.part.pages,e=!0;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i.isLoaded||(Zt("onPageLoadComplete: page: "+n+" is not loaded, retying load"),ft(i.no),e=!1)}e&&(Zt("All Pages loaded: "),Ye.isReady=!0,xt())}function rt(e){if(Qt(e.name)&&(Ye.part.name=e.name,n.setElementText(Fe.idInstrument,e.name)),Qt(e.pageRanges)){var i=e.pageRanges;if(t.isArray(i))for(var a=0;a<i.length;a++)bt(i[a]);else bt(i)}Qt(e.imgDir)&&(Ye.part.imgDir=e.imgDir),Qt(e.imgPageNameToken)&&(Ye.part.imgPageNameToken=e.imgPageNameToken),Qt(e.imgContPageName)&&(Ye.part.imgContPageName=e.imgContPageName),Qt(e.contPageNo)&&(Ye.part.contPageNo=e.contPageNo),st()}function st(){var e=Ye.part,n=e.pageRanges;if(t.isArray(n)){for(var i=0;i<n.length;i++)dt(n[i]);ct(),lt()}}function ct(){var t=gt();Ye.pageNoToLoad++,ut(t)}function lt(){var t=mt();Ye.pageNoToLoad++,ut(t)}function dt(e){if(t.isObject(e)){var n=1,i=1;Qt(e.start)&&(n=t.toInt(e.start)),Qt(e.end)&&(i=t.toInt(e.end));var a=Ye.pageNoToLoad+(i-n+1);Ye.pageNoToLoad=a;for(var o=n;o<=i;o++)ft(o)}}function ft(t){var e=pt(t);ut(e)}function ut(t){if(!Gt(t)){var e=t.imgFileUrl;Gt(e)||t.loadImg(e,t.id)}}function pt(e){var n=St(e),i=Ye.part.pages[n];if(Qt(i))return i;var a=Ye.part.imgPageNameToken;a=Gt(a)?vt(e):t.replace(a,Fe.pageNoToken,""+e);var o=Ye.part.imgDir+a;i=new l(n,e,a,o);return Ye.part.pages[n]=i,i}function mt(){var t=Ye.part.contPageNo,e=St(t),n=Ye.part.pages[e];if(Qt(n))return n;var i=Ye.part.imgContPageName,a=Ye.part.imgDir+i;n=new l(e,t,i,a);return Ye.part.pages[e]=n,n}function gt(){var t=Ye.part.blankPageNo,e=St(t),n=Ye.part.pages[e];if(Qt(n))return n;var i=Fe.blankPageUrl,a=Fe.blankPageUrl;n=new l(e,t,i,a);return Ye.part.pages[e]=n,n}function vt(t){return Ye.score.noSpaceTitle+Kt+instrumentName+"_page"+t+".png"}function St(t){return Fe.pageIdPrefix+t}function bt(t){if(!(Gt(t)||Gt(t.start)||Gt(t.end))){var e=t.start,n=t.end,i={start:e,end:n};Ye.part.pageRanges=[],Ye.part.pageRanges.push(i)}}function It(e){var n=[];t.isArray(e)?n=e:n.push(e),t.arrEquals(Ye.score.parts,n)||(Ye.score.parts=n),Tt(n)?Pt(Ye.part.name):yt(n)}function Tt(e){if(Gt(Ye.part.name)||!t.isArray(e))return!1;for(var n=Ye.part.name,i=0;i<e.length;i++)if(n===e[i])return!0;return!1}function yt(e){var n=t.getElement(Fe.idParts);if(!Gt(n)){t.removeElementChildren(n);for(var i=0;i<e.length;i++){var a=e[i];if(!t.arrContains(Fe.filterOutParts,a)){var o=new d(i+1,a),r=t.createDiv(),s=t.createButton(o);t.setText(s,a),t.addChildToParent(r,s),t.addChildToParent(n,r)}}t.makeVisible(Fe.idPartsListOuterDiv)}}function Pt(t){var n=new f;n[Re]=t,e.sendEvent(we,n)}function xt(){var t=new f;t[Re]=Ye.part.name,e.sendEvent(Ae,t)}function ht(t){var n=new f;n[De]=t,e.sendEvent(Le,n)}function Nt(e){var n=null,i=[],a={};if(t.isArray(e))for(var o=0;o<e.length;o++){var r=e[o];Qt(r.type)&&(n=r.type),Qt(r.targets)&&(i=r.targets),Qt(r.params)&&(a=r.params),kt(n,i,a)}}function kt(e,n,i){if(t.logDebug("doAction: "+e),!Gt(e))switch(e){case"PING":_t(i);break;case"START":zt(n);break;case"STOP":Mt();break;case"SEMAPHORE_ON":wt(i);break;case"SEMAPHORE_OFF":At(i);break;case"ACTIVATE":Bt(n,i);break;default:Wt("doAction: Unknown actionType: "+e)}}function Bt(e,n){if(!Gt(n)&&!Gt(e))if(t.isArray(e))for(var i=0;i<e.length;i++)Ct(e[i],n);else Ct(e,n)}function Ct(t,e){var n=Ye[t],i=e[Oe],a=e[Me];Et(n,i,a)}function Et(e,n,i){Gt(e)||Gt(n)||Gt(i)||(n?t.setElementIdStyleProperty(e.config.maskId,Fe.activeStaveStyle):t.setElementIdStyleProperty(e.config.maskId,Fe.inactiveStaveStyle),i&&Vt(e.timeline))}function wt(t){Gt(t)||Rt(t.lightNo,t.colourId)}function At(t){Gt(t)||Dt(t.lightNo,ve)}function Lt(){Dt(4,ve),Dt(1,le)}function Rt(t,e){var n=Ot(e);Dt(t,n)}function Dt(e,i){if(!Gt(e)&&!Gt(i))for(var a=t.toInt(e),o=1;o<=a;o++){var r=Fe.idSemaphorePrefix+o;n.setElementColour(r,i)}}function Ot(t){var e;switch(t||(t=1),t){case 4:e=le;break;case 3:e=de;break;case 2:e=fe;break;case 1:default:e=ce}return e}function Mt(){Ft(),Ye.isPlaying=!1,Lt(),p()}function zt(e){if(t.isArray(e))for(var n=0;n<e.length;n++)Ut(e[n]);else Ut(e)}function Ut(t){if(!Gt(t)){var e=Ye[t];if(!Gt(e)){var n=e.timeline;Gt(n)||(Vt(n),Ye.isPlaying=!0)}}}function Vt(t){if(Gt(t))Wt("startTimeline: invalid timeline");else{var e=t.progress();e>0&&e<1?t.resume():t.play(0)}}function Ft(){Yt(Ye.topStave.timeline),Yt(Ye.bottomStave.timeline),Ye.bottomStave.isPlaying=!1,Ye.topStave.isPlaying=!1}function Yt(t){Gt(t)?Wt("stopTimeline: invalid timeline"):t.pause()}function _t(e){t.isObject(e)&&Qt(e.sendTimeMs)&&ht(e.sendTimeMs)}function jt(e,n){t.setElementStyleProperty(e,n)}function Ht(e,n){t.setElementAttributes(e,n)}function Gt(e){return t.isNull(e)}function Qt(e){return t.isNotNull(e)}function Wt(e){t.logError(e)}function Zt(e){t.log(e)}function qt(e){t.logDebug(e)}const Jt="dev",Kt="_",Xt="/",$t="AV",te="FullScore",ee="Connected",ne="Loading",ie="READY",ae="Reconnecting",oe="Error",re="<",se=">",ce="green",le="red",de="orange",fe="yellow",ue="white",pe="black",me="blue",ge="grey",ve="none",Se=ve,be=ue,Ie=ce,Te=le,ye=de,Pe=me,xe=ge,he=ce,Ne=le,ke=de,Be=ue,Ce=ue,Ee=pe,we="PART_REG",Ae="PART_READY",Le="PING",Re="part",De="serverTime",Oe="isActive",Me="isPlay";var ze=["/audio/violin-tuning.mp3"],Ue=null,Ve=null,Fe={connectionPreference:"ws,sse,poll",defaultConnectionType:e.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",idSemaphorePrefix:"semC",blankPageUrl:"img/blankStave.png",filterOutParts:[$t,te],connectedRectStyle:{fill:Ie,stroke:he,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:Te,stroke:Ne,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:ye,stroke:ke,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:Be},disconnectedTxtStyle:{fill:Ce},errorTxtStyle:{fill:Ee},activeStaveStyle:{fill:Se,stroke:Pe,"stroke-width":"1px",visibility:"visible",opacity:.5},inactiveStaveStyle:{fill:be,stroke:xe,"stroke-width":"1px",visibility:"visible",opacity:.4},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"},topStave:{gId:"stvTop",imgId:"stvTopImg",startLineId:"stvTopStartLine",positionLineId:"stvTopPosLine",beatBallId:"stvTopBeatBall",maskId:"stvTopMask",ballYmax:84,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"80",x2:"95",y2:"281"},posBallConf:{cx:"95",cy:"110",r:"4"}},bottomStave:{gId:"stvBot",imgId:"stvBotImg",startLineId:"stvBotStartLine",positionLineId:"stvBotPosLine",beatBallId:"stvBotBeatBall",maskId:"stvBotMask",ballYmax:305,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"301",x2:"95",y2:"502"},posBallConf:{cx:"95",cy:"331",r:"4"}}},Ye={isPlaying:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,blankPageNo:0,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{},pageBeatMaps:{}},topStave:{id:"topStave",config:Fe.topStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!0,isPlaying:!1},bottomStave:{id:"bottomStave",config:Fe.bottomStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!1,isPlaying:!1},startTimeTl:0,currentBeatId:"b0",currentBeatNo:0,tempo:0,tempoModifier:1,scoreDir:"/score/",currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return l.prototype.loadImg=function(t){this.img.src=t,this.img.onload=function(){Zt("pageImgOnLoad: id: "+this.pageId),it(this.pageId)}},{onStateBtn:function(){g()},onPartSelect:function(t){v(t)},onInstrumentSelect:function(t){S(t)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);