var zscore=function(e,t,n,i,a,r,o){"use strict";function s(e){this.message=e,this.name="ZScoreException"}function c(e,t,n,i){this.id=e,this.no=t,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=e}function l(e,t){this.id="partBtn"+e,this.class="partListButton",this.onclick="onPartSelect('"+t+"')"}function d(){}function p(){if(!Fe.isInitialised){if(!(e&&t&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");e.setRunMode(de),le("init: "),Me=e.isTouchDevice(),Ve=e.isSafari(navigator),le("init: IsTouch Device: "+Me+" isSafari: "+Ve),Fe.fontCanvas=o.createElement("canvas"),Fe.canvasCtx=Fe.fontCanvas.getContext("2d"),e.listen("resize",r,b),e.listen("orientationchange",r,b),v(),P(),S(),Fe.isInitialised=!0}}function u(){Fe.isInitialised?(le("onStateBtnClick: zscore initialised"),t.isConnected()||(le("onStateBtnClick: zscore not connected, reconnecting..."),x())):(le("onStateBtnClick: initialising"),p())}function f(t){e.arrContains(Fe.score.parts,t)?(Fe.part.name=t,$(t),e.makeInVisible(je.idPartsListOuterDiv)):le("onPartSelection: unexpected part: "+t)}function g(e){}function m(){T()}function v(){t.init(je.connectionPreference,je.appUrlSse,je.appUrlWebsockets,je.appUrlHttp,R,y)}function S(){oe(i)?ce("initAudio: invalid zsAudio lib"):i.init(Ue,0)}function T(){oe(i)?ce("resetAudio: invalid zsAudio lib"):i.reset()}function P(){n.init()}function b(t){if(!e.isObject(this))return null}function y(e,n){switch(e){case t.OPEN:h(n);break;case t.CLOSED:I(n);break;case t.ERROR:N(n);break;default:ce("Unknown Connection Event State: "+e+" for type: "+n)}}function h(e){le(e+" connection opened."),k(e)}function I(e){le(e+" connection closed."),w(e)}function N(e){le(e+" connection error."),B(e)}function k(e){Fe.isConnected=!0,Fe.connectionType=e,Fe.reconnectAttmpts=0,C(je.connectedRectStyle,je.connectedBtnAttrib,je.connectedTxtStyle,ge)}function w(e){Fe.isConnected=!1,C(je.disconnectedRectStyle,je.disconnectedBtnAttrib,je.disconnectedTxtStyle,Se),x(e)}function B(e){Fe.isConnected=!1,C(je.errorRectStyle,je.errorBtnAttrib,je.errorTxtStyle,Te),x(e)}function C(t,n,i,a){var r=e.getElement(je.idServerStatusRect);oe(r)||ae(r,t);var o=e.getElement(je.idServerStatusBtn);oe(o)||re(o,n);var s=e.getElement(je.idServerStatusTxt);oe(s)||(ae(s,i),s.textContent=a)}function x(e){t.reconnect(e,!0)}function R(e,t){Fe.isConnected||k(),oe(e)||(t||m(),se(e.scoreInfo)&&A(e.scoreInfo),se(e.partInfo)&&V(e.partInfo),se(e.pageInfo)&&z(e.pageInfo),se(e.actions)&&te(e.actions))}function A(t){e.isObject(t)&&(se(t.title)&&E(t.title),se(t.instruments)&&J(t.instruments),se(t.bpm)&&L(t.bpm),se(t.scoreDir)&&D(t.scoreDir))}function E(t){Fe.score.title!==t&&(Fe.score.title=t,Fe.score.noSpaceTitle=e.replaceEmptySpaces(t,pe),n.setElementText(je.idTitle,t))}function D(e){Fe.scoreDir!==e&&(Fe.scoreDir=e)}function L(e){Fe.tempo!==e&&(Fe.tempo=e,n.setElementText(je.idTempoBpm,e))}function z(e){if(!oe(e.staveId))e.staveId}function O(e){var t=Fe.part.pages[e];se(t)&&(t.isLoaded=!0),Fe.pageNoToLoad--,0===Fe.pageNoToLoad&&M(),U(Fe.pageNoToLoad)}function U(e){if(e>0){var t=me+" "+e;C(je.errorRectStyle,je.errorBtnAttrib,je.errorTxtStyle,t)}else C(je.connectedRectStyle,je.connectedBtnAttrib,je.connectedTxtStyle,ve)}function M(){le("onPageLoadComplete: ");var e=Fe.part.pages,t=!0;for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];i.isLoaded||(le("onPageLoadComplete: page: "+n+" is not loaded, retying load"),W(i.no),t=!1)}t&&(le("All Pages loaded: "),Fe.isReady=!0)}function V(t){if(se(t.name)&&(Fe.part.name=t.name,n.setElementText(je.idInstrument,t.name)),se(t.pageRanges)){var i=t.pageRanges;if(e.isArray(i))for(var a=0;a<i.length;a++)K(i[a]);else K(i)}se(t.imgDir)&&(Fe.part.imgDir=t.imgDir),se(t.imgPageNameToken)&&(Fe.part.imgPageNameToken=t.imgPageNameToken),se(t.imgContPageName)&&(Fe.part.imgContPageName=t.imgContPageName),se(t.contPageNo)&&(Fe.part.contPageNo=t.contPageNo),j()}function j(){var t=Fe.part,n=t.pageRanges;if(e.isArray(n)){for(var i=0;i<n.length;i++)G(n[i]);F()}}function F(){var e=q();Fe.pageNoToLoad++,Z(e)}function G(t){if(e.isObject(t)){var n=1,i=1;se(t.start)&&(n=e.toInt(t.start)),se(t.end)&&(i=e.toInt(t.end));var a=Fe.pageNoToLoad+(i-n+1);Fe.pageNoToLoad=a;for(var r=n;r<=i;r++)W(r)}}function W(e){var t=_(e);Z(t)}function Z(e){if(!oe(e)){var t=e.imgFileUrl;oe(t)||e.loadImg(t,e.id)}}function _(t){var n=Y(t),i=Fe.part.pages[n];if(se(i))return i;var a=Fe.part.imgPageNameToken;a=oe(a)?H(t):e.replace(a,je.pageNoToken,""+t);var r=Fe.part.imgDir+a;i=new c(n,t,a,r);return Fe.part.pages[n]=i,i}function q(){var e=Fe.part.contPageNo,t=Y(e),n=Fe.part.pages[t];if(se(n))return n;var i=Fe.part.imgContPageName,a=Fe.part.imgDir+i;n=new c(t,e,i,a);return Fe.part.pages[t]=n,n}function H(e){return Fe.score.noSpaceTitle+pe+instrumentName+"_page"+e+".png"}function Y(e){return je.pageIdPrefix+e}function K(e){if(!(oe(e)||oe(e.start)||oe(e.end))){var t=e.start,n=e.end,i={start:t,end:n};Fe.part.pageRanges=[],Fe.part.pageRanges.push(i)}}function J(t){var n=[];e.isArray(t)?n=t:n.push(t),e.arrEquals(Fe.score.parts,n)||(Fe.score.parts=n),Q(n)?$(Fe.part.name):X(n)}function Q(t){if(oe(Fe.part.name)||!e.isArray(t))return!1;for(var n=Fe.part.name,i=0;i<t.length;i++)if(n===t[i])return!0;return!1}function X(t){var n=e.getElement(je.idParts);if(!oe(n)){e.removeElementChildren(n);for(var i=0;i<t.length;i++){var a=t[i];if(!e.arrContains(je.filterOutParts,a)){var r=new l(i+1,a),o=e.createDiv(),s=e.createButton(r);e.setText(s,a),e.addChildToParent(o,s),e.addChildToParent(n,o)}}e.makeVisible(je.idPartsListOuterDiv)}}function $(e){var n=new d;n[ze]=e,t.sendEvent(De,n)}function ee(e){var n=new d;n[Oe]=e,t.sendEvent(Le,n)}function te(t){var n=null,i=[],a={};if(e.isArray(t))for(var r=0;r<t.length;r++){var o=t[r];se(o.type)&&(n=o.type),se(o.targets)&&(i=o.targets),se(o.params)&&(a=o.params),ne(n,i,a)}}function ne(e,t,n){if(le("doAction: "+e),!oe(e))switch(e){case"PING":ie(n);break;default:ce("doAction: Unknown actionType: "+e)}}function ie(t){e.isObject(t)&&se(t.sendTimeMs)&&ee(t.sendTimeMs)}function ae(t,n){e.setElementStyleProperty(t,n)}function re(t,n){e.setElementAttributes(t,n)}function oe(t){return e.isNull(t)}function se(t){return e.isNotNull(t)}function ce(t){e.logError(t)}function le(t){e.log(t)}const de="DEV",pe="_",ue="AV",fe="FullScore",ge="Connected",me="Loading",ve="READY",Se="Reconnecting",Te="Error",Pe="green",be="red",ye="orange",he="white",Ie="black",Ne=Pe,ke=be,we=ye,Be=Pe,Ce=be,xe=ye,Re=he,Ae=he,Ee=Ie,De="PART_REG",Le="PING",ze="part",Oe="serverTime";var Ue=["/audio/violin-tuning.mp3"],Me=null,Ve=null,je={connectionPreference:"ws,sse,poll",defaultConnectionType:t.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",filterOutParts:[ue,fe],connectedRectStyle:{fill:Ne,stroke:Be,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:ke,stroke:Ce,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:we,stroke:xe,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:Re},disconnectedTxtStyle:{fill:Ae},errorTxtStyle:{fill:Ee},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"}},Fe={isRunning:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{}},topStave:{pageId:"0",filename:"img/blankStave.png",timeSpaceMap:{}},bottomStave:{pageId:"0",filename:"img/blankStave.png",timeSpaceMap:{}},tsBaseBeatMaps:{},startTimeTl:0,currentBeatId:"b0",tempo:0,scoreDir:"/score/",topStaveTimeline:{},bottomStaveTimeline:{},lastTimelineBeatNo:0,currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return c.prototype.loadImg=function(e){this.img.src=e,this.img.onload=function(){le("pageImgOnLoad: id: "+this.pageId),O(this.pageId)}},{onStateBtn:function(){u()},onPartSelect:function(e){f(e)},onInstrumentSelect:function(e){g(e)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);