var zscore=function(e,t,n,i,a,r,o){"use strict";function s(e){this.message=e,this.name="ZScoreException"}function c(e,t,n,i){this.id=e,this.no=t,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=e}function l(e,t){this.id="partBtn"+e,this.class="partListButton",this.onclick="onPartSelect('"+t+"')"}function d(){}function p(){if(!We.isInitialised){if(!(e&&t&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");e.setRunMode(ue),pe("init: "),Fe=e.isTouchDevice(),_e=e.isSafari(navigator),pe("init: IsTouch Device: "+Fe+" isSafari: "+_e),We.fontCanvas=o.createElement("canvas"),We.canvasCtx=We.fontCanvas.getContext("2d"),e.listen("resize",r,b),e.listen("orientationchange",r,b),v(),P(),S(),We.isInitialised=!0}}function u(){We.isInitialised?(pe("onStateBtnClick: zscore initialised"),t.isConnected()||(pe("onStateBtnClick: zscore not connected, reconnecting..."),R())):(pe("onStateBtnClick: initialising"),p())}function f(t){e.arrContains(We.score.parts,t)?(We.part.name=t,ee(t),e.makeInVisible(Ge.idPartsListOuterDiv)):pe("onPartSelection: unexpected part: "+t)}function g(e){}function m(){T()}function v(){t.init(Ge.connectionPreference,Ge.appUrlSse,Ge.appUrlWebsockets,Ge.appUrlHttp,x,y)}function S(){ce(i)?de("initAudio: invalid zsAudio lib"):i.init(je,0)}function T(){ce(i)?de("resetAudio: invalid zsAudio lib"):i.reset()}function P(){n.init()}function b(t){if(!e.isObject(this))return null}function y(e,n){switch(e){case t.OPEN:h(n);break;case t.CLOSED:I(n);break;case t.ERROR:N(n);break;default:de("Unknown Connection Event State: "+e+" for type: "+n)}}function h(e){pe(e+" connection opened."),k(e)}function I(e){pe(e+" connection closed."),w(e)}function N(e){pe(e+" connection error."),B(e)}function k(e){We.isConnected=!0,We.connectionType=e,We.reconnectAttmpts=0,C(Ge.connectedRectStyle,Ge.connectedBtnAttrib,Ge.connectedTxtStyle,ve)}function w(e){We.isConnected=!1,C(Ge.disconnectedRectStyle,Ge.disconnectedBtnAttrib,Ge.disconnectedTxtStyle,Pe),R(e)}function B(e){We.isConnected=!1,C(Ge.errorRectStyle,Ge.errorBtnAttrib,Ge.errorTxtStyle,be),R(e)}function C(t,n,i,a){var r=e.getElement(Ge.idServerStatusRect);ce(r)||oe(r,t);var o=e.getElement(Ge.idServerStatusBtn);ce(o)||se(o,n);var s=e.getElement(Ge.idServerStatusTxt);ce(s)||(oe(s,i),s.textContent=a)}function R(e){t.reconnect(e,!0)}function x(e,t){We.isConnected||k(),ce(e)||(t||m(),le(e.scoreInfo)&&A(e.scoreInfo),le(e.partInfo)&&j(e.partInfo),le(e.pageInfo)&&z(e.pageInfo),le(e.actions)&&ie(e.actions))}function A(t){e.isObject(t)&&(le(t.title)&&E(t.title),le(t.instruments)&&Q(t.instruments),le(t.bpm)&&L(t.bpm),le(t.scoreDir)&&D(t.scoreDir))}function E(t){We.score.title!==t&&(We.score.title=t,We.score.noSpaceTitle=e.replaceEmptySpaces(t,fe),n.setElementText(Ge.idTitle,t))}function D(e){We.scoreDir!==e&&(We.scoreDir=e)}function L(e){We.tempo!==e&&(We.tempo=e,n.setElementText(Ge.idTempoBpm,e))}function z(e){if(!ce(e.staveId)){var t=e.staveId,n=We[t];ce(n)?de("processPageinfo: Invalid stave for id: {}",t):(le(e.filename)&&(n.filename=e.filename),le(e.pageId)&&(n.pageId=e.filename),O(n))}}function O(e){ce(e)}function U(e){var t=We.part.pages[e];le(t)&&(t.isLoaded=!0),We.pageNoToLoad--,0===We.pageNoToLoad&&V(),M(We.pageNoToLoad)}function M(e){if(e>0){var t=Se+" "+e;C(Ge.errorRectStyle,Ge.errorBtnAttrib,Ge.errorTxtStyle,t)}else C(Ge.connectedRectStyle,Ge.connectedBtnAttrib,Ge.connectedTxtStyle,Te)}function V(){pe("onPageLoadComplete: ");var e=We.part.pages,t=!0;for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];i.isLoaded||(pe("onPageLoadComplete: page: "+n+" is not loaded, retying load"),W(i.no),t=!1)}t&&(pe("All Pages loaded: "),We.isReady=!0,te())}function j(t){if(le(t.name)&&(We.part.name=t.name,n.setElementText(Ge.idInstrument,t.name)),le(t.pageRanges)){var i=t.pageRanges;if(e.isArray(i))for(var a=0;a<i.length;a++)J(i[a]);else J(i)}le(t.imgDir)&&(We.part.imgDir=t.imgDir),le(t.imgPageNameToken)&&(We.part.imgPageNameToken=t.imgPageNameToken),le(t.imgContPageName)&&(We.part.imgContPageName=t.imgContPageName),le(t.contPageNo)&&(We.part.contPageNo=t.contPageNo),F()}function F(){var t=We.part,n=t.pageRanges;if(e.isArray(n)){for(var i=0;i<n.length;i++)G(n[i]);_()}}function _(){var e=q();We.pageNoToLoad++,Y(e)}function G(t){if(e.isObject(t)){var n=1,i=1;le(t.start)&&(n=e.toInt(t.start)),le(t.end)&&(i=e.toInt(t.end));var a=We.pageNoToLoad+(i-n+1);We.pageNoToLoad=a;for(var r=n;r<=i;r++)W(r)}}function W(e){var t=Z(e);Y(t)}function Y(e){if(!ce(e)){var t=e.imgFileUrl;ce(t)||e.loadImg(t,e.id)}}function Z(t){var n=K(t),i=We.part.pages[n];if(le(i))return i;var a=We.part.imgPageNameToken;a=ce(a)?H(t):e.replace(a,Ge.pageNoToken,""+t);var r=We.part.imgDir+a;i=new c(n,t,a,r);return We.part.pages[n]=i,i}function q(){var e=We.part.contPageNo,t=K(e),n=We.part.pages[t];if(le(n))return n;var i=We.part.imgContPageName,a=We.part.imgDir+i;n=new c(t,e,i,a);return We.part.pages[t]=n,n}function H(e){return We.score.noSpaceTitle+fe+instrumentName+"_page"+e+".png"}function K(e){return Ge.pageIdPrefix+e}function J(e){if(!(ce(e)||ce(e.start)||ce(e.end))){var t=e.start,n=e.end,i={start:t,end:n};We.part.pageRanges=[],We.part.pageRanges.push(i)}}function Q(t){var n=[];e.isArray(t)?n=t:n.push(t),e.arrEquals(We.score.parts,n)||(We.score.parts=n),X(n)?ee(We.part.name):$(n)}function X(t){if(ce(We.part.name)||!e.isArray(t))return!1;for(var n=We.part.name,i=0;i<t.length;i++)if(n===t[i])return!0;return!1}function $(t){var n=e.getElement(Ge.idParts);if(!ce(n)){e.removeElementChildren(n);for(var i=0;i<t.length;i++){var a=t[i];if(!e.arrContains(Ge.filterOutParts,a)){var r=new l(i+1,a),o=e.createDiv(),s=e.createButton(r);e.setText(s,a),e.addChildToParent(o,s),e.addChildToParent(n,o)}}e.makeVisible(Ge.idPartsListOuterDiv)}}function ee(e){var n=new d;n[Me]=e,t.sendEvent(ze,n)}function te(){var e=new d;e[Me]=We.part.name,t.sendEvent(Oe,e)}function ne(e){var n=new d;n[Ve]=e,t.sendEvent(Ue,n)}function ie(t){var n=null,i=[],a={};if(e.isArray(t))for(var r=0;r<t.length;r++){var o=t[r];le(o.type)&&(n=o.type),le(o.targets)&&(i=o.targets),le(o.params)&&(a=o.params),ae(n,i,a)}}function ae(t,n,i){if(e.logDebug("doAction: "+t),!ce(t))switch(t){case"PING":re(i);break;default:de("doAction: Unknown actionType: "+t)}}function re(t){e.isObject(t)&&le(t.sendTimeMs)&&ne(t.sendTimeMs)}function oe(t,n){e.setElementStyleProperty(t,n)}function se(t,n){e.setElementAttributes(t,n)}function ce(t){return e.isNull(t)}function le(t){return e.isNotNull(t)}function de(t){e.logError(t)}function pe(t){e.log(t)}const ue="DEV",fe="_",ge="AV",me="FullScore",ve="Connected",Se="Loading",Te="READY",Pe="Reconnecting",be="Error",ye="green",he="red",Ie="orange",Ne="white",ke="black",we=ye,Be=he,Ce=Ie,Re=ye,xe=he,Ae=Ie,Ee=Ne,De=Ne,Le=ke,ze="PART_REG",Oe="PART_READY",Ue="PING",Me="part",Ve="serverTime";var je=["/audio/violin-tuning.mp3"],Fe=null,_e=null,Ge={connectionPreference:"ws,sse,poll",defaultConnectionType:t.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",filterOutParts:[ge,me],connectedRectStyle:{fill:we,stroke:Re,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:Be,stroke:xe,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:Ce,stroke:Ae,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:Ee},disconnectedTxtStyle:{fill:De},errorTxtStyle:{fill:Le},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"}},We={isRunning:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{}},topStave:{pageId:"0",filename:"img/blankStave.png",timeSpaceMap:{}},bottomStave:{pageId:"0",filename:"img/blankStave.png",timeSpaceMap:{}},tsBaseBeatMaps:{},startTimeTl:0,currentBeatId:"b0",tempo:0,scoreDir:"/score/",topStaveTimeline:{},bottomStaveTimeline:{},lastTimelineBeatNo:0,currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return c.prototype.loadImg=function(e){this.img.src=e,this.img.onload=function(){pe("pageImgOnLoad: id: "+this.pageId),U(this.pageId)}},{onStateBtn:function(){u()},onPartSelect:function(e){f(e)},onInstrumentSelect:function(e){g(e)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);