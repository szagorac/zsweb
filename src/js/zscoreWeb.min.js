var zscore=function(t,e,n,i,a,r,o){"use strict";function s(t){this.message=t,this.name="ZScoreException"}function c(t,e,n,i,a,r,o,s){this.xStart=t,this.xEnd=e,this.yStart=n,this.yEnd=i,this.beatStartNum=a,this.beatStartDenom=r,this.beatEndNum=o,this.beatEndDenom=s}function l(t,e,n,i){this.id=t,this.no=e,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=t}function d(t,e){this.id="partBtn"+t,this.class="partListButton",this.onclick="onPartSelect('"+e+"')"}function p(){}function u(){if(!fe.isInitialised){if(!(t&&e&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");t.setRunMode(Lt),At("init: "),de=t.isTouchDevice(),pe=t.isSafari(navigator),At("init: IsTouch Device: "+de+" isSafari: "+pe),fe.fontCanvas=o.createElement("canvas"),fe.canvasCtx=fe.fontCanvas.getContext("2d"),t.listen("resize",r,P),t.listen("orientationchange",r,P),S(),I(),b(),fe.isInitialised=!0}}function f(){fe.isInitialised?(At("onStateBtnClick: zscore initialised"),e.isConnected()||(At("onStateBtnClick: zscore not connected, reconnecting..."),E())):(At("onStateBtnClick: initialising"),u())}function g(e){t.arrContains(fe.score.parts,e)?(fe.part.name=e,It(e),t.makeInVisible(ue.idPartsListOuterDiv)):At("onPartSelection: unexpected part: "+e)}function m(t){}function v(){T()}function S(){e.init(ue.connectionPreference,ue.appUrlSse,ue.appUrlWebsockets,ue.appUrlHttp,A,N)}function b(){kt(i)?Et("initAudio: invalid zsAudio lib"):i.init(le,0)}function T(){kt(i)?Et("resetAudio: invalid zsAudio lib"):i.reset()}function I(){n.init()}function P(e){if(!t.isObject(this))return null}function N(t,n){switch(t){case e.OPEN:h(n);break;case e.CLOSED:x(n);break;case e.ERROR:y(n);break;default:Et("Unknown Connection Event State: "+t+" for type: "+n)}}function h(t){At(t+" connection opened."),B(t)}function x(t){At(t+" connection closed."),w(t)}function y(t){At(t+" connection error."),k(t)}function B(t){fe.isConnected=!0,fe.connectionType=t,fe.reconnectAttmpts=0,C(ue.connectedRectStyle,ue.connectedBtnAttrib,ue.connectedTxtStyle,zt)}function w(t){fe.isConnected=!1,C(ue.disconnectedRectStyle,ue.disconnectedBtnAttrib,ue.disconnectedTxtStyle,Vt),E(t)}function k(t){fe.isConnected=!1,C(ue.errorRectStyle,ue.errorBtnAttrib,ue.errorTxtStyle,jt),E(t)}function C(e,n,i,a){var r=t.getElement(ue.idServerStatusRect);kt(r)||Bt(r,e);var o=t.getElement(ue.idServerStatusBtn);kt(o)||wt(o,n);var s=t.getElement(ue.idServerStatusTxt);kt(s)||(Bt(s,i),s.textContent=a)}function E(t){e.reconnect(t,!0)}function A(t,e){fe.isConnected||B(),kt(t)||(e||v(),Ct(t.scoreInfo)&&L(t.scoreInfo),Ct(t.partInfo)&&at(t.partInfo),Ct(t.pageInfo)&&K(t.pageInfo),Ct(t.mapInfo)&&z(t.mapInfo),Ct(t.bpm)&&0!=t.bpm&&O(t.bpm),Ct(t.actions)&&ht(t.actions))}function L(e){t.isObject(e)&&(Ct(e.title)&&R(e.title),Ct(e.instruments)&&St(e.instruments),Ct(e.bpm)&&M(e.bpm),Ct(e.scoreDir)&&D(e.scoreDir))}function R(e){fe.score.title!==e&&(fe.score.title=e,fe.score.noSpaceTitle=t.replaceEmptySpaces(e,Rt),n.setElementText(ue.idTitle,e))}function D(t){fe.scoreDir!==t&&(fe.scoreDir=t)}function M(t){fe.tempo!==t&&(fe.tempo=t,n.setElementText(ue.idTempoBpm,t))}function O(e){var n=t.toInt(e);if(!kt(n)){var i=fe.tempo,a=n/i;fe.tempoModifier=a,M(n),fe.isRunning?Y(a):j()}}function z(e){if(!kt(e.map)&&!kt(e.pageId)){var n=e.pageId,i=e.staveId,a=e.map,r=fe[i];if(!kt(r)){var o=r.config.xLeftMargin,s=JSON.parse(JSON.stringify(a));if(t.isArray(s)){for(var c={},l=0;l<s.length;l++)U(c,s[l],o);fe.part.pageBeatMaps[n]=c,r.beatMap=c,F(i)}}}}function U(t,e,n){if(!(kt(t)||kt(e)||kt(e.beatStartNum))){var i=e.beatStartNum,a=e.xStart+n,r=e.xEnd+n,o=new c(a,r,e.yStart,e.yEnd,e.beatStartNum,e.beatStartDenom,e.beatEndNum,e.beatEndDenom);t[i]=o}}function Y(t){V(fe.topStave.timeline,t),V(fe.bottomStave.timeline,t)}function V(t,e){if(!kt(t)){var n=t.timeScale(),i=n*e;t.timeScale(i)}}function j(){_(fe.topStave),_(fe.bottomStave)}function F(t){kt(t)||_(fe[t])}function _(t){if(!kt(t)){var e=gsap.timeline({onComplete:Z,onCompleteParams:[t.id],paused:!0}),n=t.beatMap;if(!kt(n)){var i=t.config.positionLineId,r=t.config.beatBallId,o=t.config.ballYmax,s=!0;for(var c in n){var l=n[c],d=fe.tempo,p=a.getBeatDurationSec(d),u=l.beatStartNum;if(s){var f=ue.beatIdPrefix+(u-1),g=l.xStart,m=G(i,0,g,f,0);e.add(m,Ft);var v=Q(r,0,g,f);e.add(v,_t),s=!1}g=l.xEnd,f=ue.beatIdPrefix+u;var S=ue.tweenIdPrefix+f,b=G(i,p,g,f,u),T=Q(r,p,g,f),I=W(r,p/2,o,f);S=b.vars.id;e.addLabel(S,_t),e.add(b,_t),e.add(T,Ft),e.add(I,S)}t.timeline=e}}}function G(e,n,i,a,r){var o=ue.tweenIdPrefix+a;return At("createPositionLineTween: "+o),gsap.to(t.toCssIdQuery(e),{id:o,duration:n,attr:{x1:i,x2:i},ease:"none",onStart:q,onStartParams:[a,r],onComplete:H,onCompleteParams:[a,r]})}function Q(e,n,i,a){var r=ue.ballTweenIdPrefix+a;return At("createPositionBallXTween: "+r),gsap.to(t.toCssIdQuery(e),{duration:n,attr:{cx:i},ease:"none"})}function W(e,n,i,a){var r=ue.ballTweenIdPrefix+a;return At("createPositionBallYTween: "+r),gsap.to(t.toCssIdQuery(e),{duration:n,attr:{cy:i,r:2},ease:"power1.out",autoAlpha:.5,repeat:1,yoyo:!0})}function Z(t){At("onTimelineComplete stave: "+t);var e=fe[t];Ct(e)&&(e.isRunning=!1)}function q(t,e){var n=i.getCurrentTime();fe.audioTlBeatTime=n,At("onBeatStart: beat: "+t+" beatNo: "+e+" beatTime: "+n),J(e,t)}function H(t,e){var n=i.getCurrentTime(),a=n-fe.startTimeTl;At("onBeatEnd: beat: "+t+" beatNo: "+e+" elapsedTime: "+a)}function J(e,n){t.isNumeric(e)&&(t.isNull(n)&&(n=ue.beatIdPrefix+e),fe.currentBeatId=n,fe.currentBeatNo=e)}function K(t){if(!kt(t.staveId)){var e=t.staveId,n=fe[e];kt(n)?Et("processPageinfo: Invalid stave for id: {}",e):(Ct(t.filename)&&(n.filename=t.filename),Ct(t.pageId)&&(n.pageId=t.pageId),X(n))}}function X(e){if(!kt(e)){var n=e.config;if(!kt(n)){var i=null,a=tt(e.pageId);i=kt(a)?$(e.fileName):a.src;var r=t.getElement(n.imgId);r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),r.setAttribute("href",i)}}}function $(t){return fe.scoreDir+fe.score.noSpaceTitle+Dt+t}function tt(t){var e=fe.part.pages[t];return kt(e)?null:e.img}function et(t){var e=fe.part.pages[t];Ct(e)&&(e.isLoaded=!0),fe.pageNoToLoad--,0===fe.pageNoToLoad&&it(),nt(fe.pageNoToLoad)}function nt(t){if(t>0){var e=Ut+" "+t;C(ue.errorRectStyle,ue.errorBtnAttrib,ue.errorTxtStyle,e)}else C(ue.connectedRectStyle,ue.connectedBtnAttrib,ue.connectedTxtStyle,Yt)}function it(){At("onPageLoadComplete: ");var t=fe.part.pages,e=!0;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i.isLoaded||(At("onPageLoadComplete: page: "+n+" is not loaded, retying load"),lt(i.no),e=!1)}e&&(At("All Pages loaded: "),fe.isReady=!0,Pt())}function at(e){if(Ct(e.name)&&(fe.part.name=e.name,n.setElementText(ue.idInstrument,e.name)),Ct(e.pageRanges)){var i=e.pageRanges;if(t.isArray(i))for(var a=0;a<i.length;a++)vt(i[a]);else vt(i)}Ct(e.imgDir)&&(fe.part.imgDir=e.imgDir),Ct(e.imgPageNameToken)&&(fe.part.imgPageNameToken=e.imgPageNameToken),Ct(e.imgContPageName)&&(fe.part.imgContPageName=e.imgContPageName),Ct(e.contPageNo)&&(fe.part.contPageNo=e.contPageNo),rt()}function rt(){var e=fe.part,n=e.pageRanges;if(t.isArray(n)){for(var i=0;i<n.length;i++)ct(n[i]);ot(),st()}}function ot(){var t=ft();fe.pageNoToLoad++,dt(t)}function st(){var t=ut();fe.pageNoToLoad++,dt(t)}function ct(e){if(t.isObject(e)){var n=1,i=1;Ct(e.start)&&(n=t.toInt(e.start)),Ct(e.end)&&(i=t.toInt(e.end));var a=fe.pageNoToLoad+(i-n+1);fe.pageNoToLoad=a;for(var r=n;r<=i;r++)lt(r)}}function lt(t){var e=pt(t);dt(e)}function dt(t){if(!kt(t)){var e=t.imgFileUrl;kt(e)||t.loadImg(e,t.id)}}function pt(e){var n=mt(e),i=fe.part.pages[n];if(Ct(i))return i;var a=fe.part.imgPageNameToken;a=kt(a)?gt(e):t.replace(a,ue.pageNoToken,""+e);var r=fe.part.imgDir+a;i=new l(n,e,a,r);return fe.part.pages[n]=i,i}function ut(){var t=fe.part.contPageNo,e=mt(t),n=fe.part.pages[e];if(Ct(n))return n;var i=fe.part.imgContPageName,a=fe.part.imgDir+i;n=new l(e,t,i,a);return fe.part.pages[e]=n,n}function ft(){var t=fe.part.blankPageNo,e=mt(t),n=fe.part.pages[e];if(Ct(n))return n;var i=ue.blankPageUrl,a=ue.blankPageUrl;n=new l(e,t,i,a);return fe.part.pages[e]=n,n}function gt(t){return fe.score.noSpaceTitle+Rt+instrumentName+"_page"+t+".png"}function mt(t){return ue.pageIdPrefix+t}function vt(t){if(!(kt(t)||kt(t.start)||kt(t.end))){var e=t.start,n=t.end,i={start:e,end:n};fe.part.pageRanges=[],fe.part.pageRanges.push(i)}}function St(e){var n=[];t.isArray(e)?n=e:n.push(e),t.arrEquals(fe.score.parts,n)||(fe.score.parts=n),bt(n)?It(fe.part.name):Tt(n)}function bt(e){if(kt(fe.part.name)||!t.isArray(e))return!1;for(var n=fe.part.name,i=0;i<e.length;i++)if(n===e[i])return!0;return!1}function Tt(e){var n=t.getElement(ue.idParts);if(!kt(n)){t.removeElementChildren(n);for(var i=0;i<e.length;i++){var a=e[i];if(!t.arrContains(ue.filterOutParts,a)){var r=new d(i+1,a),o=t.createDiv(),s=t.createButton(r);t.setText(s,a),t.addChildToParent(o,s),t.addChildToParent(n,o)}}t.makeVisible(ue.idPartsListOuterDiv)}}function It(t){var n=new p;n[se]=t,e.sendEvent(ae,n)}function Pt(){var t=new p;t[se]=fe.part.name,e.sendEvent(re,t)}function Nt(t){var n=new p;n[ce]=t,e.sendEvent(oe,n)}function ht(e){var n=null,i=[],a={};if(t.isArray(e))for(var r=0;r<e.length;r++){var o=e[r];Ct(o.type)&&(n=o.type),Ct(o.targets)&&(i=o.targets),Ct(o.params)&&(a=o.params),xt(n,i,a)}}function xt(e,n,i){if(t.logDebug("doAction: "+e),!kt(e))switch(e){case"PING":yt(i);break;default:Et("doAction: Unknown actionType: "+e)}}function yt(e){t.isObject(e)&&Ct(e.sendTimeMs)&&Nt(e.sendTimeMs)}function Bt(e,n){t.setElementStyleProperty(e,n)}function wt(e,n){t.setElementAttributes(e,n)}function kt(e){return t.isNull(e)}function Ct(e){return t.isNotNull(e)}function Et(e){t.logError(e)}function At(e){t.log(e)}const Lt="dev",Rt="_",Dt="/",Mt="AV",Ot="FullScore",zt="Connected",Ut="Loading",Yt="READY",Vt="Reconnecting",jt="Error",Ft="<",_t=">",Gt="green",Qt="red",Wt="orange",Zt="white",qt="black",Ht=Gt,Jt=Qt,Kt=Wt,Xt=Gt,$t=Qt,te=Wt,ee=Zt,ne=Zt,ie=qt,ae="PART_REG",re="PART_READY",oe="PING",se="part",ce="serverTime";var le=["/audio/violin-tuning.mp3"],de=null,pe=null,ue={connectionPreference:"ws,sse,poll",defaultConnectionType:e.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",blankPageUrl:"img/blankStave.png",filterOutParts:[Mt,Ot],connectedRectStyle:{fill:Ht,stroke:Xt,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:Jt,stroke:$t,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:Kt,stroke:te,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:ee},disconnectedTxtStyle:{fill:ne},errorTxtStyle:{fill:ie},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"},topStave:{gId:"stvTop",imgId:"stvTopImg",startLineId:"stvTopStartLine",positionLineId:"stvTopPosLine",beatBallId:"stvTopBeatBall",maskId:"stvTopMask",ballYmax:84,xLeftMargin:31.5},bottomStave:{gId:"stvBot",imgId:"stvBotImg",startLineId:"stvBotStartLine",positionLineId:"stvBotPosLine",beatBallId:"stvBotBeatBall",maskId:"stvBotMask",ballYmax:84,xLeftMargin:31.5}},fe={isRunning:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,blankPageNo:0,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{},pageBeatMaps:{}},topStave:{id:"topStave",config:ue.topStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!0,isRunning:!1},bottomStave:{id:"bottomStave",config:ue.bottomStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!1,isRunning:!1},startTimeTl:0,currentBeatId:"b0",currentBeatNo:0,tempo:0,tempoModifier:1,scoreDir:"/score/",currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return l.prototype.loadImg=function(t){this.img.src=t,this.img.onload=function(){At("pageImgOnLoad: id: "+this.pageId),et(this.pageId)}},{onStateBtn:function(){f()},onPartSelect:function(t){g(t)},onInstrumentSelect:function(t){m(t)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);