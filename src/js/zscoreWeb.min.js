var zscore=function(e,t,n,i,a,r,o){"use strict";function s(e){this.message=e,this.name="ZScoreException"}function c(e,t,n,i){this.id=e,this.no=t,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=e}function l(e,t){this.id="partBtn"+e,this.class="partListButton",this.onclick="onPartSelect('"+t+"')"}function d(){}function p(){if(!Ge.isInitialised){if(!(e&&t&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");e.setRunMode(pe),de("init: "),je=e.isTouchDevice(),Fe=e.isSafari(navigator),de("init: IsTouch Device: "+je+" isSafari: "+Fe),Ge.fontCanvas=o.createElement("canvas"),Ge.canvasCtx=Ge.fontCanvas.getContext("2d"),e.listen("resize",r,b),e.listen("orientationchange",r,b),v(),P(),S(),Ge.isInitialised=!0}}function u(){Ge.isInitialised?(de("onStateBtnClick: zscore initialised"),t.isConnected()||(de("onStateBtnClick: zscore not connected, reconnecting..."),R())):(de("onStateBtnClick: initialising"),p())}function f(t){e.arrContains(Ge.score.parts,t)?(Ge.part.name=t,$(t),e.makeInVisible(_e.idPartsListOuterDiv)):de("onPartSelection: unexpected part: "+t)}function g(e){}function m(){T()}function v(){t.init(_e.connectionPreference,_e.appUrlSse,_e.appUrlWebsockets,_e.appUrlHttp,x,y)}function S(){se(i)?le("initAudio: invalid zsAudio lib"):i.init(Ve,0)}function T(){se(i)?le("resetAudio: invalid zsAudio lib"):i.reset()}function P(){n.init()}function b(t){if(!e.isObject(this))return null}function y(e,n){switch(e){case t.OPEN:h(n);break;case t.CLOSED:I(n);break;case t.ERROR:N(n);break;default:le("Unknown Connection Event State: "+e+" for type: "+n)}}function h(e){de(e+" connection opened."),k(e)}function I(e){de(e+" connection closed."),w(e)}function N(e){de(e+" connection error."),B(e)}function k(e){Ge.isConnected=!0,Ge.connectionType=e,Ge.reconnectAttmpts=0,C(_e.connectedRectStyle,_e.connectedBtnAttrib,_e.connectedTxtStyle,me)}function w(e){Ge.isConnected=!1,C(_e.disconnectedRectStyle,_e.disconnectedBtnAttrib,_e.disconnectedTxtStyle,Te),R(e)}function B(e){Ge.isConnected=!1,C(_e.errorRectStyle,_e.errorBtnAttrib,_e.errorTxtStyle,Pe),R(e)}function C(t,n,i,a){var r=e.getElement(_e.idServerStatusRect);se(r)||re(r,t);var o=e.getElement(_e.idServerStatusBtn);se(o)||oe(o,n);var s=e.getElement(_e.idServerStatusTxt);se(s)||(re(s,i),s.textContent=a)}function R(e){t.reconnect(e,!0)}function x(e,t){Ge.isConnected||k(),se(e)||(t||m(),ce(e.scoreInfo)&&A(e.scoreInfo),ce(e.partInfo)&&V(e.partInfo),ce(e.pageInfo)&&z(e.pageInfo),ce(e.actions)&&ne(e.actions))}function A(t){e.isObject(t)&&(ce(t.title)&&E(t.title),ce(t.instruments)&&J(t.instruments),ce(t.bpm)&&L(t.bpm),ce(t.scoreDir)&&D(t.scoreDir))}function E(t){Ge.score.title!==t&&(Ge.score.title=t,Ge.score.noSpaceTitle=e.replaceEmptySpaces(t,ue),n.setElementText(_e.idTitle,t))}function D(e){Ge.scoreDir!==e&&(Ge.scoreDir=e)}function L(e){Ge.tempo!==e&&(Ge.tempo=e,n.setElementText(_e.idTempoBpm,e))}function z(e){if(!se(e.staveId))e.staveId}function O(e){var t=Ge.part.pages[e];ce(t)&&(t.isLoaded=!0),Ge.pageNoToLoad--,0===Ge.pageNoToLoad&&M(),U(Ge.pageNoToLoad)}function U(e){if(e>0){var t=ve+" "+e;C(_e.errorRectStyle,_e.errorBtnAttrib,_e.errorTxtStyle,t)}else C(_e.connectedRectStyle,_e.connectedBtnAttrib,_e.connectedTxtStyle,Se)}function M(){de("onPageLoadComplete: ");var e=Ge.part.pages,t=!0;for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];i.isLoaded||(de("onPageLoadComplete: page: "+n+" is not loaded, retying load"),G(i.no),t=!1)}t&&(de("All Pages loaded: "),Ge.isReady=!0,ee())}function V(t){if(ce(t.name)&&(Ge.part.name=t.name,n.setElementText(_e.idInstrument,t.name)),ce(t.pageRanges)){var i=t.pageRanges;if(e.isArray(i))for(var a=0;a<i.length;a++)K(i[a]);else K(i)}ce(t.imgDir)&&(Ge.part.imgDir=t.imgDir),ce(t.imgPageNameToken)&&(Ge.part.imgPageNameToken=t.imgPageNameToken),ce(t.imgContPageName)&&(Ge.part.imgContPageName=t.imgContPageName),ce(t.contPageNo)&&(Ge.part.contPageNo=t.contPageNo),j()}function j(){var t=Ge.part,n=t.pageRanges;if(e.isArray(n)){for(var i=0;i<n.length;i++)_(n[i]);F()}}function F(){var e=Z();Ge.pageNoToLoad++,W(e)}function _(t){if(e.isObject(t)){var n=1,i=1;ce(t.start)&&(n=e.toInt(t.start)),ce(t.end)&&(i=e.toInt(t.end));var a=Ge.pageNoToLoad+(i-n+1);Ge.pageNoToLoad=a;for(var r=n;r<=i;r++)G(r)}}function G(e){var t=Y(e);W(t)}function W(e){if(!se(e)){var t=e.imgFileUrl;se(t)||e.loadImg(t,e.id)}}function Y(t){var n=H(t),i=Ge.part.pages[n];if(ce(i))return i;var a=Ge.part.imgPageNameToken;a=se(a)?q(t):e.replace(a,_e.pageNoToken,""+t);var r=Ge.part.imgDir+a;i=new c(n,t,a,r);return Ge.part.pages[n]=i,i}function Z(){var e=Ge.part.contPageNo,t=H(e),n=Ge.part.pages[t];if(ce(n))return n;var i=Ge.part.imgContPageName,a=Ge.part.imgDir+i;n=new c(t,e,i,a);return Ge.part.pages[t]=n,n}function q(e){return Ge.score.noSpaceTitle+ue+instrumentName+"_page"+e+".png"}function H(e){return _e.pageIdPrefix+e}function K(e){if(!(se(e)||se(e.start)||se(e.end))){var t=e.start,n=e.end,i={start:t,end:n};Ge.part.pageRanges=[],Ge.part.pageRanges.push(i)}}function J(t){var n=[];e.isArray(t)?n=t:n.push(t),e.arrEquals(Ge.score.parts,n)||(Ge.score.parts=n),Q(n)?$(Ge.part.name):X(n)}function Q(t){if(se(Ge.part.name)||!e.isArray(t))return!1;for(var n=Ge.part.name,i=0;i<t.length;i++)if(n===t[i])return!0;return!1}function X(t){var n=e.getElement(_e.idParts);if(!se(n)){e.removeElementChildren(n);for(var i=0;i<t.length;i++){var a=t[i];if(!e.arrContains(_e.filterOutParts,a)){var r=new l(i+1,a),o=e.createDiv(),s=e.createButton(r);e.setText(s,a),e.addChildToParent(o,s),e.addChildToParent(n,o)}}e.makeVisible(_e.idPartsListOuterDiv)}}function $(e){var n=new d;n[Ue]=e,t.sendEvent(Le,n)}function ee(){var e=new d;e[Ue]=Ge.part.name,t.sendEvent(ze,e)}function te(e){var n=new d;n[Me]=e,t.sendEvent(Oe,n)}function ne(t){var n=null,i=[],a={};if(e.isArray(t))for(var r=0;r<t.length;r++){var o=t[r];ce(o.type)&&(n=o.type),ce(o.targets)&&(i=o.targets),ce(o.params)&&(a=o.params),ie(n,i,a)}}function ie(t,n,i){if(e.logDebug("doAction: "+t),!se(t))switch(t){case"PING":ae(i);break;default:le("doAction: Unknown actionType: "+t)}}function ae(t){e.isObject(t)&&ce(t.sendTimeMs)&&te(t.sendTimeMs)}function re(t,n){e.setElementStyleProperty(t,n)}function oe(t,n){e.setElementAttributes(t,n)}function se(t){return e.isNull(t)}function ce(t){return e.isNotNull(t)}function le(t){e.logError(t)}function de(t){e.log(t)}const pe="DEV",ue="_",fe="AV",ge="FullScore",me="Connected",ve="Loading",Se="READY",Te="Reconnecting",Pe="Error",be="green",ye="red",he="orange",Ie="white",Ne="black",ke=be,we=ye,Be=he,Ce=be,Re=ye,xe=he,Ae=Ie,Ee=Ie,De=Ne,Le="PART_REG",ze="PART_READY",Oe="PING",Ue="part",Me="serverTime";var Ve=["/audio/violin-tuning.mp3"],je=null,Fe=null,_e={connectionPreference:"ws,sse,poll",defaultConnectionType:t.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",filterOutParts:[fe,ge],connectedRectStyle:{fill:ke,stroke:Ce,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:we,stroke:Re,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:Be,stroke:xe,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:Ae},disconnectedTxtStyle:{fill:Ee},errorTxtStyle:{fill:De},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"}},Ge={isRunning:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{}},topStave:{pageId:"0",filename:"img/blankStave.png",timeSpaceMap:{}},bottomStave:{pageId:"0",filename:"img/blankStave.png",timeSpaceMap:{}},tsBaseBeatMaps:{},startTimeTl:0,currentBeatId:"b0",tempo:0,scoreDir:"/score/",topStaveTimeline:{},bottomStaveTimeline:{},lastTimelineBeatNo:0,currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return c.prototype.loadImg=function(e){this.img.src=e,this.img.onload=function(){de("pageImgOnLoad: id: "+this.pageId),O(this.pageId)}},{onStateBtn:function(){u()},onPartSelect:function(e){f(e)},onInstrumentSelect:function(e){g(e)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);