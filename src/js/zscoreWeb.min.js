var zscore=function(t,e,n,i,a,r,o){"use strict";function s(t){this.message=t,this.name="ZScoreException"}function c(t,e,n,i,a,r,o,s){this.xStart=t,this.xEnd=e,this.yStart=n,this.yEnd=i,this.beatStartNum=a,this.beatStartDenom=r,this.beatEndNum=o,this.beatEndDenom=s}function l(t,e,n,i){this.id=t,this.no=e,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=t}function f(t,e){this.id="partBtn"+t,this.class="partListButton",this.onclick="onPartSelect('"+e+"')"}function u(){}function d(){if(!Qe.isInitialised){if(!(t&&e&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");t.setRunMode(te),Xt("init: "),je=t.isTouchDevice(),He=t.isSafari(navigator),Xt("init: IsTouch Device: "+je+" isSafari: "+He),Qe.fontCanvas=o.createElement("canvas"),Qe.canvasCtx=Qe.fontCanvas.getContext("2d"),t.listen("resize",r,x),t.listen("orientationchange",r,x),I(),P(),T(),Qe.isInitialised=!0}}function p(){m(Qe.topStave),m(Qe.bottomStave)}function m(e){if(!qt(e)&&!qt(e.config)){var n=e.config;t.setElementIdAttributes(n.positionLineId,n.posLineConf),t.setElementIdAttributes(n.beatBallId,n.posBallConf)}}function g(){Qe.isInitialised?(Xt("onStateBtnClick: zscore initialised"),e.isConnected()||(Xt("onStateBtnClick: zscore not connected, reconnecting..."),L())):(Xt("onStateBtnClick: initialising"),d())}function v(e){t.arrContains(Qe.score.parts,e)?(Qe.part.name=e,Pt(e),t.makeInVisible(Ge.idPartsListOuterDiv)):Xt("onPartSelection: unexpected part: "+e)}function S(t){}function b(){y()}function I(){e.init(Ge.connectionPreference,Ge.appUrlSse,Ge.appUrlWebsockets,Ge.appUrlHttp,R,h)}function T(){qt(i)?Kt("initAudio: invalid zsAudio lib"):i.init(_e,0)}function y(){qt(i)?Kt("resetAudio: invalid zsAudio lib"):i.reset()}function P(){n.init()}function x(e){if(!t.isObject(this))return null}function h(t,n){switch(t){case e.OPEN:B(n);break;case e.CLOSED:k(n);break;case e.ERROR:N(n);break;default:Kt("Unknown Connection Event State: "+t+" for type: "+n)}}function B(t){Xt(t+" connection opened."),C(t)}function k(t){Xt(t+" connection closed."),E(t)}function N(t){Xt(t+" connection error."),w(t)}function C(t){Qe.isConnected=!0,Qe.connectionType=t,Qe.reconnectAttmpts=0,A(Ge.connectedRectStyle,Ge.connectedBtnAttrib,Ge.connectedTxtStyle,re)}function E(t){Qe.isConnected=!1,A(Ge.disconnectedRectStyle,Ge.disconnectedBtnAttrib,Ge.disconnectedTxtStyle,ce),L(t)}function w(t){Qe.isConnected=!1,A(Ge.errorRectStyle,Ge.errorBtnAttrib,Ge.errorTxtStyle,le),L(t)}function A(e,n,i,a){var r=t.getElement(Ge.idServerStatusRect);qt(r)||Wt(r,e);var o=t.getElement(Ge.idServerStatusBtn);qt(o)||Zt(o,n);var s=t.getElement(Ge.idServerStatusTxt);qt(s)||(Wt(s,i),s.textContent=a)}function L(t){e.reconnect(t,!0)}function R(t,e){Qe.isConnected||C(),qt(t)||(e||b(),Jt(t.scoreInfo)&&D(t.scoreInfo),Jt(t.partInfo)&&ot(t.partInfo),Jt(t.pageInfo)&&$(t.pageInfo),Jt(t.mapInfo)&&V(t.mapInfo),Jt(t.bpm)&&0!=t.bpm&&U(t.bpm),Jt(t.actions)&&Bt(t.actions))}function D(e){t.isObject(e)&&(Jt(e.title)&&O(e.title),Jt(e.instruments)&&It(e.instruments),Jt(e.bpm)&&z(e.bpm),Jt(e.scoreDir)&&M(e.scoreDir))}function O(e){Qe.score.title!==e&&(Qe.score.title=e,Qe.score.noSpaceTitle=t.replaceEmptySpaces(e,ee),n.setElementText(Ge.idTitle,e))}function M(t){Qe.scoreDir!==t&&(Qe.scoreDir=t)}function z(t){Qe.tempo!==t&&(Qe.tempo=t,n.setElementText(Ge.idTempoBpm,t))}function U(e){var n=t.toInt(e);if(!qt(n)){var i=Qe.tempo,a=n/i;Qe.tempoModifier=a,z(n),Qe.isPlaying?Y(a):j()}}function V(e){if(!qt(e.map)&&!qt(e.pageId)){var n=e.pageId,i=e.staveId,a=e.map,r=Qe[i];if(!qt(r)){var o=r.config.xLeftMargin,s=JSON.parse(JSON.stringify(a));if(t.isArray(s)){for(var c={},l=0;l<s.length;l++)F(c,s[l],o);Qe.part.pageBeatMaps[n]=c,r.beatMap=c,H(i)}}}}function F(t,e,n){if(!(qt(t)||qt(e)||qt(e.beatStartNum))){var i=e.beatStartNum,a=e.xStart+n,r=e.xEnd+n,o=new c(a,r,e.yStart,e.yEnd,e.beatStartNum,e.beatStartDenom,e.beatEndNum,e.beatEndDenom);t[i]=o}}function Y(t){_(Qe.topStave.timeline,t),_(Qe.bottomStave.timeline,t)}function _(t,e){if(!qt(t)){var n=t.timeScale(),i=n*e;t.timeScale(i)}}function j(){G(Qe.topStave),G(Qe.bottomStave)}function H(t){qt(t)||G(Qe[t])}function G(t){if(!qt(t)){var e=gsap.timeline({onComplete:q,onCompleteParams:[t.id],paused:!0}),n=t.beatMap;if(!qt(n)){var i=t.config.positionLineId,r=t.config.beatBallId,o=t.config.ballYmax,s=!0;for(var c in n){var l=n[c],f=Qe.tempo,u=a.getBeatDurationSec(f),d=l.beatStartNum;if(s){var p=Ge.beatIdPrefix+(d-1),m=l.xStart,g=Q(i,0,m,p,0);e.add(g,fe);var v=W(r,0,m,p);e.add(v,ue),s=!1}m=l.xEnd,p=Ge.beatIdPrefix+d;var S=Ge.tweenIdPrefix+p,b=Q(i,u,m,p,d),I=W(r,u,m,p),T=Z(r,u/2,o,p);S=b.vars.id;e.addLabel(S,ue),e.add(b,ue),e.add(I,fe),e.add(T,S)}Jt(t.currentBeat)&&wt(e,t.currentBeat),t.timeline=e}}}function Q(e,n,i,a,r){var o=Ge.tweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:o,duration:n,attr:{x1:i,x2:i},ease:"none",onStart:J,onStartParams:[a,r],onComplete:K,onCompleteParams:[a,r]})}function W(e,n,i,a){var r=Ge.ballTweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:r,duration:n,attr:{cx:i},ease:"none"})}function Z(e,n,i,a){var r=Ge.ballTweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:r,duration:n,attr:{cy:i,r:2},ease:"power1.out",autoAlpha:.5,repeat:1,yoyo:!0})}function q(t){$t("onTimelineComplete stave: "+t);var e=Qe[t];Jt(e)&&(e.isRunning=!1),Jt(e.timeline)&&e.timeline.pause(0)}function J(t,e){var n=i.getCurrentTime();Qe.audioTlBeatTime=n,$t("onBeatStart: beat: "+t+" beatNo: "+e+" beatTime: "+n),X(e,t)}function K(t,e){var n=i.getCurrentTime(),a=n-Qe.startTimeTl;$t("onBeatEnd: beat: "+t+" beatNo: "+e+" elapsedTime: "+a)}function X(e,n){t.isNumeric(e)&&(t.isNull(n)&&(n=Ge.beatIdPrefix+e),Qe.currentBeatId=n,Qe.currentBeatNo=e)}function $(t){if(!qt(t.staveId)){var e=t.staveId,n=Qe[e];qt(n)?Kt("processPageinfo: Invalid stave for id: {}",e):(Jt(t.filename)&&(n.filename=t.filename),Jt(t.pageId)&&(n.pageId=t.pageId),tt(n))}}function tt(e){if(!qt(e)){var n=e.config;if(!qt(n)){var i=null,a=nt(e.pageId);i=qt(a)?et(e.fileName):a.src;var r=t.getElement(n.imgId);r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),r.setAttribute("href",i)}}}function et(t){return Qe.scoreDir+Qe.score.noSpaceTitle+ne+t}function nt(t){var e=Qe.part.pages[t];return qt(e)?null:e.img}function it(t){var e=Qe.part.pages[t];Jt(e)&&(e.isLoaded=!0),Qe.pageNoToLoad--,0===Qe.pageNoToLoad&&rt(),at(Qe.pageNoToLoad)}function at(t){if(t>0){var e=oe+" "+t;A(Ge.errorRectStyle,Ge.errorBtnAttrib,Ge.errorTxtStyle,e)}else A(Ge.connectedRectStyle,Ge.connectedBtnAttrib,Ge.connectedTxtStyle,se)}function rt(){Xt("onPageLoadComplete: ");var t=Qe.part.pages,e=!0;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i.isLoaded||(Xt("onPageLoadComplete: page: "+n+" is not loaded, retying load"),ut(i.no),e=!1)}e&&(Xt("All Pages loaded: "),Qe.isReady=!0,xt())}function ot(e){if(Jt(e.name)&&(Qe.part.name=e.name,n.setElementText(Ge.idInstrument,e.name)),Jt(e.pageRanges)){var i=e.pageRanges;if(t.isArray(i))for(var a=0;a<i.length;a++)bt(i[a]);else bt(i)}Jt(e.imgDir)&&(Qe.part.imgDir=e.imgDir),Jt(e.imgPageNameToken)&&(Qe.part.imgPageNameToken=e.imgPageNameToken),Jt(e.imgContPageName)&&(Qe.part.imgContPageName=e.imgContPageName),Jt(e.contPageNo)&&(Qe.part.contPageNo=e.contPageNo),st()}function st(){var e=Qe.part,n=e.pageRanges;if(t.isArray(n)){for(var i=0;i<n.length;i++)ft(n[i]);ct(),lt()}}function ct(){var t=gt();Qe.pageNoToLoad++,dt(t)}function lt(){var t=mt();Qe.pageNoToLoad++,dt(t)}function ft(e){if(t.isObject(e)){var n=1,i=1;Jt(e.start)&&(n=t.toInt(e.start)),Jt(e.end)&&(i=t.toInt(e.end));var a=Qe.pageNoToLoad+(i-n+1);Qe.pageNoToLoad=a;for(var r=n;r<=i;r++)ut(r)}}function ut(t){var e=pt(t);dt(e)}function dt(t){if(!qt(t)){var e=t.imgFileUrl;qt(e)||t.loadImg(e,t.id)}}function pt(e){var n=St(e),i=Qe.part.pages[n];if(Jt(i))return i;var a=Qe.part.imgPageNameToken;a=qt(a)?vt(e):t.replace(a,Ge.pageNoToken,""+e);var r=Qe.part.imgDir+a;i=new l(n,e,a,r);return Qe.part.pages[n]=i,i}function mt(){var t=Qe.part.contPageNo,e=St(t),n=Qe.part.pages[e];if(Jt(n))return n;var i=Qe.part.imgContPageName,a=Qe.part.imgDir+i;n=new l(e,t,i,a);return Qe.part.pages[e]=n,n}function gt(){var t=Qe.part.blankPageNo,e=St(t),n=Qe.part.pages[e];if(Jt(n))return n;var i=Ge.blankPageUrl,a=Ge.blankPageUrl;n=new l(e,t,i,a);return Qe.part.pages[e]=n,n}function vt(t){return Qe.score.noSpaceTitle+ee+instrumentName+"_page"+t+".png"}function St(t){return Ge.pageIdPrefix+t}function bt(t){if(!(qt(t)||qt(t.start)||qt(t.end))){var e=t.start,n=t.end,i={start:e,end:n};Qe.part.pageRanges=[],Qe.part.pageRanges.push(i)}}function It(e){var n=[];t.isArray(e)?n=e:n.push(e),t.arrEquals(Qe.score.parts,n)||(Qe.score.parts=n),Tt(n)?Pt(Qe.part.name):yt(n)}function Tt(e){if(qt(Qe.part.name)||!t.isArray(e))return!1;for(var n=Qe.part.name,i=0;i<e.length;i++)if(n===e[i])return!0;return!1}function yt(e){var n=t.getElement(Ge.idParts);if(!qt(n)){t.removeElementChildren(n);for(var i=0;i<e.length;i++){var a=e[i];if(!t.arrContains(Ge.filterOutParts,a)){var r=new f(i+1,a),o=t.createDiv(),s=t.createButton(r);t.setText(s,a),t.addChildToParent(o,s),t.addChildToParent(n,o)}}t.makeVisible(Ge.idPartsListOuterDiv)}}function Pt(t){var n=new u;n[ze]=t,e.sendEvent(De,n)}function xt(){var t=new u;t[ze]=Qe.part.name,e.sendEvent(Oe,t)}function ht(t){var n=new u;n[Ue]=t,e.sendEvent(Me,n)}function Bt(e){var n=null,i=[],a={};if(t.isArray(e))for(var r=0;r<e.length;r++){var o=e[r];Jt(o.type)&&(n=o.type),Jt(o.targets)&&(i=o.targets),Jt(o.params)&&(a=o.params),kt(n,i,a)}}function kt(e,n,i){if(t.logDebug("doAction: "+e),!qt(e))switch(e){case"PING":Qt(i);break;case"START":Yt(n);break;case"STOP":Ft();break;case"SEMAPHORE_ON":Dt(i);break;case"SEMAPHORE_OFF":Ot(i);break;case"ACTIVATE":At(n,i);break;case"BEAT":Nt(n,i);break;default:Kt("doAction: Unknown actionType: "+e)}}function Nt(e,n){if(!qt(n)&&!qt(e))if(t.isArray(e))for(var i=0;i<e.length;i++)Ct(e[i],n);else Ct(e,n)}function Ct(t,e){var n=Qe[t],i=e[Ye];Et(n,i)}function Et(t,e){if(!qt(t)&&!qt(e)){var n=i.getCurrentTime();$t("setStaveBeat: stave: "+t.id+" beat: "+e+" time: "+n),wt(t.timeline,e),t.currentBeat=e}}function wt(t,e){if(!qt(t)){var n=Ge.tweenIdPrefix+Ge.beatIdPrefix+e,i=t.labels;n in i?t.seek(n):$t("setTimelineBeat: Invalid beat "+n)}}function At(e,n){if(!qt(n)&&!qt(e))if(t.isArray(e))for(var i=0;i<e.length;i++)Lt(e[i],n);else Lt(e,n)}function Lt(t,e){var n=Qe[t],i=e[Ve],a=e[Fe];Rt(n,i,a)}function Rt(e,n,i){qt(e)||qt(n)||qt(i)||(n?t.setElementIdStyleProperty(e.config.maskId,Ge.activeStaveStyle):t.setElementIdStyleProperty(e.config.maskId,Ge.inactiveStaveStyle),i&&jt(e.timeline))}function Dt(t){qt(t)||zt(t.lightNo,t.colourId)}function Ot(t){qt(t)||Ut(t.lightNo,Te)}function Mt(){Ut(4,Te),Ut(1,pe)}function zt(t,e){var n=Vt(e);Ut(t,n)}function Ut(e,i){if(!qt(e)&&!qt(i))for(var a=t.toInt(e),r=1;r<=a;r++){var o=Ge.idSemaphorePrefix+r;n.setElementColour(o,i)}}function Vt(t){var e;switch(t||(t=1),t){case 4:e=pe;break;case 3:e=me;break;case 2:e=ge;break;case 1:default:e=de}return e}function Ft(){Ht(),Qe.isPlaying=!1,Mt(),p()}function Yt(e){if(t.isArray(e))for(var n=0;n<e.length;n++)_t(e[n]);else _t(e)}function _t(t){if(!qt(t)){var e=Qe[t];if(!qt(e)){var n=e.timeline;qt(n)||(jt(n),Qe.isPlaying=!0)}}}function jt(t){if(qt(t))Kt("startTimeline: invalid timeline");else{var e=t.progress();e>0&&e<1?t.resume():t.play(0)}}function Ht(){Gt(Qe.topStave.timeline),Gt(Qe.bottomStave.timeline),Qe.bottomStave.isPlaying=!1,Qe.topStave.isPlaying=!1}function Gt(t){qt(t)?Kt("stopTimeline: invalid timeline"):t.pause()}function Qt(e){t.isObject(e)&&Jt(e.sendTimeMs)&&ht(e.sendTimeMs)}function Wt(e,n){t.setElementStyleProperty(e,n)}function Zt(e,n){t.setElementAttributes(e,n)}function qt(e){return t.isNull(e)}function Jt(e){return t.isNotNull(e)}function Kt(e){t.logError(e)}function Xt(e){t.log(e)}function $t(e){t.logDebug(e)}const te="dev",ee="_",ne="/",ie="AV",ae="FullScore",re="Connected",oe="Loading",se="READY",ce="Reconnecting",le="Error",fe="<",ue=">",de="green",pe="red",me="orange",ge="yellow",ve="white",Se="black",be="blue",Ie="grey",Te="none",ye=Te,Pe=ve,xe=de,he=pe,Be=me,ke=be,Ne=Ie,Ce=de,Ee=pe,we=me,Ae=ve,Le=ve,Re=Se,De="PART_REG",Oe="PART_READY",Me="PING",ze="part",Ue="serverTime",Ve="isActive",Fe="isPlay",Ye="beatNo";var _e=["/audio/violin-tuning.mp3"],je=null,He=null,Ge={connectionPreference:"ws,sse,poll",defaultConnectionType:e.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",idSemaphorePrefix:"semC",blankPageUrl:"img/blankStave.png",filterOutParts:[ie,ae],connectedRectStyle:{fill:xe,stroke:Ce,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:he,stroke:Ee,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:Be,stroke:we,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:Ae},disconnectedTxtStyle:{fill:Le},errorTxtStyle:{fill:Re},activeStaveStyle:{fill:ye,stroke:ke,"stroke-width":"1px",visibility:"visible",opacity:.5},inactiveStaveStyle:{fill:Pe,stroke:Ne,"stroke-width":"1px",visibility:"visible",opacity:.4},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"},topStave:{gId:"stvTop",imgId:"stvTopImg",startLineId:"stvTopStartLine",positionLineId:"stvTopPosLine",beatBallId:"stvTopBeatBall",maskId:"stvTopMask",ballYmax:84,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"80",x2:"95",y2:"281"},posBallConf:{cx:"95",cy:"110",r:"4"}},bottomStave:{gId:"stvBot",imgId:"stvBotImg",startLineId:"stvBotStartLine",positionLineId:"stvBotPosLine",beatBallId:"stvBotBeatBall",maskId:"stvBotMask",ballYmax:305,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"301",x2:"95",y2:"502"},posBallConf:{cx:"95",cy:"331",r:"4"}}},Qe={isPlaying:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,blankPageNo:0,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{},pageBeatMaps:{}},topStave:{id:"topStave",config:Ge.topStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!0,isPlaying:!1,currentBeat:null},bottomStave:{id:"bottomStave",config:Ge.bottomStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!1,isPlaying:!1,currentBeat:null},startTimeTl:0,currentBeatId:"b0",currentBeatNo:0,tempo:0,tempoModifier:1,scoreDir:"/score/",currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return l.prototype.loadImg=function(t){this.img.src=t,this.img.onload=function(){Xt("pageImgOnLoad: id: "+this.pageId),it(this.pageId)}},{onStateBtn:function(){g()},onPartSelect:function(t){v(t)},onInstrumentSelect:function(t){S(t)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);