var zscore=function(e,t,n,i,a,r,o){"use strict";function s(e){this.message=e,this.name="ZScoreException"}function c(e,t,n,i,a,r,o,s){this.xStart=e,this.xEnd=t,this.yStart=n,this.yEnd=i,this.beatStartNum=a,this.beatStartDenom=r,this.beatEndNum=o,this.beatEndDenom=s}function l(e,t,n,i){this.id=e,this.no=t,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=e}function f(e,t){this.id="partBtn"+e,this.class="partListButton",this.onclick="onPartSelect('"+t+"')"}function d(){}function u(){if(!Jt.isInitialised){if(!(e&&t&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");e.setRunMode(at),nt("init: "),Wt=e.isTouchDevice(),Zt=e.isSafari(navigator),nt("init: IsTouch Device: "+Wt+" isSafari: "+Zt),Jt.fontCanvas=o.createElement("canvas"),Jt.canvasCtx=Jt.fontCanvas.getContext("2d"),e.listen("resize",r,x),e.listen("orientationchange",r,x),I(),y(),P(),Jt.isInitialised=!0}}function p(){m(Jt.topStave),m(Jt.bottomStave)}function m(t){if(!$e(t)&&!$e(t.config)){var n=t.config;e.setElementIdAttributes(n.positionLineId,n.posLineConf),e.setElementIdAttributes(n.beatBallId,n.posBallConf)}}function g(){Jt.isInitialised?(nt("onStateBtnClick: zscore initialised"),t.isConnected()||(nt("onStateBtnClick: zscore not connected, reconnecting..."),L())):(nt("onStateBtnClick: initialising"),u())}function v(t){e.arrContains(Jt.score.parts,t)?(Jt.part.name=t,ye(t),e.makeInVisible(qt.idPartsListOuterDiv)):nt("onPartSelection: unexpected part: "+t)}function S(e){}function b(){T()}function I(){t.init(qt.connectionPreference,qt.appUrlSse,qt.appUrlWebsockets,qt.appUrlHttp,R,h)}function P(){$e(i)?tt("initAudio: invalid zsAudio lib"):i.init(Qt,0)}function T(){$e(i)?tt("resetAudio: invalid zsAudio lib"):i.reset()}function y(){n.init()}function x(t){if(!e.isObject(this))return null}function h(e,n){switch(e){case t.OPEN:k(n);break;case t.CLOSED:B(n);break;case t.ERROR:N(n);break;default:tt("Unknown Connection Event State: "+e+" for type: "+n)}}function k(e){nt(e+" connection opened."),E(e)}function B(e){nt(e+" connection closed."),C(e)}function N(e){nt(e+" connection error."),A(e)}function E(e){Jt.isConnected=!0,Jt.connectionType=e,Jt.reconnectAttmpts=0,w(qt.connectedRectStyle,qt.connectedBtnAttrib,qt.connectedTxtStyle,lt)}function C(e){Jt.isConnected=!1,w(qt.disconnectedRectStyle,qt.disconnectedBtnAttrib,qt.disconnectedTxtStyle,ut),L(e)}function A(e){Jt.isConnected=!1,w(qt.errorRectStyle,qt.errorBtnAttrib,qt.errorTxtStyle,pt),L(e)}function w(t,n,i,a){var r=e.getElement(qt.idServerStatusRect);$e(r)||Ke(r,t);var o=e.getElement(qt.idServerStatusBtn);$e(o)||Xe(o,n);var s=e.getElement(qt.idServerStatusTxt);$e(s)||(Ke(s,i),s.textContent=a)}function L(e){t.reconnect(e,!0)}function R(e,t){Jt.isConnected||E(),$e(e)||(t||b(),et(e.scoreInfo)&&D(e.scoreInfo),et(e.partInfo)&&oe(e.partInfo),et(e.pageInfo)&&$(e.pageInfo),et(e.mapInfo)&&V(e.mapInfo),et(e.bpm)&&0!=e.bpm&&U(e.bpm),et(e.actions)&&ke(e.actions))}function D(t){e.isObject(t)&&(et(t.title)&&O(t.title),et(t.instruments)&&Ie(t.instruments),et(t.bpm)&&z(t.bpm),et(t.scoreDir)&&M(t.scoreDir))}function O(t){Jt.score.title!==t&&(Jt.score.title=t,Jt.score.noSpaceTitle=e.replaceEmptySpaces(t,rt),n.setElementText(qt.idTitle,t))}function M(e){Jt.scoreDir!==e&&(Jt.scoreDir=e)}function z(e){Jt.tempo!==e&&(Jt.tempo=e,n.setElementText(qt.idTempoBpm,e))}function U(t){var n=e.toInt(t);if(!$e(n)){var i=Jt.tempo,a=n/i;Jt.tempoModifier=a,z(n),Jt.isPlaying?F(a):j()}}function V(t){if(!$e(t.map)&&!$e(t.pageId)){t.pageId;var n=t.staveId,i=t.map,a=Jt[n];if(!$e(a)){var r=a.config.xLeftMargin,o=JSON.parse(JSON.stringify(i));if(e.isArray(o)){for(var s={},c=0;c<o.length;c++)_(s,o[c],r);a.beatMap=s,H(n)}}}}function _(e,t,n){if(!($e(e)||$e(t)||$e(t.beatStartNum))){var i=t.beatStartNum,a=t.xStart+n,r=t.xEnd+n,o=new c(a,r,t.yStart,t.yEnd,i,t.beatStartDenom,t.beatEndNum,t.beatEndDenom);e[i]=o}}function F(e){Y(Jt.topStave.timeline,e),Y(Jt.bottomStave.timeline,e)}function Y(e,t){if(!$e(e)){var n=e.timeScale(),i=n*t;e.timeScale(i)}}function j(){G(Jt.topStave),G(Jt.bottomStave)}function H(e){$e(e)||G(Jt[e])}function G(e){if(!$e(e)){var t=gsap.timeline({onComplete:q,onCompleteParams:[e.id],paused:!0}),n=e.beatMap;if(!$e(n)){var i=e.config.positionLineId,r=e.config.beatBallId,o=e.config.ballYmax,s=!0;for(var c in n){var l=n[c],f=Jt.tempo,d=a.getBeatDurationSec(f),u=l.beatStartNum;if(s){var p=qt.beatIdPrefix+(u-1),m=l.xStart,g=Q(i,0,m,p,0);t.add(g,mt);var v=W(r,0,m,p);t.add(v,gt),s=!1}m=l.xEnd,p=qt.beatIdPrefix+u;var S=qt.tweenIdPrefix+p,b=Q(i,d,m,p,u),I=W(r,d,m,p),P=Z(r,d/2,o,p);S=b.vars.id;t.addLabel(S,gt),t.add(b,gt),t.add(I,mt),t.add(P,S)}et(e.currentBeat)&&De(t,e.currentBeat),e.timeline=t}}}function Q(t,n,i,a,r){var o=qt.tweenIdPrefix+a;return gsap.to(e.toCssIdQuery(t),{id:o,duration:n,attr:{x1:i,x2:i},ease:"none",onStart:J,onStartParams:[a,r],onComplete:K,onCompleteParams:[a,r]})}function W(t,n,i,a){var r=qt.ballTweenIdPrefix+a;return gsap.to(e.toCssIdQuery(t),{id:r,duration:n,attr:{cx:i},ease:"none"})}function Z(t,n,i,a){var r=qt.ballTweenIdPrefix+a;return gsap.to(e.toCssIdQuery(t),{id:r,duration:n,attr:{cy:i,r:2},ease:"power1.out",autoAlpha:.5,repeat:1,yoyo:!0})}function q(e){it("onTimelineComplete stave: "+e);var t=Jt[e];et(t)&&(t.isRunning=!1),et(t.timeline)&&t.timeline.pause(0)}function J(e,t){var n=i.getCurrentTime();Jt.audioTlBeatTime=n,it("onBeatStart: beat: "+e+" beatNo: "+t+" beatTime: "+n),X(t,e)}function K(e,t){var n=i.getCurrentTime(),a=n-Jt.startTimeTl;it("onBeatEnd: beat: "+e+" beatNo: "+t+" elapsedTime: "+a)}function X(t,n){e.isNumeric(t)&&(e.isNull(n)&&(n=qt.beatIdPrefix+t),Jt.currentBeatId=n,Jt.currentBeatNo=t)}function $(e){if(!$e(e.staveId)){var t=e.staveId,n=Jt[t];$e(n)?tt("processPageinfo: Invalid stave for id: {}",t):(et(e.filename)&&(n.filename=e.filename),et(e.pageId)&&(n.pageId=e.pageId),et(e.rndPageId)&&(n.rndPageId=e.rndPageId),ee(n))}}function ee(t){if(!$e(t)){var n=t.config;if(!$e(n)){var i=null,a=t.pageId;et(t.rndPageId)&&(a=t.rndPageId);var r=ne(a);i=$e(r)?te(t.fileName):r.src;var o=e.getElement(n.imgId);o.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),o.setAttribute("href",i)}}}function te(e){return Jt.scoreDir+Jt.score.noSpaceTitle+ot+e}function ne(e){var t=Jt.part.pages[e];return $e(t)?null:t.img}function ie(e){var t=Jt.part.pages[e];et(t)&&(t.isLoaded=!0),Jt.pageNoToLoad--,0===Jt.pageNoToLoad&&re(),ae(Jt.pageNoToLoad)}function ae(e){if(e>0){var t=ft+" "+e;w(qt.errorRectStyle,qt.errorBtnAttrib,qt.errorTxtStyle,t)}else w(qt.connectedRectStyle,qt.connectedBtnAttrib,qt.connectedTxtStyle,dt)}function re(){nt("onPageLoadComplete: ");var e=Jt.part.pages,t=!0;for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];i.isLoaded||(nt("onPageLoadComplete: page: "+n+" is not loaded, retying load"),de(i.no),t=!1)}t&&(nt("All Pages loaded: "),Jt.isReady=!0,xe())}function oe(t){if(et(t.name)&&(Jt.part.name=t.name,n.setElementText(qt.idInstrument,t.name)),et(t.pageRanges)){var i=t.pageRanges;if(e.isArray(i))for(var a=0;a<i.length;a++)be(i[a]);else be(i)}et(t.imgDir)&&(Jt.part.imgDir=t.imgDir),et(t.imgPageNameToken)&&(Jt.part.imgPageNameToken=t.imgPageNameToken),et(t.imgContPageName)&&(Jt.part.imgContPageName=t.imgContPageName),et(t.contPageNo)&&(Jt.part.contPageNo=t.contPageNo),se()}function se(){var t=Jt.part,n=t.pageRanges;if(e.isArray(n)){for(var i=0;i<n.length;i++)fe(n[i]);ce(),le()}}function ce(){var e=ge();Jt.pageNoToLoad++,ue(e)}function le(){var e=me();Jt.pageNoToLoad++,ue(e)}function fe(t){if(e.isObject(t)){var n=1,i=1;et(t.start)&&(n=e.toInt(t.start)),et(t.end)&&(i=e.toInt(t.end));var a=Jt.pageNoToLoad+(i-n+1);Jt.pageNoToLoad=a;for(var r=n;r<=i;r++)de(r)}}function de(e){var t=pe(e);ue(t)}function ue(e){if(!$e(e)){var t=e.imgFileUrl;$e(t)||e.loadImg(t,e.id)}}function pe(t){var n=Se(t),i=Jt.part.pages[n];if(et(i))return i;var a=Jt.part.imgPageNameToken;a=$e(a)?ve(t):e.replace(a,qt.pageNoToken,""+t);var r=Jt.part.imgDir+a;i=new l(n,t,a,r);return Jt.part.pages[n]=i,i}function me(){var e=Jt.part.contPageNo,t=Se(e),n=Jt.part.pages[t];if(et(n))return n;var i=Jt.part.imgContPageName,a=Jt.part.imgDir+i;n=new l(t,e,i,a);return Jt.part.pages[t]=n,n}function ge(){var e=Jt.part.blankPageNo,t=Se(e),n=Jt.part.pages[t];if(et(n))return n;var i=qt.blankPageUrl,a=qt.blankPageUrl;n=new l(t,e,i,a);return Jt.part.pages[t]=n,n}function ve(e){return Jt.score.noSpaceTitle+rt+instrumentName+"_page"+e+".png"}function Se(e){return qt.pageIdPrefix+e}function be(e){if(!($e(e)||$e(e.start)||$e(e.end))){var t=e.start,n=e.end,i={start:t,end:n};Jt.part.pageRanges=[],Jt.part.pageRanges.push(i)}}function Ie(t){var n=[];e.isArray(t)?n=t:n.push(t),e.arrEquals(Jt.score.parts,n)||(Jt.score.parts=n),Pe(n)?ye(Jt.part.name):Te(n)}function Pe(t){if($e(Jt.part.name)||!e.isArray(t))return!1;for(var n=Jt.part.name,i=0;i<t.length;i++)if(n===t[i])return!0;return!1}function Te(t){var n=e.getElement(qt.idParts);if(!$e(n)){e.removeElementChildren(n);for(var i=0;i<t.length;i++){var a=t[i];if(!e.arrContains(qt.filterOutParts,a)){var r=new f(i+1,a),o=e.createDiv(),s=e.createButton(r);e.setText(s,a),e.addChildToParent(o,s),e.addChildToParent(n,o)}}e.makeVisible(qt.idPartsListOuterDiv)}}function ye(e){var n=new d;n[Ft]=e,t.sendEvent(Ut,n)}function xe(){var e=new d;e[Ft]=Jt.part.name,t.sendEvent(Vt,e)}function he(e){var n=new d;n[Yt]=e,t.sendEvent(_t,n)}function ke(t){var n=null,i=[],a={};if(e.isArray(t))for(var r=0;r<t.length;r++){var o=t[r];et(o.type)&&(n=o.type),et(o.targets)&&(i=o.targets),et(o.params)&&(a=o.params),Be(n,i,a)}}function Be(t,n,i){if(e.logDebug("doAction: "+t),!$e(t))switch(t){case"PING":Je(i);break;case"START":Ge(n);break;case"STOP":He();break;case"SEMAPHORE_ON":Ue(i);break;case"SEMAPHORE_OFF":Ve(i);break;case"ACTIVATE":Oe(n,i);break;case"BEAT":we(n,i);break;case"START_MARK":Ne(n,i);break;default:tt("doAction: Unknown actionType: "+t)}}function Ne(t,n){if(!$e(n)&&!$e(t))if(e.isArray(t))for(var i=0;i<t.length;i++)Ee(t[i],n);else Ee(t,n)}function Ee(e,t){var i=Jt[e],a=t[Gt];if(!$e(i)&&!$e(a)){var r=i.beatMap;if(!$e(r)){var o=r[a];if(!$e(o)){var s=o.xStart-1,c=Ce(i);n.setLineX(c,s,s),Ae(c,!0)}}}}function Ce(t){return e.getElement(t.config.startLineId)}function Ae(t,n){n?e.makeElementVisible(t):e.makeElementInVisible(t)}function we(t,n){if(!$e(n)&&!$e(t))if(e.isArray(t))for(var i=0;i<t.length;i++)Le(t[i],n);else Le(t,n)}function Le(e,t){var n=Jt[e],i=t[Gt];Re(n,i)}function Re(e,t){if(!$e(e)&&!$e(t)){var n=i.getCurrentTime();it("setStaveBeat: stave: "+e.id+" beat: "+t+" time: "+n),De(e.timeline,t),e.currentBeat=t}}function De(e,t){if(!$e(e)){var n=qt.tweenIdPrefix+qt.beatIdPrefix+t,i=e.labels;n in i?e.seek(n):it("setTimelineBeat: Invalid beat "+n)}}function Oe(t,n){if(!$e(n)&&!$e(t))if(e.isArray(t))for(var i=0;i<t.length;i++)Me(t[i],n);else Me(t,n)}function Me(e,t){var n=Jt[e],i=t[jt],a=t[Ht];ze(n,i,a)}function ze(t,n,i){if(!($e(t)||$e(n)||$e(i))){if(n)e.setElementIdStyleProperty(t.config.maskId,qt.activeStaveStyle);else{e.setElementIdStyleProperty(t.config.maskId,qt.inactiveStaveStyle);var a=Ce(t);Ae(a,!1)}i&&We(t.timeline)}}function Ue(e){$e(e)||Fe(e.lightNo,e.colourId)}function Ve(e){$e(e)||Ye(e.lightNo,ht)}function _e(){Ye(4,ht),Ye(1,St)}function Fe(e,t){var n=je(t);Ye(e,n)}function Ye(t,i){if(!$e(t)&&!$e(i))for(var a=e.toInt(t),r=1;r<=a;r++){var o=qt.idSemaphorePrefix+r;n.setElementColour(o,i)}}function je(e){var t;switch(e||(e=1),e){case 4:t=St;break;case 3:t=bt;break;case 2:t=It;break;case 1:default:t=vt}return t}function He(){Ze(),Jt.isPlaying=!1,_e(),p()}function Ge(t){if(e.isArray(t))for(var n=0;n<t.length;n++)Qe(t[n]);else Qe(t)}function Qe(e){if(!$e(e)){var t=Jt[e];if(!$e(t)){var n=t.timeline;$e(n)||(We(n),Jt.isPlaying=!0)}}}function We(e){if($e(e))tt("startTimeline: invalid timeline");else{var t=e.progress();t>0&&t<1?e.resume():e.play(0)}}function Ze(){qe(Jt.topStave.timeline),qe(Jt.bottomStave.timeline),Jt.bottomStave.isPlaying=!1,Jt.topStave.isPlaying=!1}function qe(e){$e(e)?tt("stopTimeline: invalid timeline"):e.pause()}function Je(t){e.isObject(t)&&et(t.sendTimeMs)&&he(t.sendTimeMs)}function Ke(t,n){e.setElementStyleProperty(t,n)}function Xe(t,n){e.setElementAttributes(t,n)}function $e(t){return e.isNull(t)}function et(t){return e.isNotNull(t)}function tt(t){e.logError(t)}function nt(t){e.log(t)}function it(t){e.logDebug(t)}const at="dev",rt="_",ot="/",st="AV",ct="FullScore",lt="Connected",ft="Loading",dt="READY",ut="Reconnecting",pt="Error",mt="<",gt=">",vt="green",St="red",bt="orange",It="yellow",Pt="white",Tt="black",yt="blue",xt="grey",ht="none",kt=ht,Bt=Pt,Nt=vt,Et=St,Ct=bt,At=yt,wt=xt,Lt=vt,Rt=St,Dt=bt,Ot=Pt,Mt=Pt,zt=Tt,Ut="PART_REG",Vt="PART_READY",_t="PING",Ft="part",Yt="serverTime",jt="isActive",Ht="isPlay",Gt="beatNo";var Qt=["/audio/violin-tuning.mp3"],Wt=null,Zt=null,qt={connectionPreference:"ws,sse,poll",defaultConnectionType:t.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",idSemaphorePrefix:"semC",blankPageUrl:"img/blankStave.png",filterOutParts:[st,ct],connectedRectStyle:{fill:Nt,stroke:Lt,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:Et,stroke:Rt,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:Ct,stroke:Dt,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:Ot},disconnectedTxtStyle:{fill:Mt},errorTxtStyle:{fill:zt},activeStaveStyle:{fill:kt,stroke:At,"stroke-width":"1px",visibility:"visible",opacity:.5},inactiveStaveStyle:{fill:Bt,stroke:wt,"stroke-width":"1px",visibility:"visible",opacity:.4},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"},topStave:{gId:"stvTop",imgId:"stvTopImg",startLineId:"stvTopStartLine",positionLineId:"stvTopPosLine",beatBallId:"stvTopBeatBall",maskId:"stvTopMask",ballYmax:84,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"80",x2:"95",y2:"281"},posBallConf:{cx:"95",cy:"110",r:"4"}},bottomStave:{gId:"stvBot",imgId:"stvBotImg",startLineId:"stvBotStartLine",positionLineId:"stvBotPosLine",beatBallId:"stvBotBeatBall",maskId:"stvBotMask",ballYmax:305,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"301",x2:"95",y2:"502"},posBallConf:{cx:"95",cy:"331",r:"4"}}},Jt={isPlaying:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,blankPageNo:0,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{}},topStave:{id:"topStave",config:qt.topStave,pageId:"p0",rndPageId:null,filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!0,isPlaying:!1,currentBeat:null},bottomStave:{id:"bottomStave",config:qt.bottomStave,pageId:"p0",rndPageId:null,filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!1,isPlaying:!1,currentBeat:null},startTimeTl:0,currentBeatId:"b0",currentBeatNo:0,tempo:0,tempoModifier:1,scoreDir:"/score/",currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return l.prototype.loadImg=function(e){this.img.src=e,this.img.onload=function(){nt("pageImgOnLoad: id: "+this.pageId),ie(this.pageId)}},{onStateBtn:function(){g()},onPartSelect:function(e){v(e)},onInstrumentSelect:function(e){S(e)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);