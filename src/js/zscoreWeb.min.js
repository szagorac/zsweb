var zscore=function(t,e,n,i,a,o,r){"use strict";function s(t){this.message=t,this.name="ZScoreException"}function c(t,e,n,i,a,o,r,s){this.xStart=t,this.xEnd=e,this.yStart=n,this.yEnd=i,this.beatStartNum=a,this.beatStartDenom=o,this.beatEndNum=r,this.beatEndDenom=s}function l(t,e,n,i){this.id=t,this.no=e,this.imgFileName=n,this.imgFileUrl=i,this.isLoaded=!1,this.img=new Image,this.img.pageId=t}function u(t,e){this.id="partBtn"+t,this.class="partListButton",this.onclick="onPartSelect('"+e+"')"}function d(){}function f(){if(!Ee.isInitialised){if(!(t&&e&&n&&i&&a))throw new s("Invalid libraries. Required: zsUtil, zsNet, zsSvg, zsAudio and zsMusic");t.setRunMode(Wt),Gt("init: "),ke=t.isTouchDevice(),Ce=t.isSafari(navigator),Gt("init: IsTouch Device: "+ke+" isSafari: "+Ce),Ee.fontCanvas=r.createElement("canvas"),Ee.canvasCtx=Ee.fontCanvas.getContext("2d"),t.listen("resize",o,x),t.listen("orientationchange",o,x),T(),y(),I(),Ee.isInitialised=!0}}function p(){m(Ee.topStave),m(Ee.bottomStave)}function m(e){if(!_t(e)&&!_t(e.config)){var n=e.config;t.setElementIdAttributes(n.positionLineId,n.posLineConf),t.setElementIdAttributes(n.beatBallId,n.posBallConf)}}function g(){Ee.isInitialised?(Gt("onStateBtnClick: zscore initialised"),e.isConnected()||(Gt("onStateBtnClick: zscore not connected, reconnecting..."),R())):(Gt("onStateBtnClick: initialising"),f())}function v(e){t.arrContains(Ee.score.parts,e)?(Ee.part.name=e,yt(e),t.makeInVisible(we.idPartsListOuterDiv)):Gt("onPartSelection: unexpected part: "+e)}function S(t){}function b(){P()}function T(){e.init(we.connectionPreference,we.appUrlSse,we.appUrlWebsockets,we.appUrlHttp,L,h)}function I(){_t(i)?Ht("initAudio: invalid zsAudio lib"):i.init(Be,0)}function P(){_t(i)?Ht("resetAudio: invalid zsAudio lib"):i.reset()}function y(){n.init()}function x(e){if(!t.isObject(this))return null}function h(t,n){switch(t){case e.OPEN:N(n);break;case e.CLOSED:B(n);break;case e.ERROR:k(n);break;default:Ht("Unknown Connection Event State: "+t+" for type: "+n)}}function N(t){Gt(t+" connection opened."),C(t)}function B(t){Gt(t+" connection closed."),w(t)}function k(t){Gt(t+" connection error."),E(t)}function C(t){Ee.isConnected=!0,Ee.connectionType=t,Ee.reconnectAttmpts=0,A(we.connectedRectStyle,we.connectedBtnAttrib,we.connectedTxtStyle,Xt)}function w(t){Ee.isConnected=!1,A(we.disconnectedRectStyle,we.disconnectedBtnAttrib,we.disconnectedTxtStyle,ee),R(t)}function E(t){Ee.isConnected=!1,A(we.errorRectStyle,we.errorBtnAttrib,we.errorTxtStyle,ne),R(t)}function A(e,n,i,a){var o=t.getElement(we.idServerStatusRect);_t(o)||Vt(o,e);var r=t.getElement(we.idServerStatusBtn);_t(r)||Yt(r,n);var s=t.getElement(we.idServerStatusTxt);_t(s)||(Vt(s,i),s.textContent=a)}function R(t){e.reconnect(t,!0)}function L(t,e){Ee.isConnected||C(),_t(t)||(e||b(),jt(t.scoreInfo)&&D(t.scoreInfo),jt(t.partInfo)&&rt(t.partInfo),jt(t.pageInfo)&&$(t.pageInfo),jt(t.mapInfo)&&F(t.mapInfo),jt(t.bpm)&&0!=t.bpm&&U(t.bpm),jt(t.actions)&&Nt(t.actions))}function D(e){t.isObject(e)&&(jt(e.title)&&O(e.title),jt(e.instruments)&&Tt(e.instruments),jt(e.bpm)&&z(e.bpm),jt(e.scoreDir)&&M(e.scoreDir))}function O(e){Ee.score.title!==e&&(Ee.score.title=e,Ee.score.noSpaceTitle=t.replaceEmptySpaces(e,Zt),n.setElementText(we.idTitle,e))}function M(t){Ee.scoreDir!==t&&(Ee.scoreDir=t)}function z(t){Ee.tempo!==t&&(Ee.tempo=t,n.setElementText(we.idTempoBpm,t))}function U(e){var n=t.toInt(e);if(!_t(n)){var i=Ee.tempo,a=n/i;Ee.tempoModifier=a,z(n),Ee.isRunning?Y(a):j()}}function F(e){if(!_t(e.map)&&!_t(e.pageId)){var n=e.pageId,i=e.staveId,a=e.map,o=Ee[i];if(!_t(o)){var r=o.config.xLeftMargin,s=JSON.parse(JSON.stringify(a));if(t.isArray(s)){for(var c={},l=0;l<s.length;l++)V(c,s[l],r);Ee.part.pageBeatMaps[n]=c,o.beatMap=c,H(i)}}}}function V(t,e,n){if(!(_t(t)||_t(e)||_t(e.beatStartNum))){var i=e.beatStartNum,a=e.xStart+n,o=e.xEnd+n,r=new c(a,o,e.yStart,e.yEnd,e.beatStartNum,e.beatStartDenom,e.beatEndNum,e.beatEndDenom);t[i]=r}}function Y(t){_(Ee.topStave.timeline,t),_(Ee.bottomStave.timeline,t)}function _(t,e){if(!_t(t)){var n=t.timeScale(),i=n*e;t.timeScale(i)}}function j(){G(Ee.topStave),G(Ee.bottomStave)}function H(t){_t(t)||G(Ee[t])}function G(t){if(!_t(t)){var e=gsap.timeline({onComplete:q,onCompleteParams:[t.id],paused:!0}),n=t.beatMap;if(!_t(n)){var i=t.config.positionLineId,o=t.config.beatBallId,r=t.config.ballYmax,s=!0;for(var c in n){var l=n[c],u=Ee.tempo,d=a.getBeatDurationSec(u),f=l.beatStartNum;if(s){var p=we.beatIdPrefix+(f-1),m=l.xStart,g=Q(i,0,m,p,0);e.add(g,ie);var v=W(o,0,m,p);e.add(v,ae),s=!1}m=l.xEnd,p=we.beatIdPrefix+f;var S=we.tweenIdPrefix+p,b=Q(i,d,m,p,f),T=W(o,d,m,p),I=Z(o,d/2,r,p);S=b.vars.id;e.addLabel(S,ae),e.add(b,ae),e.add(T,ie),e.add(I,S)}t.timeline=e}}}function Q(e,n,i,a,o){var r=we.tweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:r,duration:n,attr:{x1:i,x2:i},ease:"none",onStart:J,onStartParams:[a,o],onComplete:K,onCompleteParams:[a,o]})}function W(e,n,i,a){var o=we.ballTweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:o,duration:n,attr:{cx:i},ease:"none"})}function Z(e,n,i,a){var o=we.ballTweenIdPrefix+a;return gsap.to(t.toCssIdQuery(e),{id:o,duration:n,attr:{cy:i,r:2},ease:"power1.out",autoAlpha:.5,repeat:1,yoyo:!0})}function q(t){Gt("onTimelineComplete stave: "+t);var e=Ee[t];jt(e)&&(e.isRunning=!1),jt(e.timeline)&&e.timeline.pause(0)}function J(t,e){var n=i.getCurrentTime();Ee.audioTlBeatTime=n,Qt("onBeatStart: beat: "+t+" beatNo: "+e+" beatTime: "+n),X(e,t)}function K(t,e){var n=i.getCurrentTime(),a=n-Ee.startTimeTl;Qt("onBeatEnd: beat: "+t+" beatNo: "+e+" elapsedTime: "+a)}function X(e,n){t.isNumeric(e)&&(t.isNull(n)&&(n=we.beatIdPrefix+e),Ee.currentBeatId=n,Ee.currentBeatNo=e)}function $(t){if(!_t(t.staveId)){var e=t.staveId,n=Ee[e];_t(n)?Ht("processPageinfo: Invalid stave for id: {}",e):(jt(t.filename)&&(n.filename=t.filename),jt(t.pageId)&&(n.pageId=t.pageId),tt(n))}}function tt(e){if(!_t(e)){var n=e.config;if(!_t(n)){var i=null,a=nt(e.pageId);i=_t(a)?et(e.fileName):a.src;var o=t.getElement(n.imgId);o.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),o.setAttribute("href",i)}}}function et(t){return Ee.scoreDir+Ee.score.noSpaceTitle+qt+t}function nt(t){var e=Ee.part.pages[t];return _t(e)?null:e.img}function it(t){var e=Ee.part.pages[t];jt(e)&&(e.isLoaded=!0),Ee.pageNoToLoad--,0===Ee.pageNoToLoad&&ot(),at(Ee.pageNoToLoad)}function at(t){if(t>0){var e=$t+" "+t;A(we.errorRectStyle,we.errorBtnAttrib,we.errorTxtStyle,e)}else A(we.connectedRectStyle,we.connectedBtnAttrib,we.connectedTxtStyle,te)}function ot(){Gt("onPageLoadComplete: ");var t=Ee.part.pages,e=!0;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i.isLoaded||(Gt("onPageLoadComplete: page: "+n+" is not loaded, retying load"),dt(i.no),e=!1)}e&&(Gt("All Pages loaded: "),Ee.isReady=!0,xt())}function rt(e){if(jt(e.name)&&(Ee.part.name=e.name,n.setElementText(we.idInstrument,e.name)),jt(e.pageRanges)){var i=e.pageRanges;if(t.isArray(i))for(var a=0;a<i.length;a++)bt(i[a]);else bt(i)}jt(e.imgDir)&&(Ee.part.imgDir=e.imgDir),jt(e.imgPageNameToken)&&(Ee.part.imgPageNameToken=e.imgPageNameToken),jt(e.imgContPageName)&&(Ee.part.imgContPageName=e.imgContPageName),jt(e.contPageNo)&&(Ee.part.contPageNo=e.contPageNo),st()}function st(){var e=Ee.part,n=e.pageRanges;if(t.isArray(n)){for(var i=0;i<n.length;i++)ut(n[i]);ct(),lt()}}function ct(){var t=gt();Ee.pageNoToLoad++,ft(t)}function lt(){var t=mt();Ee.pageNoToLoad++,ft(t)}function ut(e){if(t.isObject(e)){var n=1,i=1;jt(e.start)&&(n=t.toInt(e.start)),jt(e.end)&&(i=t.toInt(e.end));var a=Ee.pageNoToLoad+(i-n+1);Ee.pageNoToLoad=a;for(var o=n;o<=i;o++)dt(o)}}function dt(t){var e=pt(t);ft(e)}function ft(t){if(!_t(t)){var e=t.imgFileUrl;_t(e)||t.loadImg(e,t.id)}}function pt(e){var n=St(e),i=Ee.part.pages[n];if(jt(i))return i;var a=Ee.part.imgPageNameToken;a=_t(a)?vt(e):t.replace(a,we.pageNoToken,""+e);var o=Ee.part.imgDir+a;i=new l(n,e,a,o);return Ee.part.pages[n]=i,i}function mt(){var t=Ee.part.contPageNo,e=St(t),n=Ee.part.pages[e];if(jt(n))return n;var i=Ee.part.imgContPageName,a=Ee.part.imgDir+i;n=new l(e,t,i,a);return Ee.part.pages[e]=n,n}function gt(){var t=Ee.part.blankPageNo,e=St(t),n=Ee.part.pages[e];if(jt(n))return n;var i=we.blankPageUrl,a=we.blankPageUrl;n=new l(e,t,i,a);return Ee.part.pages[e]=n,n}function vt(t){return Ee.score.noSpaceTitle+Zt+instrumentName+"_page"+t+".png"}function St(t){return we.pageIdPrefix+t}function bt(t){if(!(_t(t)||_t(t.start)||_t(t.end))){var e=t.start,n=t.end,i={start:e,end:n};Ee.part.pageRanges=[],Ee.part.pageRanges.push(i)}}function Tt(e){var n=[];t.isArray(e)?n=e:n.push(e),t.arrEquals(Ee.score.parts,n)||(Ee.score.parts=n),It(n)?yt(Ee.part.name):Pt(n)}function It(e){if(_t(Ee.part.name)||!t.isArray(e))return!1;for(var n=Ee.part.name,i=0;i<e.length;i++)if(n===e[i])return!0;return!1}function Pt(e){var n=t.getElement(we.idParts);if(!_t(n)){t.removeElementChildren(n);for(var i=0;i<e.length;i++){var a=e[i];if(!t.arrContains(we.filterOutParts,a)){var o=new u(i+1,a),r=t.createDiv(),s=t.createButton(o);t.setText(s,a),t.addChildToParent(r,s),t.addChildToParent(n,r)}}t.makeVisible(we.idPartsListOuterDiv)}}function yt(t){var n=new d;n[he]=t,e.sendEvent(Pe,n)}function xt(){var t=new d;t[he]=Ee.part.name,e.sendEvent(ye,t)}function ht(t){var n=new d;n[Ne]=t,e.sendEvent(xe,n)}function Nt(e){var n=null,i=[],a={};if(t.isArray(e))for(var o=0;o<e.length;o++){var r=e[o];jt(r.type)&&(n=r.type),jt(r.targets)&&(i=r.targets),jt(r.params)&&(a=r.params),Bt(n,i,a)}}function Bt(e,n,i){if(t.logDebug("doAction: "+e),!_t(e))switch(e){case"PING":Ft(i);break;case"START":Dt(n);break;case"STOP":Lt();break;case"SEMAPHORE_ON":kt(i);break;case"SEMAPHORE_OFF":Ct(i);break;default:Ht("doAction: Unknown actionType: "+e)}}function kt(t){_t(t)||Et(t.lightNo,t.colourId)}function Ct(t){_t(t)||At(t.lightNo,de)}function wt(){At(4,de),At(1,re)}function Et(t,e){var n=Rt(e);At(t,n)}function At(e,i){if(!_t(e)&&!_t(i))for(var a=t.toInt(e),o=1;o<=a;o++){var r=we.idSemaphorePrefix+o;n.setElementColour(r,i)}}function Rt(t){var e;switch(t||(t=1),t){case 4:e=re;break;case 3:e=se;break;case 2:e=ce;break;case 1:default:e=oe}return e}function Lt(){zt(),wt(),p()}function Dt(e){if(t.isArray(e))for(var n=0;n<e.length;n++)Ot(e[n]);else Ot(e)}function Ot(t){if(!_t(t)){var e=Ee[t];if(!_t(e)){var n=e.timeline;_t(n)||(Mt(n),Ee.isRunning=!0)}}}function Mt(t){if(_t(t))Ht("startTimeline: invalid timeline");else{var e=t.progress();e>0&&e<1?t.resume():t.play(0)}}function zt(){Ut(Ee.topStave.timeline),Ut(Ee.bottomStave.timeline)}function Ut(t){_t(t)?Ht("stopTimeline: invalid timeline"):t.pause()}function Ft(e){t.isObject(e)&&jt(e.sendTimeMs)&&ht(e.sendTimeMs)}function Vt(e,n){t.setElementStyleProperty(e,n)}function Yt(e,n){t.setElementAttributes(e,n)}function _t(e){return t.isNull(e)}function jt(e){return t.isNotNull(e)}function Ht(e){t.logError(e)}function Gt(e){t.log(e)}function Qt(e){t.logDebug(e)}const Wt="dev",Zt="_",qt="/",Jt="AV",Kt="FullScore",Xt="Connected",$t="Loading",te="READY",ee="Reconnecting",ne="Error",ie="<",ae=">",oe="green",re="red",se="orange",ce="yellow",le="white",ue="black",de="none",fe=oe,pe=re,me=se,ge=oe,ve=re,Se=se,be=le,Te=le,Ie=ue,Pe="PART_REG",ye="PART_READY",xe="PING",he="part",Ne="serverTime";var Be=["/audio/violin-tuning.mp3"],ke=null,Ce=null,we={connectionPreference:"ws,sse,poll",defaultConnectionType:e.WEBSOCKET,appUrlHttp:"/htp",appUrlSse:"/sse",appUrlWebsockets:"/wsoc",pageNoToken:"@PgNo@",pageIdPrefix:"p",tsBaseBeatDenom:8,tsY:0,beatIdPrefix:"b",tweenIdPrefix:"tw",beatTweenIdPrefix:"btw",ballTweenIdPrefix:"bltw",idTitle:"title",idServerStatusRect:"srvrStatusRect",idServerStatusTxt:"srvrStatusTxt",idServerStatusBtn:"srvrStatBtn",idParts:"parts",idPartsListOuterDiv:"partListOuterDiv",idInstrument:"part",idTempoBpm:"tmpBpm",idSemaphorePrefix:"semC",blankPageUrl:"img/blankStave.png",filterOutParts:[Jt,Kt],connectedRectStyle:{fill:fe,stroke:ge,"stroke-width":"0px",visibility:"visible",opacity:1},disconnectedRectStyle:{fill:pe,stroke:ve,"stroke-width":"1px",visibility:"visible",opacity:1},errorRectStyle:{fill:me,stroke:Se,"stroke-width":"1px",visibility:"visible",opacity:1},connectedTxtStyle:{fill:be},disconnectedTxtStyle:{fill:Te},errorTxtStyle:{fill:Ie},connectedBtnAttrib:{filter:""},disconnectedBtnAttrib:{filter:"url(#dropshadow)"},errorBtnAttrib:{filter:"url(#dropshadow)"},topStave:{gId:"stvTop",imgId:"stvTopImg",startLineId:"stvTopStartLine",positionLineId:"stvTopPosLine",beatBallId:"stvTopBeatBall",maskId:"stvTopMask",ballYmax:84,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"80",x2:"95",y2:"281"},posBallConf:{cx:"95",cy:"110",r:"4"}},bottomStave:{gId:"stvBot",imgId:"stvBotImg",startLineId:"stvBotStartLine",positionLineId:"stvBotPosLine",beatBallId:"stvBotBeatBall",maskId:"stvBotMask",ballYmax:84,xLeftMargin:31.5,posLineConf:{x1:"95",y1:"301",x2:"95",y2:"502"},posBallConf:{cx:"95",cy:"331",r:"4"}}},Ee={isRunning:!1,isReady:!1,score:{title:"ZScore",noSpaceTitle:"ZScore",instrument:"Part View",parts:["Part View"],firstPageNo:1,lastPageNo:2},part:{name:"Part View",imgDir:null,imgPageNameToken:null,imgContPageName:null,blankPageNo:0,contPageNo:6666,pageRanges:[{start:1,end:1}],pages:{},pageBeatMaps:{}},topStave:{id:"topStave",config:we.topStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!0,isRunning:!1},bottomStave:{id:"bottomStave",config:we.bottomStave,pageId:"0",filename:"img/blankStave.png",beatMap:null,timeline:null,isActive:!1,isRunning:!1},startTimeTl:0,currentBeatId:"b0",currentBeatNo:0,tempo:0,tempoModifier:1,scoreDir:"/score/",currentTickTimeSec:0,nextBeatTickTimeSec:0,audioTlBeatTime:0,audioTickBeatTime:0,isConnected:!1,isInitialised:!1,connectionType:null,pageNoToLoad:0};return l.prototype.loadImg=function(t){this.img.src=t,this.img.onload=function(){Gt("pageImgOnLoad: id: "+this.pageId),it(this.pageId)}},{onStateBtn:function(){g()},onPartSelect:function(t){v(t)},onInstrumentSelect:function(t){S(t)}}}(zsUtil,zsNet,zsSvg,zsAudio,zsMusic,window,document);